<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>醫療站庫存管理系統 v1.4.2-plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind 自定義色系配置
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal-custom': {
                            500: '#205555',
                            600: '#194444',
                            700: '#123333',
                            50: '#e6f2f2',
                        },
                        'teal-variant': {
                            900: '#224D60',
                            800: '#205555',
                            700: '#2C7471',
                            600: '#286768',
                            500: '#83D4D2',
                            100: '#D5EEEE',
                        },
                        'treatment': {
                            500: '#4E5488',
                            50: '#F3F2F8',
                        },
                        'blood': {
                            600: '#B85D42',
                            500: '#CC7251',
                            200: '#F6CCCD',
                            50: '#FDF5F5',
                        },
                        'claude-red': {
                            500: '#D96754',
                            600: '#C4564A',
                        },
                        'equipment': {
                            900: '#2D3531',  // 深色灰綠
                            500: '#6C7362',  // 主色橄欖綠
                            200: '#D7C8B0',  // 淺米色
                            100: '#E8E3DB',  // 極淺米色
                        },
                        'sky-custom': {
                            600: '#245FA7',
                            500: '#5B9BD5',
                        },
                        'dispense-purple': {
                            900: '#371e7e',
                            700: '#7e2e83',
                            500: '#9cacb5',
                            50: '#f5f3f9',
                        },
                        'pharma': {
                            900: '#115e59',
                            700: '#0f766e',
                            600: '#0d9488',
                            500: '#14b8a6',
                            200: '#99f6e4',
                            100: '#ccfbf1',
                            50: '#f0fdfa',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* 淺 teal 背景漸變 */
        body {
            background: linear-gradient(135deg, #f0f9f8 0%, #e6f7f5 25%, #f5f8ff 50%, #faf5ff 75%, #fff 100%);
            background-attachment: fixed;
        }

        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* 表格斑馬紋優化 */
        .table-hover tbody tr:hover {
            background-color: #f0f9ff;
            transition: background-color 0.2s;
        }

        /* 響應式統計卡片優化 */
        @media (max-width: 640px) {
            .stat-card {
                height: 6rem;
                padding: 0.75rem;
            }
            .stat-card .text-2xl {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="medicalInventory()" x-init="init()" x-cloak class="w-full max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6">

        <!-- Header -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between flex-wrap gap-3 sm:gap-4">
                <div class="flex items-center gap-2 sm:gap-3 md:gap-4">
                    <!-- 古陵Logo -->
                    <img src="/static/guling_logo.png" alt="De Novo Orthopedics Logo" class="h-10 sm:h-12 md:h-16 w-auto object-contain flex-shrink-0">

                    <div class="border-l border-gray-300 pl-2 sm:pl-3 md:pl-4">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-1 sm:gap-2">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            <span x-text="stationName || '醫療站庫存系統'"></span>
                        </h1>
                        <p class="text-xs sm:text-sm text-gray-500">
                            <span x-text="stationId"></span> - v1.4.2-plus
                        </p>
                        <div class="hidden sm:flex items-center gap-2 mt-1 text-xs text-gray-400">
                            <span class="font-medium">Designed in Taiwan</span>
                            <span>•</span>
                            <span>De Novo Orthopedics Inc</span>
                        </div>
                    </div>
                </div>
                <div class="text-right space-y-2">
                    <!-- Station Selector -->
                    <div class="flex items-center justify-end gap-2">
                        <label class="text-xs text-gray-600">站點:</label>
                        <div class="flex gap-1">
                            <select :value="showCustomStationInput ? '__CUSTOM__' : stationId"
                                    @change="handleStationSelectChange($event.target.value)"
                                    class="text-xs sm:text-sm px-2 py-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent bg-white font-semibold text-teal-600">
                                <option value="HC-000000">HC-000000 - 醫療站</option>
                                <option value="BORP-01">BORP-01 - 備援手術站</option>
                                <option value="LOG-HUB">LOG-HUB - 物資中心</option>
                                <option value="__CUSTOM__">其他站點...</option>
                            </select>
                            <div x-show="showCustomStationInput" class="flex gap-1" style="display: none;">
                                <select x-model="customStationType"
                                        class="text-xs sm:text-sm px-2 py-1 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-500 bg-white font-semibold text-teal-700">
                                    <option value="TC">TC-醫療站</option>
                                    <option value="BORP">BORP-手術站</option>
                                    <option value="LOG">LOG-物資站</option>
                                </select>
                                <input type="text"
                                       x-model="customStationNumber"
                                       @keyup.enter="applyCustomStation()"
                                       placeholder="編號"
                                       maxlength="3"
                                       class="text-xs sm:text-sm px-2 py-1 border border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-500 w-16 font-mono text-center">
                                <button @click="applyCustomStation()"
                                        class="px-2 py-1 bg-teal-600 text-white rounded-lg hover:bg-teal-700 text-xs">
                                    ✓
                                </button>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400">
                        <span x-text="currentTime"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 統計卡片 -->
        <!-- 精簡統計卡片 - 灰階配色 -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 mb-4">
            <!-- 總物品數 -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">總物品數</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.totalItems"></p>
                    </div>
                </div>
            </div>

            <!-- 庫存警戒 -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1">
                            <p class="text-xs text-gray-500 truncate">庫存警戒</p>
                            <div class="group relative cursor-help">
                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="invisible group-hover:visible absolute bottom-full left-0 mb-1 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap z-50">
                                    僅統計有進貨記錄的品項
                                </div>
                            </div>
                        </div>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.lowStockItems"></p>
                    </div>
                </div>
            </div>

            <!-- 血袋庫存 -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">血袋庫存</p>
                        <p class="text-lg font-bold text-gray-700"><span x-text="stats.totalBlood"></span> U</p>
                    </div>
                </div>
            </div>

            <!-- 待確認設備 -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">待確認設備</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.equipmentAlerts"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分頁選單 - 深色底白字 -->
        <div class="bg-white rounded-xl shadow mb-4 sm:mb-6">
            <div class="grid grid-cols-2 sm:flex sm:flex-nowrap gap-1.5 sm:gap-2 p-1.5 sm:p-2">
                <!-- 物品查詢 - Teal色系 -->
                <button @click="switchTab('items')"
                        :class="currentTab === 'items' ? 'bg-teal-custom-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">物品查詢</span>
                </button>

                <!-- 進貨登記 - 天藍色系 -->
                <button @click="switchTab('receive')"
                        :class="currentTab === 'receive' ? 'bg-sky-custom-600 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">進貨登記</span>
                </button>

                <!-- 處置 - 處置色系 #4E5488 -->
                <button @click="switchTab('treatment')"
                        :class="currentTab === 'treatment' ? 'bg-treatment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">處置</span>
                </button>

                <!-- 血袋管理 - 血庫色系 #D96754 -->
                <button @click="switchTab('blood')"
                        :class="currentTab === 'blood' ? 'bg-blood-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">血袋管理</span>
                </button>

                <!-- 設備管理 - 設備色系 #6C7362 -->
                <button @click="switchTab('equipment')"
                        :class="currentTab === 'equipment' ? 'bg-equipment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">設備管理</span>
                </button>

            </div>
        </div>

        <!-- 物品查詢分頁 -->
        <div x-show="currentTab === 'items'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    庫存查詢
                </h2>
                <div class="flex gap-2">
                    <button @click="showAddItemModal = true" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>新增物品</span>
                    </button>
                    <button @click="loadItems()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>重新載入</span>
                    </button>
                </div>
            </div>

            <!-- 分類篩選標籤 (v1.4.2-plus: 藥品/耗材分類) -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button @click="itemCategoryFilter = ''; filterItems()"
                        :class="itemCategoryFilter === '' ? 'bg-teal-custom-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">全部</button>
                <button @click="itemCategoryFilter = 'medicine'; filterItems()"
                        :class="itemCategoryFilter === 'medicine' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    藥品 (MED-)
                </button>
                <button @click="itemCategoryFilter = 'consumable'; filterItems()"
                        :class="itemCategoryFilter === 'consumable' ? 'bg-sky-custom-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    耗材
                </button>
            </div>

            <!-- 搜尋框和匯出按鈕 -->
            <div class="mb-4 flex gap-4 items-end flex-wrap sm:flex-nowrap">
                <div class="flex-1 w-full sm:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        搜尋物品
                    </label>
                    <input type="text" x-model="itemSearchText" @input="filterItems()" placeholder="輸入代碼或名稱搜尋..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                </div>
                <div class="flex gap-2">
                    <button @click.prevent.stop="exportInventoryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>CSV</span>
                    </button>
                    <button @click.prevent.stop="exportInventoryJSON()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>JSON</span>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代碼</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名稱</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分類</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">庫存</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最小庫存</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">單位</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="item in filteredItems" :key="item.code">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="item.code"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="item.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-teal-variant-100 text-teal-variant-700" x-text="item.category"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'" 
                                          x-text="item.current_stock"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.min_stock"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.unit"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button @click="editItem(item)" class="text-teal-custom-500 hover:text-teal-custom-600">編輯</button>
                                    <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800">刪除</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 進貨分頁 -->
        <div x-show="currentTab === 'receive'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-custom-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    進貨登記
                </h2>
                <button @click.prevent.stop="showReceiveHistoryModal = true; loadReceiveHistory()" class="bg-sky-custom-600 text-white px-4 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>查看進貨記錄</span>
                </button>
            </div>

            <form @submit.prevent="submitReceive()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品代碼 * (可搜尋)</label>
                        <input
                            type="text"
                            x-model="receiveItemSearch"
                            @input="filterReceiveItems()"
                            @focus="showReceiveDropdown = true; if (filteredReceiveItems.length === 0) filterReceiveItems();"
                            @blur="setTimeout(() => showReceiveDropdown = false, 200)"
                            placeholder="輸入代碼或名稱搜尋..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"
                        >
                        <div x-show="showReceiveDropdown && filteredReceiveItems.length > 0" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <template x-for="item in filteredReceiveItems.slice(0, 10)" :key="item.code">
                                <div @click.stop="selectReceiveItem(item)" class="px-4 py-2 hover:bg-sky-100 cursor-pointer">
                                    <span class="font-mono text-sm" x-text="item.code"></span> -
                                    <span x-text="item.name"></span>
                                    <span class="text-xs text-gray-500" x-text="`(庫存: ${item.current_stock})`"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">數量 *</label>
                        <input type="number" x-model="receiveForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">批號</label>
                        <input type="text" x-model="receiveForm.batchNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">效期</label>
                        <input type="date" x-model="receiveForm.expiryDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                        <textarea x-model="receiveForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-sky-custom-600 text-white px-6 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>確認進貨</span>
                    </button>
                    <button type="button" @click="resetReceiveForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>重置</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- 處置分頁 (整合手術記錄 + 一般消耗) -->
        <div x-show="currentTab === 'treatment'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <!-- 標題與模式切換 -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    處置管理
                </h2>

                <!-- 左側切換按鈕 -->
                <div class="flex gap-2 flex-wrap">
                    <button @click="treatmentMode = 'surgery'"
                            :class="treatmentMode === 'surgery' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span>處置記錄</span>
                    </button>
                    <button @click="treatmentMode = 'consume'"
                            :class="treatmentMode === 'consume' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <span>一般消耗</span>
                    </button>
                    <button @click="treatmentMode = 'dispense'; loadPendingDispenses()"
                            :class="treatmentMode === 'dispense' ? 'bg-dispense-purple-700 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <span>藥品領用</span>
                    </button>
                </div>
            </div>

            <!-- 處置記錄模式 (手術記錄) -->
            <div x-show="treatmentMode === 'surgery'">
                <div class="flex flex-wrap gap-2 mb-4">
                    <button @click.prevent.stop="ensureItemsLoaded(); showAddSurgeryModal = true" class="bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>新增處置記錄</span>
                    </button>
                    <button @click.prevent.stop="exportSurgeryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>匯出 CSV</span>
                    </button>
                    <button @click.prevent.stop="loadSurgeryRecords()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>重新載入</span>
                    </button>
                </div>

                <!-- 搜尋篩選 -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期</label>
                        <input type="date" x-model="surgerySearchForm.startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期</label>
                        <input type="date" x-model="surgerySearchForm.endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">病患姓名</label>
                        <input type="text" x-model="surgerySearchForm.patientName" placeholder="搜尋病患..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table-hover">
                        <thead class="bg-treatment-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">記錄編號</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">病患姓名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">處置類型</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">主刀醫師</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時長(分)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in surgeryRecords" :key="record.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="record.record_number"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.record_date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.patient_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgery_type"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgeon_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.duration_minutes || '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewSurgeryDetail(record)" class="text-treatment-500 hover:text-[#3d4270] font-medium">詳情</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 一般消耗模式 -->
            <div x-show="treatmentMode === 'consume'">
                <div class="mb-4 flex justify-between items-center">
                    <button @click.prevent.stop="showConsumeHistoryModal = true; loadConsumeHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>查看消耗記錄</span>
                    </button>
                </div>

                <form @submit.prevent="submitBatchConsume()" class="space-y-4">
                    <!-- 消耗原因（整批共用） -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">消耗原因 *</label>
                        <textarea x-model="batchConsumeForm.purpose" required rows="2"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500 focus:border-transparent"></textarea>
                    </div>

                    <!-- 耗材清單 -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                消耗品項
                            </h4>
                            <button type="button" @click="ensureItemsLoaded(); addBatchConsumeItem()"
                                    class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                新增品項
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in batchConsumeForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- 搜尋輸入框（使用 relative div） -->
                                        <div class="relative col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterBatchConsumeItems(index)"
                                                @focus="filterBatchConsumeItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="搜尋物品..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && Array.isArray(item.filteredItems) && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="(availableItem, itemIdx) in (item.filteredItems || []).slice(0, 8)" :key="`${index}-${itemIdx}-${availableItem.code || ''}`">
                                                    <div @click.stop="selectBatchConsumeItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(庫存: ${availableItem.current_stock || 0})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- 數量輸入框 -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="數量"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                    </div>

                                    <!-- 刪除按鈕 -->
                                    <button type="button" @click="removeBatchConsumeItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="batchConsumeForm.items.length === 0" class="text-center text-gray-400 py-4">
                            尚未新增消耗品項
                        </div>
                    </div>

                    <!-- 提交按鈕 -->
                    <div class="flex gap-4">
                        <button type="submit" class="bg-treatment-500 text-white px-6 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認消耗</span>
                        </button>
                        <button type="button" @click="resetBatchConsumeForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>重置</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 藥品領用模式 (MIRS v2.3 - Emergency Dispense) -->
            <div x-show="treatmentMode === 'dispense'">
                <div class="flex justify-end mb-4">
                    <button @click.prevent.stop="loadPendingDispenses()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>重新載入</span>
                    </button>
                </div>

                <!-- 緊急領用警示 (如果有待確認的緊急領用) -->
                <div x-show="pendingDispenses.filter(d => d.status === 'EMERGENCY').length > 0" class="mb-4 p-4 bg-dispense-purple-50 border-l-4 border-dispense-purple-700 rounded">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-dispense-purple-700 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-dispense-purple-900">緊急領用待確認</p>
                        <p class="text-sm text-gray-600 mt-1">
                            有 <span class="font-bold text-dispense-purple-700" x-text="pendingDispenses.filter(d => d.status === 'EMERGENCY').length"></span> 筆緊急領用需要藥師確認
                        </p>
                    </div>
                </div>
                </div>
            </div>

                <!-- 藥品領用表單 (批次) -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    領用登記
                </h3>
                <form @submit.prevent="submitBatchDispense()" class="space-y-4">
                    <!-- 基本資訊（整批共用） -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 領藥人 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> 領藥人
                            </label>
                            <input type="text" x-model="batchDispenseForm.dispensedBy" required placeholder="護理師-王小美" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>

                        <!-- 病患編號 (選填) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                病患編號 (選填)
                            </label>
                            <input type="text" x-model="batchDispenseForm.patientRefId" placeholder="Triage Tag ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>

                        <!-- 病患姓名 (選填) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                病患姓名 (選填)
                            </label>
                            <input type="text" x-model="batchDispenseForm.patientName" placeholder="張三" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>
                    </div>

                    <!-- 藥品清單 -->
                    <div class="border-2 border-dispense-purple-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                藥品清單
                            </h4>
                            <button type="button" @click="addBatchDispenseItem()"
                                    class="bg-dispense-purple-700 text-white px-3 py-1 rounded-lg hover:bg-dispense-purple-900 text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                新增藥品
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in batchDispenseForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- 搜尋輸入框 -->
                                        <div class="relative col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterBatchDispenseItems(index)"
                                                @focus="item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="搜尋藥品..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-dispense-purple-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectBatchDispenseItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-dispense-purple-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(庫存: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- 數量輸入框 -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="數量"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                    </div>

                                    <!-- 刪除按鈕 -->
                                    <button type="button" @click="removeBatchDispenseItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="batchDispenseForm.items.length === 0" class="text-center text-gray-400 py-4">
                            尚未新增藥品
                        </div>
                    </div>

                    <!-- 按鈕組 -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-2">
                        <!-- 正常領用 (灰色) -->
                        <button type="button" @click="batchDispenseForm.isEmergency = false; submitBatchDispense()"
                                class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>送出審核 (正常流程)</span>
                        </button>

                        <!-- 緊急領用 (紫色) -->
                        <button type="button" @click="showEmergencyReasonModal = true"
                                class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>緊急領用 (Break-the-Glass)</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- 待處理領用清單 (藥師審核區) -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    待處理領用 (藥師審核)
                </h3>

                <div x-show="pendingDispenses.length === 0" class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>目前沒有待處理的領用記錄</p>
                </div>

                <div x-show="pendingDispenses.length > 0" class="space-y-3">
                    <template x-for="dispense in pendingDispenses" :key="dispense.id">
                        <div class="bg-white rounded-lg p-4 shadow-sm border" :class="dispense.status === 'EMERGENCY' ? 'border-dispense-purple-700 bg-dispense-purple-50' : 'border-gray-200'">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 rounded text-xs font-semibold"
                                              :class="dispense.status === 'EMERGENCY' ? 'bg-dispense-purple-700 text-white' : 'bg-yellow-500 text-white'"
                                              x-text="dispense.status === 'EMERGENCY' ? '緊急領用' : '待審核'"></span>
                                        <span class="text-xs text-gray-500" x-text="`${dispense.hours_pending || 0} 小時前`"></span>
                                    </div>
                                    <p class="font-semibold text-gray-800" x-text="`${dispense.medicine_code} - ${dispense.medicine_name}`"></p>
                                    <p class="text-sm text-gray-600">數量: <span class="font-semibold" x-text="dispense.quantity"></span> <span x-text="dispense.unit"></span></p>
                                    <p class="text-sm text-gray-600">領藥人: <span class="font-semibold" x-text="dispense.dispensed_by"></span></p>
                                    <p x-show="dispense.patient_name" class="text-sm text-gray-600">病患: <span x-text="dispense.patient_name"></span></p>
                                    <p x-show="dispense.emergency_reason" class="text-sm text-dispense-purple-900 mt-2 font-medium">
                                        緊急原因: <span x-text="dispense.emergency_reason"></span>
                                    </p>
                                </div>
                                <div class="flex items-center">
                                    <button @click="openPharmacistApproval(dispense)" class="bg-dispense-purple-700 text-white px-4 py-2 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        <span>藥師確認</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- 血袋分頁 -->
        <!-- CHANGED: x-show to style binding to force reactivity -->
        <div :style="currentTab === 'blood' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    血庫管理
                </h2>
                <button @click.prevent.stop="showBloodHistoryModal = true; loadBloodHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>歷史記錄</span>
                </button>
            </div>

            <!-- 血型庫存統計區 - 深紅色背景 -->
            <div class="bg-gradient-to-br from-red-900 to-red-950 rounded-xl p-6 mb-8 shadow-xl">
                <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    血型庫存統計
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3">
                    <template x-for="blood in bloodInventory" :key="blood.blood_type">
                        <div class="bg-red-800 bg-opacity-50 backdrop-blur rounded-lg p-4 border border-red-700 hover:border-red-500 transition-all duration-200 hover:shadow-lg">
                            <div class="text-center">
                                <!-- 血型標籤 -->
                                <div class="text-sm font-bold text-red-100 mb-2" x-text="blood.blood_type"></div>
                                <!-- 數量大字顯示 - 非0白色，0淺灰色 -->
                                <div class="text-4xl font-extrabold mb-1"
                                     :class="blood.quantity > 0 ? 'text-white' : 'text-gray-400'"
                                     x-text="blood.quantity"></div>
                                <div class="text-xs text-red-200">袋</div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- 功能區 - 淺色風格，統一 red 色系 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 血袋入庫 -->
                <div class="bg-white border-2 border-red-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        血袋入庫
                    </h3>
                    <form @submit.prevent="submitBloodReceive()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">血型 *</label>
                                <select x-model="bloodReceiveForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">選擇血型</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">數量 (U) *</label>
                                <input type="number" x-model="bloodReceiveForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- 來源選擇 -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">血液來源</label>
                            <select x-model="bloodReceiveForm.source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="blood_center">捐血中心</option>
                                <option value="walking_donor">Walking Blood Bank (緊急捐血者)</option>
                            </select>
                        </div>

                        <!-- Walking Blood Bank 資訊 (條件顯示) -->
                        <div x-show="bloodReceiveForm.source === 'walking_donor'" class="col-span-2 border-t border-red-200 pt-3 space-y-2">
                            <div class="text-sm font-medium text-red-700 flex items-center gap-1 mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                緊急捐血者資訊
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">捐血者姓名</label>
                                    <input type="text" x-model="bloodReceiveForm.donorName"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="選填">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">聯絡電話</label>
                                    <input type="tel" x-model="bloodReceiveForm.donorPhone"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="選填">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                            <input type="text" x-model="bloodReceiveForm.remarks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="批號、來源等">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="submit" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>確認入庫</span>
                            </button>
                            <button type="button" @click="printBloodLabel()" class="bg-white text-claude-red-500 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors flex items-center justify-center gap-2 border-2 border-claude-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                </svg>
                                <span>列印標籤</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 血袋出庫 (含病患資訊) -->
                <div class="border-2 border-red-200 rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        血袋出庫
                    </h3>
                    <form @submit.prevent="submitBloodConsume()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">血型 *</label>
                                <select x-model="bloodConsumeForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">選擇血型</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">數量 (U) *</label>
                                <input type="number" x-model="bloodConsumeForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>
                        <!-- 病患資訊 -->
                        <div class="border-t border-red-200 pt-3 space-y-3">
                            <div class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                病患資訊
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">病患姓名 *</label>
                                <input type="text" x-model="bloodConsumeForm.patientName" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="請輸入病患姓名">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">病歷號</label>
                                <input type="text" x-model="bloodConsumeForm.patientId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="選填">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">用途說明</label>
                                <textarea x-model="bloodConsumeForm.purpose" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="手術、緊急輸血等"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認出庫</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- v1.4.2-plus: 個別血袋追蹤系統 -->
            <div class="mt-8 border-t border-red-200 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-red-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        個別血袋追蹤
                    </h3>
                    <div class="flex gap-2">
                        <button @click="loadBloodBags()" class="bg-gray-500 text-white px-3 py-1.5 rounded-lg hover:bg-gray-600 text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            重新整理
                        </button>
                        <button @click="checkExpiringBags()" class="bg-amber-500 text-white px-3 py-1.5 rounded-lg hover:bg-amber-600 text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            即期血袋
                        </button>
                    </div>
                </div>

                <!-- 新增血袋表單 -->
                <div class="bg-red-50 rounded-xl p-4 mb-4">
                    <h4 class="text-md font-semibold text-red-700 mb-3">建立個別血袋</h4>
                    <form @submit.prevent="createBloodBag()" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">血型 *</label>
                            <select x-model="bloodBagForm.blood_type" required class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="">選擇</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">容量 (ml)</label>
                            <input type="number" x-model="bloodBagForm.volume_ml" min="100" max="500"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                   placeholder="250">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">採集日期</label>
                            <input type="date" x-model="bloodBagForm.collection_date"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">效期</label>
                            <input type="date" x-model="bloodBagForm.expiry_date"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="col-span-2 md:col-span-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">捐贈者/來源</label>
                            <input type="text" x-model="bloodBagForm.donor_info" placeholder="選填"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-claude-red-500 text-white px-3 py-1.5 rounded-lg hover:bg-claude-red-600 text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                建立血袋
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 血袋列表 -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-red-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                    <input type="checkbox" @change="toggleAllBags($event.target.checked)" class="rounded">
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">血袋編號</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">血型</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase">容量</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">效期</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">狀態</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="bag in bloodBags" :key="bag.bag_code">
                                <tr :class="{'bg-red-50': isExpiringSoon(bag.expiry_date)}">
                                    <td class="px-3 py-2">
                                        <input type="checkbox" :value="bag.bag_code" x-model="selectedBagCodes" class="rounded">
                                    </td>
                                    <td class="px-3 py-2 font-mono text-xs" x-text="bag.bag_code"></td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs font-bold rounded bg-red-600 text-white" x-text="bag.blood_type"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center" x-text="bag.volume_ml + ' ml'"></td>
                                    <td class="px-3 py-2 text-xs" :class="isExpiringSoon(bag.expiry_date) ? 'text-red-600 font-bold' : 'text-gray-600'" x-text="bag.expiry_date || '-'"></td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-700': bag.status === 'AVAILABLE',
                                                  'bg-gray-100 text-gray-700': bag.status === 'USED',
                                                  'bg-red-100 text-red-700': bag.status === 'EXPIRED',
                                                  'bg-yellow-100 text-yellow-700': bag.status === 'RESERVED'
                                              }"
                                              x-text="bag.status === 'AVAILABLE' ? '可用' : bag.status === 'USED' ? '已使用' : bag.status === 'EXPIRED' ? '已過期' : '已預留'"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <button @click="printSingleBagLabel(bag.bag_code)" class="text-red-600 hover:text-red-800 text-xs mr-2" title="列印標籤">
                                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                            </svg>
                                        </button>
                                        <button x-show="bag.status === 'AVAILABLE'" @click="useBloodBag(bag.bag_code)" class="text-blue-600 hover:text-blue-800 text-xs" title="使用">
                                            使用
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="bloodBags.length === 0">
                                <td colspan="7" class="px-3 py-4 text-center text-gray-500 text-sm">尚無個別血袋資料</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 批次操作 -->
                <div x-show="selectedBagCodes.length > 0" class="mt-4 bg-red-100 rounded-lg p-3 flex items-center justify-between">
                    <span class="text-sm text-red-700">已選擇 <span x-text="selectedBagCodes.length" class="font-bold"></span> 袋血袋</span>
                    <button @click="printSelectedBagLabels()" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        批次列印標籤
                    </button>
                </div>
            </div>
        </div>
        <!-- CHANGED: x-show to style binding for equipment tab -->
        <div :style="currentTab === 'equipment' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    設備管理
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button @click="showAddEquipmentModal = true" class="bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>新增設備</span>
                    </button>
                    <button @click="loadEquipment()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>重新載入</span>
                    </button>
                </div>
            </div>

            <!-- 自動刷新提示 -->
            <div class="mb-4 p-3 bg-equipment-500 bg-opacity-10 rounded-lg flex items-center gap-2 text-sm text-gray-700">
                <svg class="w-5 h-5 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>設備狀態將於每日 <strong class="text-equipment-500">07:00am</strong> 自動重置為待檢查</span>
            </div>

            <!-- 電氣設備區域 -->
            <div class="bg-gradient-to-br from-equipment-100 to-white border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        電氣設備
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-equipment-200 table-hover">
                        <thead class="bg-equipment-200 bg-opacity-30">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">設備ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">名稱</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">狀態</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">分類</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">數量</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">電力</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">最後檢查</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="eq in equipment.filter(e => !e.id.includes('-SURG-') && !e.id.startsWith('SURG-'))" :key="eq.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="eq.id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900" x-text="eq.name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="{
                                            'bg-green-100 text-green-800': eq.status === 'NORMAL',
                                            'bg-yellow-100 text-yellow-800': eq.status === 'WARNING',
                                            'bg-red-100 text-red-800': eq.status === 'ERROR',
                                            'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED'
                                        }" class="px-2 py-1 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700" x-text="eq.category"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="eq.quantity"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <span x-show="eq.power_level !== null" x-text="eq.power_level + '%'"></span>
                                        <span x-show="eq.power_level === null" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                        <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] font-medium">檢查</button>
                                        <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 font-medium">編輯</button>
                                        <button @click="deleteEquipment(eq.id, eq.name)" class="text-red-600 hover:text-red-800 font-medium">刪除</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="equipment.filter(e => !e.id.startsWith('SURG-')).length === 0">
                                <td colspan="8" class="px-6 py-8 text-center text-gray-400">目前沒有電氣設備</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 手術包區域 -->
            <div class="bg-gradient-to-br from-equipment-200 to-white border-2 border-equipment-500 rounded-xl p-5 shadow-sm">
                <div class="bg-equipment-500 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        手術包
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-equipment-500 table-hover">
                        <thead class="bg-equipment-500 bg-opacity-20">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">設備ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">名稱</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">狀態</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">數量</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">最後檢查</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-equipment-900 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="eq in equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-'))" :key="eq.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="eq.id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900" x-text="eq.name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="{
                                            'bg-green-100 text-green-800': eq.status === 'NORMAL',
                                            'bg-yellow-100 text-yellow-800': eq.status === 'WARNING',
                                            'bg-red-100 text-red-800': eq.status === 'ERROR',
                                            'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED'
                                        }" class="px-2 py-1 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="eq.quantity"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                        <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] font-medium">檢查</button>
                                        <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 font-medium">編輯</button>
                                        <button @click="deleteEquipment(eq.id, eq.name)" class="text-red-600 hover:text-red-800 font-medium">刪除</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-')).length === 0">
                                <td colspan="6" class="px-6 py-8 text-center text-gray-400">目前沒有手術包</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 新增物品 Modal -->
        <div x-show="showAddItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showAddItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    新增物品
                </h3>
                <form @submit.prevent="submitAddItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品代碼 (留空自動生成)</label>
                        <input type="text" x-model="addItemForm.code" placeholder="留空將自動生成" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品名稱 *</label>
                        <input type="text" x-model="addItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分類 *</label>
                        <select x-model="addItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="手術耗材">手術耗材</option>
                            <option value="急救物資">急救物資</option>
                            <option value="藥品">藥品</option>
                            <option value="防護用品">防護用品</option>
                            <option value="醫療設備">醫療設備</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">單位</label>
                        <input type="text" x-model="addItemForm.unit" placeholder="EA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最小庫存</label>
                        <input type="number" x-model="addItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認新增</span>
                        </button>
                        <button type="button" @click="showAddItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 編輯物品 Modal -->
        <div x-show="showEditItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEditItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    編輯物品
                </h3>
                <form @submit.prevent="submitEditItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品代碼</label>
                        <input type="text" x-model="editItemForm.code" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品名稱 *</label>
                        <input type="text" x-model="editItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分類 *</label>
                        <select x-model="editItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="手術耗材">手術耗材</option>
                            <option value="急救物資">急救物資</option>
                            <option value="藥品">藥品</option>
                            <option value="防護用品">防護用品</option>
                            <option value="醫療設備">醫療設備</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">單位</label>
                        <input type="text" x-model="editItemForm.unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最小庫存</label>
                        <input type="number" x-model="editItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認更新</span>
                        </button>
                        <button type="button" @click="showEditItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 新增設備 Modal -->
        <div x-show="showAddEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showAddEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    新增設備
                </h3>
                <form @submit.prevent="submitAddEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">設備名稱 *</label>
                        <input type="text" x-model="addEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分類 *</label>
                        <select x-model="addEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="手術包">手術包</option>
                            <option value="電力設備">電力設備</option>
                            <option value="空氣淨化">空氣淨化</option>
                            <option value="水處理">水處理</option>
                            <option value="冷藏設備">冷藏設備</option>
                            <option value="通訊設備">通訊設備</option>
                            <option value="照明設備">照明設備</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">數量</label>
                        <input type="number" x-model="addEquipmentForm.quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                        <textarea x-model="addEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認新增</span>
                        </button>
                        <button type="button" @click="showAddEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 編輯設備 Modal -->
        <div x-show="showEditEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEditEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    編輯設備
                </h3>
                <form @submit.prevent="submitEditEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">設備ID</label>
                        <input type="text" x-model="editEquipmentForm.id" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">設備名稱 *</label>
                        <input type="text" x-model="editEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分類 *</label>
                        <select x-model="editEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="手術包">手術包</option>
                            <option value="電力設備">電力設備</option>
                            <option value="空氣淨化">空氣淨化</option>
                            <option value="水處理">水處理</option>
                            <option value="冷藏設備">冷藏設備</option>
                            <option value="通訊設備">通訊設備</option>
                            <option value="照明設備">照明設備</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">數量</label>
                        <input type="number" x-model="editEquipmentForm.quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                        <textarea x-model="editEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認更新</span>
                        </button>
                        <button type="button" @click="showEditEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 設備檢查 Modal -->
        <div x-show="showCheckEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showCheckEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    設備檢查
                </h3>
                <form @submit.prevent="submitCheckEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">設備名稱</label>
                        <input type="text" x-model="checkEquipmentForm.name" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">狀態 *</label>
                        <select x-model="checkEquipmentForm.status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="NORMAL">正常 (NORMAL)</option>
                            <option value="WARNING">警告 (WARNING)</option>
                            <option value="ERROR">異常 (ERROR)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電力等級 (0-100%)</label>
                        <input type="number" x-model="checkEquipmentForm.powerLevel" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                        <textarea x-model="checkEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認檢查</span>
                        </button>
                        <button type="button" @click="showCheckEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 新增處置記錄 Modal -->
        <div x-show="showAddSurgeryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showAddSurgeryModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-2xl w-full mx-4 my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    新增處置記錄
                </h3>
                <form @submit.prevent="submitAddSurgery()" class="space-y-4">
                    <!-- 基本資訊 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">病患姓名 *</label>
                            <input type="text" x-model="addSurgeryForm.patientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">檢傷編號 (Triage Tag ID)</label>
                            <input type="text" x-model="addSurgeryForm.triageTagId" placeholder="例如: RED-001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">處置類型 *</label>
                            <input type="text" x-model="addSurgeryForm.surgeryType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">主刀醫師 *</label>
                            <input type="text" x-model="addSurgeryForm.surgeonName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">麻醉方式</label>
                            <input type="text" x-model="addSurgeryForm.anesthesiaType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">處置時長 (分鐘)</label>
                            <input type="number" x-model="addSurgeryForm.durationMinutes" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                    </div>

                    <!-- 備註 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            處置備註
                            <span class="text-xs text-gray-500 font-normal">(可記錄檢傷編號、傷勢狀況等資訊)</span>
                        </label>
                        <textarea x-model="addSurgeryForm.remarks" rows="3" placeholder="例如: 檢傷編號 RED-001, 右腿開放性骨折..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"></textarea>
                    </div>

                    <!-- 耗材清單 -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                使用耗材
                            </h4>
                            <button type="button" @click="addConsumptionItem()" class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                新增耗材
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in addSurgeryForm.consumptions" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <div class="relative">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterConsumptionItems(index)"
                                                @focus="filterConsumptionItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="搜尋耗材..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectConsumptionItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(庫存: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="數量" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                        <input type="text" x-model="item.unit" readonly placeholder="單位" class="px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                    </div>
                                    <button type="button" @click="removeConsumptionItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.consumptions.length === 0" class="text-center text-gray-400 py-4">
                            尚未新增耗材
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            確認建立
                        </button>
                        <button type="button" @click="showAddSurgeryModal = false; resetAddSurgeryForm()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 處置詳情 Modal -->
        <div x-show="showSurgeryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showSurgeryDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    處置記錄詳情
                </h3>
                
                <template x-if="selectedSurgery">
                    <div class="space-y-4">
                        <!-- 基本資訊 -->
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">記錄編號</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_number"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">日期</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_date"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">病患姓名</p>
                                <p class="font-semibold" x-text="selectedSurgery.patient_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">當日第 N 台</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_sequence"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">處置類型</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_type"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">主刀醫師</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgeon_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">麻醉方式</p>
                                <p class="font-semibold" x-text="selectedSurgery.anesthesia_type || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">處置時長</p>
                                <p class="font-semibold" x-text="selectedSurgery.duration_minutes ? selectedSurgery.duration_minutes + ' 分鐘' : '-'"></p>
                            </div>
                        </div>

                        <!-- 備註 -->
                        <div x-show="selectedSurgery.remarks" class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">備註</p>
                            <p class="text-gray-800" x-text="selectedSurgery.remarks"></p>
                        </div>

                        <!-- 耗材清單 -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                使用耗材
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">代碼</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">名稱</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">數量</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">單位</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="consumption in selectedSurgery.consumptions" :key="consumption.item_code">
                                            <tr>
                                                <td class="px-4 py-2 text-sm font-mono" x-text="consumption.item_code"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.item_name"></td>
                                                <td class="px-4 py-2 text-sm font-semibold" x-text="consumption.quantity"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.unit"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="button" @click="showSurgeryDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                關閉
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- 進貨記錄 Modal -->
        <div x-show="showReceiveHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showReceiveHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        進貨記錄
                    </h3>
                    <button @click="exportReceiveHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        匯出CSV
                    </button>
                </div>

                <!-- 篩選條件 -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期</label>
                        <input type="date" x-model="receiveHistorySearch.startDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期</label>
                        <input type="date" x-model="receiveHistorySearch.endDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品代碼</label>
                        <input type="text" x-model="receiveHistorySearch.itemCode" @input="loadReceiveHistory()" placeholder="搜尋物品..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">時間</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">物品代碼</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">物品名稱</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">數量</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">批號</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">效期</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">備註</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in receiveHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-green-600" x-text="'+' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.batch_number || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.expiry_date || '-'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showReceiveHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- 消耗記錄 Modal -->
        <div x-show="showConsumeHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showConsumeHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        消耗記錄
                    </h3>
                    <button @click="exportConsumeHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        匯出CSV
                    </button>
                </div>

                <!-- 篩選條件 -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期</label>
                        <input type="date" x-model="consumeHistorySearch.startDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期</label>
                        <input type="date" x-model="consumeHistorySearch.endDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">物品代碼</label>
                        <input type="text" x-model="consumeHistorySearch.itemCode" @input="loadConsumeHistory()" placeholder="搜尋物品..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">時間</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">物品代碼</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">物品名稱</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">數量</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">用途</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in consumeHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-red-600" x-text="'-' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewConsumeDetail(event)" class="text-blue-600 hover:text-blue-800">詳情</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showConsumeHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- 消耗詳情 Modal -->
        <div x-show="showConsumeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showConsumeDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    消耗詳情
                </h3>

                <template x-if="selectedConsumeEvent">
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">時間</p>
                                <p class="font-semibold" x-text="new Date(selectedConsumeEvent.timestamp).toLocaleString('zh-TW')"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">物品代碼</p>
                                <p class="font-semibold font-mono" x-text="selectedConsumeEvent.item_code"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">物品名稱</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.item_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">消耗數量</p>
                                <p class="font-semibold text-red-600" x-text="selectedConsumeEvent.quantity + ' ' + selectedConsumeEvent.unit"></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-600">用途說明</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.remarks || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">操作員</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.operator"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">站點</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.station_id"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="pt-4">
                    <button type="button" @click="showConsumeDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- 血庫歷史記錄 Modal -->
        <div x-show="showBloodHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showBloodHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    血庫歷史記錄
                </h3>

                <!-- 篩選條件 -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">開始日期</label>
                        <input type="date" x-model="bloodHistorySearch.startDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">結束日期</label>
                        <input type="date" x-model="bloodHistorySearch.endDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">血型</label>
                        <select x-model="bloodHistorySearch.bloodType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">全部血型</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">類型</label>
                        <select x-model="bloodHistorySearch.eventType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">全部</option>
                            <option value="RECEIVE">入庫</option>
                            <option value="CONSUME">出庫</option>
                        </select>
                    </div>
                </div>

                <!-- 歷史記錄表格 -->
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">時間</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">類型</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">血型</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">數量</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">來源/用途</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作員</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in bloodHistory" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(record.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="record.event_type === 'RECEIVE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                              class="px-2 py-1 rounded-full text-xs font-medium"
                                              x-text="record.event_type === 'RECEIVE' ? '入庫' : '出庫'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm font-semibold" x-text="record.blood_type"></td>
                                    <td class="px-4 py-2 text-sm font-bold" x-text="record.quantity + ' U'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="record.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="record.operator"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <div class="flex gap-2 items-center">
                                            <button @click="printBloodLabelFromHistory(record)"
                                                    class="text-claude-red-500 hover:text-claude-red-600 font-medium flex items-center gap-1"
                                                    title="列印標籤">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                                </svg>
                                                <span>列印</span>
                                            </button>
                                            <button @click="viewBloodDetail(record)" class="text-blood-500 hover:text-blood-600 font-medium">詳情</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="!bloodHistory || bloodHistory.length === 0" class="text-center py-8 text-gray-400">
                        無符合條件的記錄
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button @click="exportBloodHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        匯出 CSV
                    </button>
                    <button type="button" @click="showBloodHistoryModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast 通知 -->
        <div x-show="showToast" x-transition class="fixed bottom-4 right-4 z-50" style="display: none;">
            <div :class="{
                'bg-teal-custom-500': toastType === 'success',
                'bg-red-500': toastType === 'error',
                'bg-blue-500': toastType === 'info'
            }" class="text-white px-6 py-3 rounded-lg shadow-lg">
                <p x-text="toastMessage"></p>
            </div>
        </div>

        <!-- 緊急功能按鈕 -->
        <div class="fixed bottom-24 right-4 z-40">
            <button @click="showEmergencyModal = true"
                    class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-2xl transition-all duration-300 transform hover:scale-110">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </button>
        </div>

        <!-- 緊急功能選單 Modal -->
        <div x-show="showEmergencyModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEmergencyModal = false" class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-red-600 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        緊急功能
                    </h3>
                    <button @click="showEmergencyModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <p class="text-sm text-gray-600 mb-6">
                    戰時緊急撤離使用 - 快速保全所有資料
                </p>

                <div class="space-y-3">
                    <!-- 選項1: 撤離 - 下載所有資料 -->
                    <button @click="emergencyDownloadAll()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">撤離 - 下載所有資料</p>
                            <p class="text-xs text-red-100">完整備份包（ZIP檔案）</p>
                        </div>
                    </button>

                    <!-- 選項2: 快速備份資料庫 -->
                    <button @click="emergencyQuickBackup()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">快速備份資料庫</p>
                            <p class="text-xs text-orange-100">僅下載 .db 檔案（最快）</p>
                        </div>
                    </button>

                    <!-- 選項3: 取消 -->
                    <button @click="showEmergencyModal = false"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 p-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="font-medium">取消</span>
                    </button>
                </div>

                <div class="mt-6 p-3 bg-red-50 rounded-lg border border-red-200">
                    <p class="text-xs text-red-700 flex items-start gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span><strong>提示：</strong>建議使用「撤離」功能下載完整備份包，包含所有資料和說明文件。</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 緊急領用原因 Modal (MIRS v2.3) -->
        <div x-show="showEmergencyReasonModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEmergencyReasonModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        緊急領用 (Break-the-Glass)
                    </h3>
                    <button @click="showEmergencyReasonModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">重要提醒</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>緊急領用會立即扣除庫存</li>
                                <li>不需要藥師 PIN 碼</li>
                                <li>必須填寫緊急原因 (至少5個字)</li>
                                <li>藥師稍後會確認此筆領用</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="batchDispenseForm.isEmergency = true; submitBatchDispense()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> 緊急原因 (5-200字)
                        </label>
                        <textarea x-model="batchDispenseForm.emergencyReason"
                                  required
                                  minlength="5"
                                  maxlength="200"
                                  rows="4"
                                  placeholder="例如：大量傷患湧入，需要緊急物資，藥師不在現場..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                        <p class="text-xs text-gray-500 mt-1" x-text="`已輸入 ${batchDispenseForm.emergencyReason.length} 字 (最少5字，最多200字)`"></p>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認緊急領用</span>
                        </button>
                        <button type="button" @click="showEmergencyReasonModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 藥師審核 Modal (MIRS v2.3) -->
        <div x-show="showPharmacistApprovalModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showPharmacistApprovalModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        藥師審核確認
                    </h3>
                    <button @click="showPharmacistApprovalModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- 領用記錄詳情 -->
                <template x-if="selectedDispenseForApproval">
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-2">領用記錄詳情</h4>
                        <div class="space-y-1 text-sm">
                            <p><span class="text-gray-600">藥品:</span> <span class="font-semibold" x-text="`${selectedDispenseForApproval.medicine_code} - ${selectedDispenseForApproval.medicine_name}`"></span></p>
                            <p><span class="text-gray-600">數量:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.quantity"></span> <span x-text="selectedDispenseForApproval.unit"></span></p>
                            <p><span class="text-gray-600">領藥人:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.dispensed_by"></span></p>
                            <p x-show="selectedDispenseForApproval.patient_name"><span class="text-gray-600">病患:</span> <span x-text="selectedDispenseForApproval.patient_name"></span></p>
                            <p x-show="selectedDispenseForApproval.emergency_reason" class="text-claude-red-600 font-medium pt-2">
                                <span class="text-gray-600">緊急原因:</span> <span x-text="selectedDispenseForApproval.emergency_reason"></span>
                            </p>
                        </div>
                    </div>
                </template>

                <form @submit.prevent="submitPharmacistApproval()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> 藥師姓名
                        </label>
                        <input type="text"
                               x-model="pharmacistApprovalForm.approvedBy"
                               required
                               placeholder="藥師-林大華"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> PIN 碼 (藥師密碼)
                        </label>
                        <input type="password"
                               x-model="pharmacistApprovalForm.pinCode"
                               required
                               placeholder="請輸入4位數PIN碼"
                               maxlength="4"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        <p class="text-xs text-gray-500 mt-1">預設PIN碼: 1234 (生產環境請更改)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            藥師備註 (選填)
                        </label>
                        <textarea x-model="pharmacistApprovalForm.pharmacistNotes"
                                  rows="3"
                                  placeholder="確認無誤，已核對病患用藥記錄..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>確認審核</span>
                        </button>
                        <button type="button" @click="showPharmacistApprovalModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>取消</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex flex-col items-center justify-center gap-4">
                <!-- iRehab Logo -->
                <div class="flex items-center justify-center">
                    <img src="/static/iRehab_logo.png" alt="iRehab Logo" class="h-12 w-auto object-contain opacity-80 hover:opacity-100 transition-opacity">
                </div>

                <!-- Footer Text -->
                <div class="text-center text-xs text-gray-400 space-y-1">
                    <p>醫療站庫存管理系統 v1.4.2-plus</p>
                    <p class="flex items-center justify-center gap-2">
                        <span>Powered by</span>
                        <span class="font-semibold text-gray-500">De Novo Orthopedics Inc</span>
                    </p>
                </div>
            </div>
        </footer>

    </div>

    <script>
        function medicalInventory() {
            // v1.4.2-plus: 動態偵測 API URL (支援遠端存取)
            const currentHost = window.location.hostname;
            const apiBaseUrl = `http://${currentHost}:8000/api`;

            return {
                // 基本設定
                apiUrl: apiBaseUrl,
                stationId: localStorage.getItem('stationId') || 'HC-000000',
                stationName: localStorage.getItem('stationName') || '前線醫療站',
                stationType: localStorage.getItem('stationType') || '',
                showCustomStationInput: false,
                customStationType: 'TC',
                customStationNumber: '',
                currentTab: 'items',
                treatmentMode: 'surgery', // 處置標籤頁模式: 'surgery' 或 'consume'
                currentTime: '',
                
                // 資料
                items: [],
                filteredItems: [],
                bloodInventory: [],
                equipment: [],
                surgeryRecords: [],
                receiveHistory: [],
                consumeHistory: [],
                stats: {
                    totalItems: 0,
                    lowStockItems: 0,
                    totalBlood: 0,
                    equipmentAlerts: 0
                },

                // 搜尋與篩選
                itemSearchText: '',
                itemCategoryFilter: '',  // 分類篩選 (空字串=全部, 'medicine'=藥品, 'consumable'=耗材)
                receiveItemSearch: '',
                filteredReceiveItems: [],
                showReceiveDropdown: false,

                // Modal 狀態
                showAddItemModal: false,
                showEditItemModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showCheckEquipmentModal: false,
                showAddSurgeryModal: false,
                showSurgeryDetailModal: false,
                showReceiveHistoryModal: false,
                showConsumeHistoryModal: false,
                showConsumeDetailModal: false,
                showBloodHistoryModal: false,
                showEmergencyReasonModal: false,
                showPharmacistApprovalModal: false,

                // 血庫歷史記錄
                bloodHistory: [],
                bloodHistorySearch: {
                    startDate: '',
                    endDate: '',
                    bloodType: '',
                    eventType: ''
                },
                selectedBloodRecord: null,

                // 個別血袋追蹤 (v1.4.2-plus)
                bloodBags: [],
                selectedBagCodes: [],
                bloodBagForm: {
                    blood_type: '',
                    volume_ml: 250,
                    collection_date: '',
                    expiry_date: '',
                    donor_info: ''
                },

                // 藥品領用記錄 (MIRS v2.3)
                pendingDispenses: [],
                dispenseHistory: [],
                selectedDispenseForApproval: null,

                // 表單
                receiveForm: {
                    itemCode: '',
                    quantity: 1,
                    batchNumber: '',
                    expiryDate: '',
                    remarks: '',
                    stationId: 'HC-000000'
                },
                consumeForm: {
                    itemCode: '',
                    quantity: 1,
                    purpose: '',
                    stationId: 'HC-000000'
                },
                batchConsumeForm: {
                    purpose: '',
                    items: [],
                    stationId: 'HC-000000'
                },
                bloodReceiveForm: {
                    bloodType: '',
                    quantity: 1,
                    remarks: '',
                    source: 'blood_center',  // 新增：血液來源
                    donorName: '',           // 新增：捐血者姓名
                    donorPhone: '',          // 新增：捐血者電話
                    stationId: 'HC-000000'
                },
                bloodConsumeForm: {
                    bloodType: '',
                    quantity: 1,
                    patientName: '',
                    patientId: '',
                    purpose: '',
                    stationId: 'HC-000000'
                },
                bloodTransferForm: {
                    sourceStationId: 'HC-000000',
                    targetStationId: '',
                    bloodType: '',
                    quantity: 1,
                    operator: 'SYSTEM',
                    remarks: ''
                },
                addItemForm: {
                    code: '',
                    name: '',
                    unit: 'EA',
                    minStock: 10,
                    category: '其他'
                },
                editItemForm: {
                    code: '',
                    name: '',
                    unit: '',
                    minStock: 0,
                    category: ''
                },
                addEquipmentForm: {
                    name: '',
                    category: '其他',
                    quantity: 1,
                    remarks: '',
                    stationId: localStorage.getItem('stationId') || 'HC-000000'
                },
                editEquipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    remarks: ''
                },
                checkEquipmentForm: {
                    id: '',
                    name: '',
                    status: 'NORMAL',
                    powerLevel: null,
                    remarks: '',
                    stationId: 'HC-000000'
                },
                addSurgeryForm: {
                    patientName: '',
                    triageTagId: '',
                    surgeryType: '',
                    surgeonName: '',
                    anesthesiaType: '',
                    durationMinutes: null,
                    remarks: '',
                    consumptions: [],
                    stationId: 'HC-000000'
                },
                surgerySearchForm: {
                    startDate: '',
                    endDate: '',
                    patientName: ''
                },
                receiveHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                consumeHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                dispenseForm: {
                    medicineCode: '',
                    quantity: 1,
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    stationCode: 'HC-000000',
                    emergencyReason: ''
                },
                batchDispenseForm: {
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    items: [],
                    stationCode: 'HC-000000',
                    isEmergency: false,
                    emergencyReason: ''
                },
                pharmacistApprovalForm: {
                    dispenseId: null,
                    approvedBy: '',
                    pharmacistNotes: '',
                    pinCode: ''
                },
                selectedSurgery: null,
                selectedConsumeEvent: null,

                // Toast
                showToast: false,
                toastMessage: '',
                toastType: 'info',

                // 緊急功能 (v1.4.5新增)
                showEmergencyModal: false,

                // 同步管理 (聯邦架構 Phase 1-2)
                syncPackageForm: {
                    syncType: 'DELTA',
                    sinceTimestamp: ''
                },
                generatedPackage: null,
                uploadedPackage: null,
                importResult: null,
                syncStats: {
                    pendingChanges: 0,
                    syncedPackages: 0,
                    lastSync: null
                },

                // 載入狀態追蹤 (v1.4.5效能優化)
                dataLoaded: {
                    items: false,
                    blood: false,
                    equipment: false,
                    surgery: false,
                    dispense: false
                },

                // 初始化 (v1.4.5優化: 延遲載入)
                async init() {
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);

                    // 同步所有表單的 stationId
                    this.syncFormStationIds();

                    // 只載入統計資料（輕量級）
                    await this.loadStats();

                    // 根據當前標籤載入對應資料
                    await this.lazyLoadTabData(this.currentTab);
                },

                // 同步所有表單的 stationId 與當前站點
                syncFormStationIds() {
                    this.receiveForm.stationId = this.stationId;
                    this.consumeForm.stationId = this.stationId;
                    this.batchConsumeForm.stationId = this.stationId;
                    this.bloodReceiveForm.stationId = this.stationId;
                    this.bloodConsumeForm.stationId = this.stationId;
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },

                getStationTypeName() {
                    const types = {
                        'health_center': '衛生所',
                        'hospital_custom': '醫院自訂',
                        'surgical_station': 'BORP 備援手術站',
                        'logistics_hub': '物資中繼站'
                    };
                    return types[this.stationType] || this.stationType;
                },

                // 延遲載入標籤資料 (v1.4.5效能優化)
                async lazyLoadTabData(tab) {
                    if (tab === 'items' && !this.dataLoaded.items) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'blood' && !this.dataLoaded.blood) {
                        await this.loadBloodInventory();
                        await this.loadBloodBags();
                        this.dataLoaded.blood = true;
                    }
                    if (tab === 'equipment' && !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        this.dataLoaded.equipment = true;
                    }
                    if (tab === 'surgery' && !this.dataLoaded.surgery) {
                        await this.loadSurgeryRecords();
                        this.dataLoaded.surgery = true;
                    }
                    if (tab === 'treatment' && !this.dataLoaded.items) {
                        // 處置標籤需要物品資料 (用於消耗品項搜尋)
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'dispense' && !this.dataLoaded.dispense) {
                        await this.loadPendingDispenses();
                        this.dataLoaded.dispense = true;
                    }
                },

                // 分頁切換 (v1.4.5優化: 延遲載入)
                async switchTab(tab) {
                    this.currentTab = tab;
                    await this.lazyLoadTabData(tab);
                },

                // 切換站點
                async changeStation(newStationId) {
                    // If same station, do nothing
                    if (newStationId === this.stationId) return;

                    // Store old station for rollback
                    const oldStationId = this.stationId;

                    // Infer station type and name from ID
                    const getStationInfo = (stationId) => {
                        // Hardcoded mappings for common stations
                        const hardcoded = {
                            'HC-000000': { name: '醫療站 HC-000000', type: 'health_center' },
                            'BORP-01': { name: 'BORP 備援手術站', type: 'surgical_station' },
                            'LOG-HUB': { name: '物資中心 LOG-HUB', type: 'logistics_hub' }
                        };

                        if (hardcoded[stationId]) {
                            return hardcoded[stationId];
                        }

                        // Parse prefix for custom stations
                        let type, name;
                        if (stationId.startsWith('TC-')) {
                            type = 'health_center';
                            name = `醫療站 ${stationId}`;
                        } else if (stationId.startsWith('BORP-')) {
                            type = 'surgical_station';
                            name = `BORP 備援手術站 ${stationId}`;
                        } else if (stationId.startsWith('LOG-')) {
                            type = 'logistics_hub';
                            name = `物資中心 ${stationId}`;
                        } else {
                            // Unknown type - use generic
                            type = 'custom';
                            name = stationId;
                        }

                        return { name, type };
                    };

                    const oldInfo = getStationInfo(oldStationId);
                    const newInfo = getStationInfo(newStationId);

                    // Confirm station switch
                    const confirmed = confirm(
                        `確定要切換至「${newInfo.name}」嗎？\n\n` +
                        `📌 重要說明：\n` +
                        `• 切換站點後，您將只能看到該站點的資料\n` +
                        `• 各站點的資料都保存在資料庫中，不會被刪除\n` +
                        `• 在 ${oldInfo.name} 新增的資料仍屬於 ${oldInfo.name}\n` +
                        `• 切換回原站點時，資料仍會在那裡\n\n` +
                        `是否繼續切換？`
                    );

                    if (!confirmed) {
                        // Reset select element back to old station
                        if (typeof event !== 'undefined' && event.target) {
                            event.target.value = oldStationId;
                        }
                        return;
                    }

                    // Update station
                    this.stationId = newStationId;
                    this.stationName = newInfo.name;
                    this.stationType = newInfo.type;

                    localStorage.setItem('stationId', newStationId);
                    localStorage.setItem('stationName', this.stationName);
                    localStorage.setItem('stationType', this.stationType);

                    // 同步所有表單的 stationId
                    this.syncFormStationIds();

                    // Reset data loaded flags
                    this.dataLoaded = {
                        items: false,
                        blood: false,
                        equipment: false,
                        surgery: false,
                        dispense: false
                    };

                    // Reload current tab data
                    await this.loadStats();
                    await this.lazyLoadTabData(this.currentTab);

                    // Auto-initialize new station with template if empty
                    if (this.currentTab === 'equipment' || !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        await this.autoInitializeStationTemplate();
                    }

                    this.toast(`已從 ${oldInfo.name} 切換至 ${this.stationName}`, 'info');
                },

                // Auto-initialize station with equipment template
                async autoInitializeStationTemplate() {
                    // Only auto-initialize if equipment is empty
                    if (this.equipment && this.equipment.length > 0) {
                        return; // Station already has equipment
                    }

                    // Don't auto-initialize if it's a well-known station (already set up manually)
                    const knownStations = ['HC-000000', 'BORP-01', 'LOG-HUB'];
                    if (knownStations.includes(this.stationId)) {
                        return;
                    }

                    // Determine template based on station type
                    let templateStationId;
                    if (this.stationId.startsWith('TC-')) {
                        templateStationId = 'HC-000000';
                    } else if (this.stationId.startsWith('BORP-')) {
                        templateStationId = 'BORP-01';
                    } else if (this.stationId.startsWith('LOG-')) {
                        templateStationId = 'LOG-HUB';
                    } else {
                        return; // Unknown type, skip auto-initialization
                    }

                    // Fetch template equipment
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment?station_id=${templateStationId}`);
                        if (!response.ok) return;

                        const data = await response.json();
                        const templateEquipment = data.equipment || [];

                        if (templateEquipment.length === 0) return;

                        // Ask user if they want to copy template
                        const confirmed = confirm(
                            `檢測到 ${this.stationName} 尚無設備。\n\n` +
                            `是否要從 ${templateStationId} 複製 ${templateEquipment.length} 項設備模板？\n\n` +
                            `這將幫助您快速設置新站點。`
                        );

                        if (!confirmed) return;

                        // Copy equipment from template
                        let successCount = 0;
                        for (const eq of templateEquipment) {
                            // Generate new equipment ID for this station
                            const oldPrefix = templateStationId.replace('-', '');
                            const newPrefix = this.stationId.replace('-', '');
                            const newId = eq.id.replace(oldPrefix, newPrefix);

                            const newEquipment = {
                                id: newId,
                                name: eq.name,
                                category: eq.category,
                                quantity: eq.quantity,
                                status: 'UNCHECKED',
                                power_level: eq.power_level,
                                remarks: `從 ${templateStationId} 複製`,
                                station_id: this.stationId
                            };

                            try {
                                const addResponse = await fetch(`${this.apiUrl}/equipment`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(newEquipment)
                                });

                                if (addResponse.ok) {
                                    successCount++;
                                }
                            } catch (error) {
                                console.error('複製設備失敗:', newId, error);
                            }
                        }

                        if (successCount > 0) {
                            this.toast(`已成功複製 ${successCount} 項設備`, 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('自動初始化失敗:', error);
                    }
                },

                // 處理站點選擇變更
                handleStationSelectChange(value) {
                    if (value === '__CUSTOM__') {
                        this.showCustomStationInput = true;
                        this.customStationType = 'TC';
                        this.customStationNumber = '';
                        // Auto-focus the input after it appears
                        this.$nextTick(() => {
                            const input = document.querySelector('input[x-model="customStationNumber"]');
                            if (input) input.focus();
                        });
                    } else {
                        this.showCustomStationInput = false;
                        this.changeStation(value);
                    }
                },

                // 應用自訂站點ID
                applyCustomStation() {
                    if (!this.customStationNumber || !this.customStationNumber.trim()) {
                        this.toast('請輸入站點編號', 'error');
                        return;
                    }

                    // Validate number format (digits only, padded with leading zeros)
                    const number = this.customStationNumber.trim();
                    if (!/^\d+$/.test(number)) {
                        this.toast('編號只能包含數字', 'error');
                        return;
                    }

                    // Pad number with leading zeros to 2 digits
                    const paddedNumber = number.padStart(2, '0');

                    // Generate station ID based on type
                    let stationId;
                    if (this.customStationType === 'LOG') {
                        // LOG stations use different format: LOG-XXX or LOG-HUB
                        if (paddedNumber === '01') {
                            stationId = 'LOG-HUB'; // Special case for main hub
                        } else {
                            stationId = `LOG-${paddedNumber}`;
                        }
                    } else {
                        stationId = `${this.customStationType}-${paddedNumber}`;
                    }

                    this.showCustomStationInput = false;
                    this.customStationNumber = '';
                    this.changeStation(stationId);
                },

                // 確保items已載入 (用於搜尋耗材功能)
                async ensureItemsLoaded() {
                    if (!this.dataLoaded.items || this.items.length === 0) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                },

                // 載入統計
                async loadStats() {
                    try {
                        const url = this.stationId
                            ? `${this.apiUrl}/stats?station_id=${this.stationId}`
                            : `${this.apiUrl}/stats`;
                        const response = await fetch(url);
                        if (response.ok) {
                            this.stats = await response.json();
                            console.log(`✓ 統計已載入 (站點: ${this.stationId}):`, this.stats);
                        }
                    } catch (error) {
                        console.error('載入統計失敗:', error);
                    }
                },

                // 載入物品
                async loadItems() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`);
                        if (response.ok) {
                            const data = await response.json();
                            this.items = data.items;
                            this.filteredItems = data.items;
                        }
                    } catch (error) {
                        console.error('載入物品失敗:', error);
                        this.toast('載入物品失敗', 'error');
                    }
                },

                // 篩選物品 (v1.4.2-plus: 支援藥品/耗材分類篩選)
                filterItems() {
                    let result = this.items;

                    // 分類篩選 (藥品 = MED- 開頭, 耗材 = 非 MED- 開頭)
                    if (this.itemCategoryFilter === 'medicine') {
                        result = result.filter(item => item.code.startsWith('MED-'));
                    } else if (this.itemCategoryFilter === 'consumable') {
                        result = result.filter(item => !item.code.startsWith('MED-'));
                    }

                    // 文字搜尋
                    const searchText = this.itemSearchText.toLowerCase();
                    if (searchText) {
                        result = result.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText) ||
                            item.category.toLowerCase().includes(searchText)
                        );
                    }

                    this.filteredItems = result;
                },

                // 匯出庫存CSV
                exportInventoryCSV() {
                    const url = `${this.apiUrl}/inventory/export/csv`;
                    window.open(url, '_blank');
                    this.toast('CSV 匯出成功', 'success');
                },

                // 匯出庫存JSON
                exportInventoryJSON() {
                    const url = `${this.apiUrl}/inventory/export/json`;
                    window.open(url, '_blank');
                    this.toast('JSON 匯出成功', 'success');
                },

                // 新增物品
                async submitAddItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addItemForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '物品新增成功', 'success');
                            this.showAddItemModal = false;
                            this.resetAddItemForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '新增失敗', 'error');
                        }
                    } catch (error) {
                        console.error('新增物品失敗:', error);
                        this.toast('新增物品失敗', 'error');
                    }
                },

                resetAddItemForm() {
                    this.addItemForm = {
                        code: '',
                        name: '',
                        unit: 'EA',
                        minStock: 10,
                        category: '其他'
                    };
                },

                // 編輯物品
                editItem(item) {
                    this.editItemForm = {
                        code: item.code,
                        name: item.name,
                        unit: item.unit,
                        minStock: item.min_stock,
                        category: item.category
                    };
                    this.showEditItemModal = true;
                },

                async submitEditItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${this.editItemForm.code}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editItemForm.name,
                                unit: this.editItemForm.unit,
                                minStock: this.editItemForm.minStock,
                                category: this.editItemForm.category
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '物品更新成功', 'success');
                            this.showEditItemModal = false;
                            await this.loadItems();
                        } else {
                            this.toast(data.detail || '更新失敗', 'error');
                        }
                    } catch (error) {
                        console.error('更新物品失敗:', error);
                        this.toast('更新物品失敗', 'error');
                    }
                },

                // 刪除物品
                async deleteItem(code, name) {
                    if (!confirm(`確定要刪除物品「${name}」嗎?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${code}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '物品已刪除', 'success');
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '刪除失敗', 'error');
                        }
                    } catch (error) {
                        console.error('刪除物品失敗:', error);
                        this.toast('刪除物品失敗', 'error');
                    }
                },

                // 進貨
                async submitReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '進貨記錄成功', 'success');
                            this.resetReceiveForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '進貨失敗', 'error');
                        }
                    } catch (error) {
                        console.error('進貨失敗:', error);
                        this.toast('進貨失敗', 'error');
                    }
                },

                resetReceiveForm() {
                    this.receiveForm = {
                        itemCode: '',
                        quantity: 1,
                        batchNumber: '',
                        expiryDate: '',
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.receiveItemSearch = '';
                },

                // 進貨頁面 - 物品搜尋
                filterReceiveItems() {
                    const searchText = this.receiveItemSearch.toLowerCase();
                    if (!searchText) {
                        this.filteredReceiveItems = this.items;
                    } else {
                        this.filteredReceiveItems = this.items.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                // 進貨頁面 - 選擇物品
                selectReceiveItem(item) {
                    this.receiveForm.itemCode = item.code;
                    this.receiveItemSearch = `${item.code} - ${item.name}`;
                    this.showReceiveDropdown = false;
                },

                // 載入進貨記錄
                async loadReceiveHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=RECEIVE&limit=100`;

                        if (this.receiveHistorySearch.startDate) {
                            url += `&start_date=${this.receiveHistorySearch.startDate}`;
                        }
                        if (this.receiveHistorySearch.endDate) {
                            url += `&end_date=${this.receiveHistorySearch.endDate}`;
                        }
                        if (this.receiveHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.receiveHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.receiveHistory = data.events;
                        }
                    } catch (error) {
                        console.error('載入進貨記錄失敗:', error);
                        this.toast('載入進貨記錄失敗', 'error');
                    }
                },

                // 匯出進貨記錄
                exportReceiveHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=RECEIVE`;

                    if (this.receiveHistorySearch.startDate) {
                        url += `&start_date=${this.receiveHistorySearch.startDate}`;
                    }
                    if (this.receiveHistorySearch.endDate) {
                        url += `&end_date=${this.receiveHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('進貨記錄匯出成功', 'success');
                },

                // 消耗
                async submitConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.consumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '消耗記錄成功', 'success');
                            this.resetConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '消耗失敗', 'error');
                        }
                    } catch (error) {
                        console.error('消耗失敗:', error);
                        this.toast('消耗失敗', 'error');
                    }
                },

                resetConsumeForm() {
                    this.consumeForm = {
                        itemCode: '',
                        quantity: 1,
                        purpose: '',
                        stationId: this.stationId
                    };
                },

                // 批次消耗功能
                addBatchConsumeItem() {
                    this.batchConsumeForm.items.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchConsumeItem(index) {
                    this.batchConsumeForm.items.splice(index, 1);
                },

                filterBatchConsumeItems(index) {
                    const item = this.batchConsumeForm.items[index];
                    if (!item) return;

                    const searchText = (item.searchText || '').toLowerCase();

                    // 確保 items 已載入且有資料
                    if (!this.items || this.items.length === 0) {
                        item.filteredItems = [];
                        return;
                    }

                    // 排除藥品 (medicines) - 藥品應該透過藥品領用流程
                    // 加入檢查確保每個元素都有必要的屬性
                    const nonMedicineItems = this.items.filter(i =>
                        i && i.category && i.category !== '藥品'
                    );

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i && i.code && i.name &&
                            (i.code.toLowerCase().includes(searchText) ||
                             i.name.toLowerCase().includes(searchText))
                        );
                    }
                },

                selectBatchConsumeItem(index, selectedItem) {
                    const item = this.batchConsumeForm.items[index];
                    item.itemCode = selectedItem.code;
                    item.itemName = selectedItem.name;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                async submitBatchConsume() {
                    try {
                        if (this.batchConsumeForm.items.length === 0) {
                            this.toast('請至少新增一個消耗品項', 'error');
                            return;
                        }

                        // 批次提交每個消耗品項
                        let successCount = 0;
                        let failCount = 0;

                        for (const item of this.batchConsumeForm.items) {
                            try {
                                const response = await fetch(`${this.apiUrl}/consume`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        itemCode: item.itemCode,
                                        quantity: item.quantity,
                                        purpose: this.batchConsumeForm.purpose,
                                        stationId: this.batchConsumeForm.stationId
                                    })
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                failCount++;
                            }
                        }

                        // 顯示結果
                        if (failCount === 0) {
                            this.toast(`成功消耗 ${successCount} 項物品`, 'success');
                            this.resetBatchConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`成功 ${successCount} 項，失敗 ${failCount} 項`, 'warning');
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('批次消耗失敗:', error);
                        this.toast('批次消耗失敗', 'error');
                    }
                },

                resetBatchConsumeForm() {
                    this.batchConsumeForm = {
                        purpose: '',
                        items: [],
                        stationId: this.stationId
                    };
                },

                // 載入消耗記錄
                async loadConsumeHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=CONSUME&limit=100`;

                        if (this.consumeHistorySearch.startDate) {
                            url += `&start_date=${this.consumeHistorySearch.startDate}`;
                        }
                        if (this.consumeHistorySearch.endDate) {
                            url += `&end_date=${this.consumeHistorySearch.endDate}`;
                        }
                        if (this.consumeHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.consumeHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.consumeHistory = data.events;
                        }
                    } catch (error) {
                        console.error('載入消耗記錄失敗:', error);
                        this.toast('載入消耗記錄失敗', 'error');
                    }
                },

                // 查看消耗詳情
                viewConsumeDetail(event) {
                    this.selectedConsumeEvent = event;
                    this.showConsumeDetailModal = true;
                },

                // 載入血庫歷史記錄
                async loadBloodHistory() {
                    try {
                        let url = `${this.apiUrl}/blood/events?station_id=${this.stationId}`;

                        // 添加篩選條件
                        if (this.bloodHistorySearch.startDate) {
                            url += `&start_date=${this.bloodHistorySearch.startDate}`;
                        }
                        if (this.bloodHistorySearch.endDate) {
                            url += `&end_date=${this.bloodHistorySearch.endDate}`;
                        }
                        if (this.bloodHistorySearch.bloodType) {
                            url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                        }
                        if (this.bloodHistorySearch.eventType) {
                            url += `&event_type=${this.bloodHistorySearch.eventType}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.status === 'success') {
                            this.bloodHistory = data.data || [];
                        } else {
                            this.toast('載入血庫歷史記錄失敗', 'error');
                        }
                    } catch (error) {
                        console.error('載入血庫歷史記錄錯誤:', error);
                        this.toast('載入血庫歷史記錄錯誤', 'error');
                    }
                },

                // 查看血液記錄詳情
                viewBloodDetail(record) {
                    this.selectedBloodRecord = record;
                    // 可以擴展為顯示詳情 Modal
                    let detailText = `
=== 血庫記錄詳情 ===
類型: ${record.event_type === 'RECEIVE' ? '入庫' : '出庫'}
血型: ${record.blood_type}
數量: ${record.quantity} U
時間: ${new Date(record.timestamp).toLocaleString('zh-TW')}
操作員: ${record.operator}
備註: ${record.remarks || '無'}
`;

                    // 如果有捐血者資訊（Walking Blood Bank）
                    if (record.donor_name || record.donor_phone) {
                        detailText += `\n--- 緊急捐血者資訊 ---\n`;
                        if (record.donor_name) detailText += `姓名: ${record.donor_name}\n`;
                        if (record.donor_phone) detailText += `電話: ${record.donor_phone}\n`;
                    }

                    // 如果有病患資訊（出庫記錄）
                    if (record.patient_name) {
                        detailText += `\n--- 病患資訊 ---\n`;
                        detailText += `姓名: ${record.patient_name}\n`;
                        if (record.patient_id) detailText += `病歷號: ${record.patient_id}\n`;
                        if (record.diagnosis) detailText += `診斷: ${record.diagnosis}\n`;
                    }

                    alert(detailText);
                },

                // 匯出血庫歷史記錄 CSV
                exportBloodHistoryCSV() {
                    let url = `${this.apiUrl}/blood/events/export/csv?station_id=${this.stationId}`;

                    if (this.bloodHistorySearch.startDate) {
                        url += `&start_date=${this.bloodHistorySearch.startDate}`;
                    }
                    if (this.bloodHistorySearch.endDate) {
                        url += `&end_date=${this.bloodHistorySearch.endDate}`;
                    }
                    if (this.bloodHistorySearch.bloodType) {
                        url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                    }
                    if (this.bloodHistorySearch.eventType) {
                        url += `&event_type=${this.bloodHistorySearch.eventType}`;
                    }

                    window.open(url, '_blank');
                    this.toast('血庫記錄匯出成功', 'success');
                },

                // 匯出消耗記錄
                exportConsumeHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=CONSUME`;

                    if (this.consumeHistorySearch.startDate) {
                        url += `&start_date=${this.consumeHistorySearch.startDate}`;
                    }
                    if (this.consumeHistorySearch.endDate) {
                        url += `&end_date=${this.consumeHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('消耗記錄匯出成功', 'success');
                },

                // 血袋
                async loadBloodInventory() {
                    try {
                        // Add cache busting for Safari
                        const timestamp = new Date().getTime();
                        const response = await fetch(`${this.apiUrl}/blood/inventory?_t=${timestamp}`, {
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            console.log('API Response:', data);
                            console.log('Current station:', this.stationId);

                            // Filter by current station only
                            const stationBlood = data.bloodInventory.filter(b => b.station_id === this.stationId);
                            console.log('Filtered blood for station:', stationBlood);

                            // Ensure all blood types are present with at least 0 quantity
                            const allBloodTypes = ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'];
                            this.bloodInventory = allBloodTypes.map(type => {
                                const existing = stationBlood.find(b => b.blood_type === type);
                                return existing || {
                                    blood_type: type,
                                    quantity: 0,
                                    station_id: this.stationId
                                };
                            });

                            console.log('✓ 血袋庫存已載入:', this.bloodInventory.length, '筆', `(站點: ${this.stationId})`);
                            console.log('Blood inventory array:', JSON.stringify(this.bloodInventory));

                            // Force Alpine.js to reactively update
                            this.$nextTick(() => {
                                console.log('Next tick - blood inventory updated');
                            });
                        } else {
                            console.error('血袋庫存API錯誤:', response.status);
                        }
                    } catch (error) {
                        console.error('載入血袋庫存失敗:', error);
                    }
                },

                async submitBloodReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodReceiveForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || '血袋入庫成功', 'success');
                            this.bloodReceiveForm = {
                                bloodType: '',
                                quantity: 1,
                                remarks: '',
                                source: 'blood_center',
                                donorName: '',
                                donorPhone: '',
                                stationId: this.stationId
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '入庫失敗', 'error');
                        }
                    } catch (error) {
                        console.error('血袋入庫失敗:', error);
                        this.toast('血袋入庫失敗', 'error');
                    }
                },

                printBloodLabel() {
                    // 檢查必填欄位
                    if (!this.bloodReceiveForm.bloodType) {
                        this.toast('請選擇血型', 'error');
                        return;
                    }
                    if (!this.bloodReceiveForm.quantity || this.bloodReceiveForm.quantity < 1) {
                        this.toast('請輸入有效數量', 'error');
                        return;
                    }

                    // 構建URL參數
                    const params = new URLSearchParams({
                        blood_type: this.bloodReceiveForm.bloodType,
                        quantity: this.bloodReceiveForm.quantity,
                        station_id: this.stationId,
                        remarks: this.bloodReceiveForm.remarks || ''
                    });

                    // 開啟列印標籤頁面
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('正在開啟標籤列印...', 'info');
                },

                printBloodLabelFromHistory(record) {
                    // 從歷史記錄列印標籤
                    const params = new URLSearchParams({
                        blood_type: record.blood_type,
                        quantity: Math.abs(record.quantity),
                        station_id: record.station_id,
                        remarks: record.remarks || ''
                    });

                    // 開啟列印標籤頁面
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('正在開啟標籤列印...', 'info');
                },

                async submitBloodConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodConsumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '血袋出庫成功', 'success');
                            this.bloodConsumeForm = { bloodType: '', quantity: 1, stationId: this.stationId };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '出庫失敗', 'error');
                        }
                    } catch (error) {
                        console.error('血袋出庫失敗:', error);
                        this.toast('血袋出庫失敗', 'error');
                    }
                },

                async submitBloodTransfer() {
                    try {
                        // 驗證必填欄位
                        if (!this.bloodTransferForm.sourceStationId || !this.bloodTransferForm.targetStationId) {
                            this.toast('請輸入來源站點和目標站點', 'error');
                            return;
                        }
                        if (this.bloodTransferForm.sourceStationId === this.bloodTransferForm.targetStationId) {
                            this.toast('來源站點與目標站點不能相同', 'error');
                            return;
                        }
                        if (!this.bloodTransferForm.bloodType) {
                            this.toast('請選擇血型', 'error');
                            return;
                        }

                        const response = await fetch(`${this.apiUrl}/blood/transfer`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodTransferForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || '血袋轉移成功', 'success');
                            // 重置表單
                            this.bloodTransferForm = {
                                sourceStationId: 'HC-000000',
                                targetStationId: '',
                                bloodType: '',
                                quantity: 1,
                                operator: 'SYSTEM',
                                remarks: ''
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '轉移失敗', 'error');
                        }
                    } catch (error) {
                        console.error('血袋站點轉移失敗:', error);
                        this.toast('血袋站點轉移失敗', 'error');
                    }
                },

                // ========== 個別血袋追蹤 (v1.4.2-plus) ==========
                async loadBloodBags() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/list?status=AVAILABLE`);
                        if (response.ok) {
                            const data = await response.json();
                            this.bloodBags = data.blood_bags || [];
                            console.log('✓ 血袋已載入:', this.bloodBags.length, '袋');
                        }
                    } catch (error) {
                        console.error('載入血袋失敗:', error);
                    }
                },

                async createBloodBag() {
                    if (!this.bloodBagForm.blood_type) {
                        this.toast('請選擇血型', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                blood_type: this.bloodBagForm.blood_type,
                                volume_ml: parseInt(this.bloodBagForm.volume_ml) || 250,
                                collection_date: this.bloodBagForm.collection_date || null,
                                expiry_date: this.bloodBagForm.expiry_date || null,
                                donor_info: this.bloodBagForm.donor_info || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`血袋建立成功: ${data.bag_code}`, 'success');
                            this.bloodBagForm = { blood_type: '', volume_ml: 250, collection_date: '', expiry_date: '', donor_info: '' };
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '建立失敗', 'error');
                        }
                    } catch (error) {
                        console.error('建立血袋失敗:', error);
                        this.toast('建立血袋失敗', 'error');
                    }
                },

                async useBloodBag(bagCode) {
                    const patientName = prompt('請輸入使用者/病患姓名:');
                    if (!patientName) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/use`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bag_code: bagCode,
                                used_for_patient: patientName
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || '血袋已標記為使用', 'success');
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '操作失敗', 'error');
                        }
                    } catch (error) {
                        console.error('使用血袋失敗:', error);
                        this.toast('使用血袋失敗', 'error');
                    }
                },

                printSingleBagLabel(bagCode) {
                    window.open(`${this.apiUrl}/blood-bags/print-labels/${bagCode}`, '_blank');
                    this.toast('正在開啟標籤列印...', 'info');
                },

                printSelectedBagLabels() {
                    if (this.selectedBagCodes.length === 0) {
                        this.toast('請先選擇血袋', 'error');
                        return;
                    }
                    const codes = this.selectedBagCodes.join(',');
                    window.open(`${this.apiUrl}/blood-bags/print-labels/${codes}`, '_blank');
                    this.toast(`正在列印 ${this.selectedBagCodes.length} 袋標籤...`, 'info');
                    this.selectedBagCodes = [];
                },

                toggleAllBags(checked) {
                    if (checked) {
                        this.selectedBagCodes = this.bloodBags.filter(b => b.status === 'AVAILABLE').map(b => b.bag_code);
                    } else {
                        this.selectedBagCodes = [];
                    }
                },

                async checkExpiringBags() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/expiring?days=7`);
                        if (response.ok) {
                            const data = await response.json();
                            const expiring = data.expiring_bags || [];
                            if (expiring.length === 0) {
                                this.toast('目前無即將過期的血袋', 'info');
                            } else {
                                alert(`即期血袋警示 (7天內):\n\n${expiring.map(b => `${b.bag_code} (${b.blood_type}) - 效期: ${b.expiry_date}`).join('\n')}`);
                            }
                        }
                    } catch (error) {
                        console.error('檢查即期血袋失敗:', error);
                    }
                },

                isExpiringSoon(expiryDate) {
                    if (!expiryDate) return false;
                    const expiry = new Date(expiryDate);
                    const now = new Date();
                    const diffDays = (expiry - now) / (1000 * 60 * 60 * 24);
                    return diffDays <= 7 && diffDays >= 0;
                },

                // ========== 設備管理 ==========
                async loadEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment?station_id=${this.stationId}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.equipment = data.equipment;
                            console.log('✓ 設備已載入:', this.equipment.length, '項', `(站點: ${this.stationId})`);
                            // 重新載入統計數據以更新待檢查設備數量
                            await this.loadStats();
                            this.toast('設備列表已更新', 'success');
                        } else {
                            console.error('設備API錯誤:', response.status);
                            this.toast('載入設備失敗', 'error');
                        }
                    } catch (error) {
                        console.error('載入設備失敗:', error);
                        this.toast('載入設備失敗', 'error');
                    }
                },

                async submitAddEquipment() {
                    try {
                        // Ensure station_id is set
                        const equipmentData = {
                            ...this.addEquipmentForm,
                            station_id: this.stationId
                        };

                        const response = await fetch(`${this.apiUrl}/equipment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(equipmentData)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '設備新增成功', 'success');
                            this.showAddEquipmentModal = false;
                            this.resetAddEquipmentForm();
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '新增失敗', 'error');
                        }
                    } catch (error) {
                        console.error('新增設備失敗:', error);
                        this.toast('新增設備失敗', 'error');
                    }
                },

                resetAddEquipmentForm() {
                    this.addEquipmentForm = {
                        name: '',
                        category: '其他',
                        quantity: 1,
                        remarks: ''
                    };
                },

                editEquipment(eq) {
                    this.editEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category,
                        quantity: eq.quantity,
                        remarks: eq.remarks || ''
                    };
                    this.showEditEquipmentModal = true;
                },

                async submitEditEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${this.editEquipmentForm.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editEquipmentForm.name,
                                category: this.editEquipmentForm.category,
                                quantity: this.editEquipmentForm.quantity,
                                remarks: this.editEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '設備更新成功', 'success');
                            this.showEditEquipmentModal = false;
                            await this.loadEquipment();
                        } else {
                            this.toast(data.detail || '更新失敗', 'error');
                        }
                    } catch (error) {
                        console.error('更新設備失敗:', error);
                        this.toast('更新設備失敗', 'error');
                    }
                },

                async deleteEquipment(id, name) {
                    if (!confirm(`確定要刪除設備「${name}」嗎?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '設備已刪除', 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '刪除失敗', 'error');
                        }
                    } catch (error) {
                        console.error('刪除設備失敗:', error);
                        this.toast('刪除設備失敗', 'error');
                    }
                },

                checkEquipment(eq) {
                    this.checkEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        status: 'NORMAL',
                        powerLevel: eq.power_level,
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.showCheckEquipmentModal = true;
                },

                async submitCheckEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/check/${this.checkEquipmentForm.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.checkEquipmentForm.stationId,
                                status: this.checkEquipmentForm.status,
                                powerLevel: this.checkEquipmentForm.powerLevel,
                                remarks: this.checkEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '設備檢查完成', 'success');
                            this.showCheckEquipmentModal = false;
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '檢查失敗', 'error');
                        }
                    } catch (error) {
                        console.error('設備檢查失敗:', error);
                        this.toast('設備檢查失敗', 'error');
                    }
                },

                // 手術記錄
                async loadSurgeryRecords() {
                    try {
                        let url = `${this.apiUrl}/surgery/records?limit=50`;
                        
                        if (this.surgerySearchForm.startDate) {
                            url += `&start_date=${this.surgerySearchForm.startDate}`;
                        }
                        if (this.surgerySearchForm.endDate) {
                            url += `&end_date=${this.surgerySearchForm.endDate}`;
                        }
                        if (this.surgerySearchForm.patientName) {
                            url += `&patient_name=${encodeURIComponent(this.surgerySearchForm.patientName)}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryRecords = data.records;
                        }
                    } catch (error) {
                        console.error('載入手術記錄失敗:', error);
                        this.toast('載入手術記錄失敗', 'error');
                    }
                },

                addConsumptionItem() {
                    this.addSurgeryForm.consumptions.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        unit: '',
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                filterConsumptionItems(index) {
                    const item = this.addSurgeryForm.consumptions[index];
                    const searchText = item.searchText.toLowerCase();

                    // 排除藥品 (medicines) - 藥品應該透過藥品領用流程
                    const nonMedicineItems = this.items.filter(i => i.category !== '藥品');

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectConsumptionItem(index, selectedItem) {
                    const item = this.addSurgeryForm.consumptions[index];
                    item.itemCode = selectedItem.code;
                    item.itemName = selectedItem.name;
                    item.unit = selectedItem.unit;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                removeConsumptionItem(index) {
                    this.addSurgeryForm.consumptions.splice(index, 1);
                },

                updateConsumptionItemName(index) {
                    const itemCode = this.addSurgeryForm.consumptions[index].itemCode;
                    const item = this.items.find(i => i.code === itemCode);
                    if (item) {
                        this.addSurgeryForm.consumptions[index].itemName = item.name;
                        this.addSurgeryForm.consumptions[index].unit = item.unit;
                    }
                },

                async submitAddSurgery() {
                    if (this.addSurgeryForm.consumptions.length === 0) {
                        this.toast('請至少新增一項耗材', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery/record`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addSurgeryForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || '手術記錄建立成功', 'success');
                            this.showAddSurgeryModal = false;
                            this.resetAddSurgeryForm();
                            await this.loadSurgeryRecords();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || '建立失敗', 'error');
                        }
                    } catch (error) {
                        console.error('建立手術記錄失敗:', error);
                        this.toast('建立手術記錄失敗', 'error');
                    }
                },

                resetAddSurgeryForm() {
                    this.addSurgeryForm = {
                        patientName: '',
                        surgeryType: '',
                        surgeonName: '',
                        anesthesiaType: '',
                        durationMinutes: null,
                        remarks: '',
                        consumptions: [],
                        stationId: this.stationId
                    };
                },

                viewSurgeryDetail(record) {
                    this.selectedSurgery = record;
                    this.showSurgeryDetailModal = true;
                },

                async exportSurgeryCSV() {
                    try {
                        let url = `${this.apiUrl}/surgery/export/csv`;
                        const params = [];
                        
                        if (this.surgerySearchForm.startDate) {
                            params.push(`start_date=${this.surgerySearchForm.startDate}`);
                        }
                        if (this.surgerySearchForm.endDate) {
                            params.push(`end_date=${this.surgerySearchForm.endDate}`);
                        }
                        
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }
                        
                        window.open(url, '_blank');
                        this.toast('CSV 匯出成功', 'success');
                    } catch (error) {
                        console.error('匯出 CSV 失敗:', error);
                        this.toast('匯出 CSV 失敗', 'error');
                    }
                },

                // Toast 通知
                toast(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },

                // 緊急功能 (v1.4.5新增)
                emergencyDownloadAll() {
                    window.open(`${this.apiUrl}/emergency/download-all`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('正在生成完整備份包，請稍候...', 'info');
                },

                emergencyQuickBackup() {
                    window.open(`${this.apiUrl}/emergency/quick-backup`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('正在下載資料庫備份...', 'info');
                },

                // ========== 同步管理功能 (聯邦架構 Phase 1-2) ==========

                // 產生同步封包
                async generateSyncPackage() {
                    try {
                        const requestBody = {
                            stationId: this.stationId,
                            hospitalId: 'HOSP-001',
                            syncType: this.syncPackageForm.syncType
                        };

                        // 如果是增量同步且有指定時間
                        if (this.syncPackageForm.syncType === 'DELTA' && this.syncPackageForm.sinceTimestamp) {
                            // 轉換為 ISO 8601 格式
                            const dt = new Date(this.syncPackageForm.sinceTimestamp);
                            requestBody.sinceTimestamp = dt.toISOString();
                        }

                        const response = await fetch(`${this.apiUrl}/station/sync/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.generatedPackage = data;
                            this.syncStats.pendingChanges = data.changes_count;
                            this.toast(`封包已產生：${data.changes_count} 項變更`, 'success');
                        } else {
                            const error = await response.json();
                            this.toast(`產生封包失敗：${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('產生同步封包失敗:', error);
                        this.toast('產生同步封包失敗', 'error');
                    }
                },

                // 下載同步封包為 JSON 檔案
                downloadSyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('請先產生同步封包', 'error');
                        return;
                    }

                    const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${this.generatedPackage.package_id}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    this.toast('封包已下載', 'success');
                },

                // 複製同步封包到剪貼簿
                async copySyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('請先產生同步封包', 'error');
                        return;
                    }

                    try {
                        const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                        await navigator.clipboard.writeText(dataStr);
                        this.toast('封包已複製到剪貼簿', 'success');
                    } catch (error) {
                        console.error('複製失敗:', error);
                        this.toast('複製失敗', 'error');
                    }
                },

                // 處理同步檔案上傳
                handleSyncFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            this.uploadedPackage = {
                                packageId: jsonData.package_id,
                                changes: jsonData.changes,
                                checksum: jsonData.checksum
                            };
                            this.importResult = null; // 清除之前的匯入結果
                            this.toast('封包已載入', 'info');
                        } catch (error) {
                            console.error('解析 JSON 失敗:', error);
                            this.toast('檔案格式錯誤', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                // 清除已上傳的封包
                clearUploadedPackage() {
                    this.uploadedPackage = null;
                    this.importResult = null;
                    // 清除 file input
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.value = '';
                    this.toast('已清除上傳封包', 'info');
                },

                // 匯入同步封包
                async importSyncPackage() {
                    if (!this.uploadedPackage) {
                        this.toast('請先上傳同步封包', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/station/sync/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.stationId,
                                packageId: this.uploadedPackage.packageId,
                                changes: this.uploadedPackage.changes,
                                checksum: this.uploadedPackage.checksum
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.importResult = data;

                            if (data.success) {
                                this.syncStats.syncedPackages += 1;
                                this.syncStats.lastSync = new Date().toLocaleString('zh-TW');
                                this.toast(`匯入成功：${data.changes_applied} 項變更已套用`, 'success');

                                // 重新載入資料
                                await this.loadStats();
                                await this.loadItems();
                                await this.loadBloodInventory();
                            } else {
                                this.toast(`匯入失敗：${data.message}`, 'error');
                            }
                        } else {
                            const error = await response.json();
                            this.importResult = {
                                success: false,
                                message: error.detail || '匯入失敗'
                            };
                            this.toast(`匯入失敗：${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('匯入同步封包失敗:', error);
                        this.importResult = {
                            success: false,
                            message: '匯入失敗：網路錯誤'
                        };
                        this.toast('匯入同步封包失敗', 'error');
                    }
                },

                // ========== 藥品領用 API (MIRS v2.3 - Emergency Dispense) ==========

                // 載入待處理領用清單
                async loadPendingDispenses() {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/pending`);
                        if (response.ok) {
                            const data = await response.json();
                            this.pendingDispenses = data.records || [];
                            console.log('待處理領用清單:', this.pendingDispenses);
                        } else {
                            console.error('載入待處理領用清單失敗');
                            this.toast('載入待處理領用清單失敗', 'error');
                        }
                    } catch (error) {
                        console.error('載入待處理領用清單錯誤:', error);
                        this.toast('載入待處理領用清單錯誤', 'error');
                    }
                },

                // 正常領用 (需審核)
                async normalDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('請選擇藥品', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('請輸入領藥人', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/normal`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`正常領用請求已送出，等待藥師審核 (ID: ${data.dispense_id})`, 'success');
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                        } else {
                            this.toast(`領用失敗: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('正常領用錯誤:', error);
                        this.toast('正常領用失敗，請稍後再試', 'error');
                    }
                },

                // 緊急領用 (Break-the-Glass)
                async emergencyDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('請選擇藥品', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('請輸入領藥人', 'error');
                        return;
                    }

                    if (!this.dispenseForm.emergencyReason || this.dispenseForm.emergencyReason.length < 5) {
                        this.toast('緊急原因必須至少5個字', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/emergency`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                emergencyReason: this.dispenseForm.emergencyReason,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`緊急領用成功！已立即扣除庫存 (ID: ${data.dispense_id})`, 'success');
                            this.showEmergencyReasonModal = false;
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`緊急領用失敗: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('緊急領用錯誤:', error);
                        this.toast('緊急領用失敗，請稍後再試', 'error');
                    }
                },

                // 開啟藥師審核 Modal
                openPharmacistApproval(dispense) {
                    this.selectedDispenseForApproval = dispense;
                    this.pharmacistApprovalForm.dispenseId = dispense.id;
                    this.showPharmacistApprovalModal = true;
                },

                // 藥師審核確認
                async submitPharmacistApproval() {
                    if (!this.pharmacistApprovalForm.approvedBy) {
                        this.toast('請輸入藥師姓名', 'error');
                        return;
                    }

                    if (!this.pharmacistApprovalForm.pinCode) {
                        this.toast('請輸入 PIN 碼', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/approve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dispenseId: this.pharmacistApprovalForm.dispenseId,
                                approvedBy: this.pharmacistApprovalForm.approvedBy,
                                pharmacistNotes: this.pharmacistApprovalForm.pharmacistNotes || null,
                                pinCode: this.pharmacistApprovalForm.pinCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const wasEmergency = this.selectedDispenseForApproval?.status === 'EMERGENCY';
                            this.toast(wasEmergency ? '緊急領用已確認' : '領用審核通過，已扣除庫存', 'success');
                            this.showPharmacistApprovalModal = false;
                            this.resetPharmacistApprovalForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            if (response.status === 401) {
                                this.toast('PIN 碼錯誤，拒絕審核', 'error');
                            } else {
                                this.toast(`審核失敗: ${data.detail}`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('藥師審核錯誤:', error);
                        this.toast('藥師審核失敗，請稍後再試', 'error');
                    }
                },

                // 重置領用表單
                resetDispenseForm() {
                    this.dispenseForm = {
                        medicineCode: '',
                        quantity: 1,
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        stationCode: 'HC-000000',
                        emergencyReason: ''
                    };
                },

                // 重置藥師審核表單
                resetPharmacistApprovalForm() {
                    this.pharmacistApprovalForm = {
                        dispenseId: null,
                        approvedBy: '',
                        pharmacistNotes: '',
                        pinCode: ''
                    };
                    this.selectedDispenseForApproval = null;
                },

                // === 批次領用功能 (Batch Dispense) ===
                addBatchDispenseItem() {
                    this.batchDispenseForm.items.push({
                        medicineCode: '',
                        medicineName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchDispenseItem(index) {
                    this.batchDispenseForm.items.splice(index, 1);
                },

                filterBatchDispenseItems(index) {
                    const item = this.batchDispenseForm.items[index];
                    const searchText = item.searchText.toLowerCase();

                    // 只顯示藥品 (medicines) - 一般物品應該透過處置消耗流程
                    const medicineItems = this.items.filter(i => i.category === '藥品');

                    if (!searchText) {
                        item.filteredItems = medicineItems;
                    } else {
                        item.filteredItems = medicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectBatchDispenseItem(index, selectedItem) {
                    const item = this.batchDispenseForm.items[index];
                    item.medicineCode = selectedItem.code;
                    item.medicineName = selectedItem.name;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                async submitBatchDispense() {
                    try {
                        if (this.batchDispenseForm.items.length === 0) {
                            this.toast('請至少新增一筆藥品', 'error');
                            return;
                        }

                        if (!this.batchDispenseForm.dispensedBy) {
                            this.toast('請輸入領藥人', 'error');
                            return;
                        }

                        // 如果是緊急領用，需要檢查緊急原因
                        if (this.batchDispenseForm.isEmergency) {
                            if (!this.batchDispenseForm.emergencyReason || this.batchDispenseForm.emergencyReason.length < 5) {
                                this.toast('緊急原因必須至少5個字', 'error');
                                return;
                            }
                        }

                        // 批次提交每個藥品領用
                        let successCount = 0;
                        let failCount = 0;
                        const endpoint = this.batchDispenseForm.isEmergency ? 'emergency' : 'normal';

                        for (const item of this.batchDispenseForm.items) {
                            try {
                                const requestBody = {
                                    medicineCode: item.medicineCode,
                                    quantity: item.quantity,
                                    dispensedBy: this.batchDispenseForm.dispensedBy,
                                    patientRefId: this.batchDispenseForm.patientRefId || null,
                                    patientName: this.batchDispenseForm.patientName || null,
                                    stationCode: this.batchDispenseForm.stationCode
                                };

                                // 緊急領用需要加上緊急原因
                                if (this.batchDispenseForm.isEmergency) {
                                    requestBody.emergencyReason = this.batchDispenseForm.emergencyReason;
                                }

                                const response = await fetch(`${this.apiUrl}/pharmacy/dispense/${endpoint}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                    const data = await response.json();
                                    console.error(`${item.medicineName} 領用失敗:`, data.detail);
                                }
                            } catch (error) {
                                failCount++;
                                console.error(`${item.medicineName} 領用失敗:`, error);
                            }
                        }

                        // 顯示結果
                        if (failCount === 0) {
                            const message = this.batchDispenseForm.isEmergency
                                ? `成功緊急領用 ${successCount} 項藥品，已立即扣除庫存`
                                : `成功送出 ${successCount} 項領用請求，等待藥師審核`;
                            this.toast(message, 'success');
                            this.resetBatchDispenseForm();
                            this.showEmergencyReasonModal = false;
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`成功 ${successCount} 項，失敗 ${failCount} 項`, 'warning');
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('批次領用失敗:', error);
                        this.toast('批次領用失敗', 'error');
                    }
                },

                resetBatchDispenseForm() {
                    this.batchDispenseForm = {
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        items: [],
                        stationCode: this.stationId,
                        isEmergency: false,
                        emergencyReason: ''
                    };
                },

                // 格式化位元組大小
                formatBytes(bytes) {
                    if (!bytes) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
            };
        }
    </script>
</body>
</html>
