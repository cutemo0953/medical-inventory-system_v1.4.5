<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÜ´ÁôÇÁ´ôÂ∫´Â≠òÁÆ°ÁêÜÁ≥ªÁµ± v1.4.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Ëá™ÂÆöÁæ©Ëâ≤Á≥ªÈÖçÁΩÆ
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal-custom': {
                            500: '#205555',
                            600: '#194444',
                            700: '#123333',
                            50: '#e6f2f2',
                        },
                        'teal-variant': {
                            900: '#224D60',
                            800: '#205555',
                            700: '#2C7471',
                            600: '#286768',
                            500: '#83D4D2',
                            100: '#D5EEEE',
                        },
                        'treatment': {
                            500: '#4E5488',
                            50: '#F3F2F8',
                        },
                        'blood': {
                            600: '#B85D42',
                            500: '#CC7251',
                            200: '#F6CCCD',
                            50: '#FDF5F5',
                        },
                        'claude-red': {
                            500: '#D96754',
                            600: '#C4564A',
                        },
                        'equipment': {
                            500: '#6C7362',
                        },
                        'sky-custom': {
                            600: '#245FA7',
                            500: '#5B9BD5',
                        },
                        'dispense-purple': {
                            900: '#371e7e',
                            700: '#7e2e83',
                            500: '#9cacb5',
                            50: '#f5f3f9',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* Ê∑∫ teal ËÉåÊôØÊº∏ËÆä */
        body {
            background: linear-gradient(135deg, #f0f9f8 0%, #e6f7f5 25%, #f5f8ff 50%, #faf5ff 75%, #fff 100%);
            background-attachment: fixed;
        }

        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ù */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ë°®Ê†ºÊñëÈ¶¨Á¥ãÂÑ™Âåñ */
        .table-hover tbody tr:hover {
            background-color: #f0f9ff;
            transition: background-color 0.2s;
        }

        /* ÈüøÊáâÂºèÁµ±Ë®àÂç°ÁâáÂÑ™Âåñ */
        @media (max-width: 640px) {
            .stat-card {
                height: 6rem;
                padding: 0.75rem;
            }
            .stat-card .text-2xl {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="medicalInventory()" x-init="init()" x-cloak class="w-full max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6">

        <!-- DEBUG: Always visible status bar -->
        <div style="position: fixed; top: 0; right: 0; background: yellow; color: black; padding: 10px; z-index: 9999; font-size: 12px; font-family: monospace;">
            üêõ DEBUG<br>
            currentTab: <strong x-text="currentTab"></strong><br>
            bloodInventory: <strong x-text="bloodInventory.length"></strong> items<br>
            equipment: <strong x-text="equipment.length"></strong> items<br>
            Tab === 'blood': <strong x-text="currentTab === 'blood' ? 'TRUE' : 'FALSE'"></strong>
        </div>

        <!-- Header -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between flex-wrap gap-3 sm:gap-4">
                <div class="flex items-center gap-2 sm:gap-3 md:gap-4">
                    <!-- Âè§ÈôµLogo -->
                    <img src="/static/guling_logo.png" alt="De Novo Orthopedics Logo" class="h-10 sm:h-12 md:h-16 w-auto object-contain flex-shrink-0">

                    <div class="border-l border-gray-300 pl-2 sm:pl-3 md:pl-4">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-1 sm:gap-2">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            ÈÜ´ÁôÇÁ´ôÂ∫´Â≠òÁ≥ªÁµ±
                        </h1>
                        <p class="text-xs sm:text-sm text-gray-500">v1.4.5 - Heroicons ÈáçÊßãÁâà</p>
                        <div class="hidden sm:flex items-center gap-2 mt-1 text-xs text-gray-400">
                            <span class="font-medium">Designed in Taiwan</span>
                            <span>‚Ä¢</span>
                            <span>De Novo Orthopedics Inc</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs sm:text-sm text-gray-600">
                        Á´ôÈªû: <span class="font-semibold text-teal-600" x-text="stationId + ' - ' + stationName"></span>
                        <span class="text-xs text-gray-500" x-show="stationType" x-text="' (' + getStationTypeName() + ')'"></span>
                    </p>
                    <p class="text-xs text-gray-400">
                        <span x-text="currentTime"></span>
                        <a href="/setup" class="ml-2 text-teal-600 hover:text-teal-700 underline">ÈáçÊñ∞Ë®≠ÂÆö</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Áµ±Ë®àÂç°Áâá -->
        <!-- Á≤æÁ∞°Áµ±Ë®àÂç°Áâá - ÁÅ∞ÈöéÈÖçËâ≤ -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 mb-4">
            <!-- Á∏ΩÁâ©ÂìÅÊï∏ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">Á∏ΩÁâ©ÂìÅÊï∏</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.totalItems"></p>
                    </div>
                </div>
            </div>

            <!-- Â∫´Â≠òË≠¶Êàí -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">Â∫´Â≠òË≠¶Êàí</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.lowStockItems"></p>
                    </div>
                </div>
            </div>

            <!-- Ë°ÄË¢ãÂ∫´Â≠ò -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">Ë°ÄË¢ãÂ∫´Â≠ò</p>
                        <p class="text-lg font-bold text-gray-700"><span x-text="stats.totalBlood"></span> U</p>
                    </div>
                </div>
            </div>

            <!-- ÂæÖÁ¢∫Ë™çË®≠ÂÇô -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">ÂæÖÁ¢∫Ë™çË®≠ÂÇô</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.equipmentAlerts"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂàÜÈ†ÅÈÅ∏ÂñÆ - Ê∑±Ëâ≤Â∫ïÁôΩÂ≠ó -->
        <div class="bg-white rounded-xl shadow mb-4 sm:mb-6">
            <div class="grid grid-cols-2 sm:flex sm:flex-nowrap gap-1.5 sm:gap-2 p-1.5 sm:p-2">
                <!-- Áâ©ÂìÅÊü•Ë©¢ - TealËâ≤Á≥ª -->
                <button @click="switchTab('items')"
                        :class="currentTab === 'items' ? 'bg-teal-custom-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">Áâ©ÂìÅÊü•Ë©¢</span>
                </button>

                <!-- ÈÄ≤Ë≤®ÁôªË®ò - Â§©ËóçËâ≤Á≥ª -->
                <button @click="switchTab('receive')"
                        :class="currentTab === 'receive' ? 'bg-sky-custom-600 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">ÈÄ≤Ë≤®ÁôªË®ò</span>
                </button>

                <!-- ËôïÁΩÆ - ËôïÁΩÆËâ≤Á≥ª #4E5488 -->
                <button @click="switchTab('treatment')"
                        :class="currentTab === 'treatment' ? 'bg-treatment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">ËôïÁΩÆ</span>
                </button>

                <!-- Ë°ÄË¢ãÁÆ°ÁêÜ - Ë°ÄÂ∫´Ëâ≤Á≥ª #D96754 -->
                <button @click="switchTab('blood')"
                        :class="currentTab === 'blood' ? 'bg-blood-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">Ë°ÄË¢ãÁÆ°ÁêÜ</span>
                </button>

                <!-- Ë®≠ÂÇôÁÆ°ÁêÜ - Ë®≠ÂÇôËâ≤Á≥ª #6C7362 -->
                <button @click="switchTab('equipment')"
                        :class="currentTab === 'equipment' ? 'bg-equipment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">Ë®≠ÂÇôÁÆ°ÁêÜ</span>
                </button>

                <!-- ÂêåÊ≠•ÁÆ°ÁêÜ - TealËâ≤Á≥ªÔºàËÅØÈÇ¶Êû∂ÊßãÔºâ -->
                <button @click="switchTab('sync')"
                        :class="currentTab === 'sync' ? 'bg-teal-custom-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="col-span-2 sm:col-span-1 flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span class="text-xs sm:text-sm truncate">ÂêåÊ≠•ÁÆ°ÁêÜ</span>
                </button>
            </div>
        </div>

        <!-- Áâ©ÂìÅÊü•Ë©¢ÂàÜÈ†Å -->
        <div x-show="currentTab === 'items'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    Â∫´Â≠òÊü•Ë©¢
                </h2>
                <div class="flex gap-2">
                    <button @click="showAddItemModal = true" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Êñ∞Â¢ûÁâ©ÂìÅ</span>
                    </button>
                    <button @click="loadItems()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>
            </div>

            <!-- ÊêúÂ∞ãÊ°ÜÂíåÂåØÂá∫ÊåâÈàï -->
            <div class="mb-4 flex gap-4 items-end flex-wrap sm:flex-nowrap">
                <div class="flex-1 w-full sm:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        ÊêúÂ∞ãÁâ©ÂìÅ
                    </label>
                    <input type="text" x-model="itemSearchText" @input="filterItems()" placeholder="Ëº∏ÂÖ•‰ª£Á¢ºÊàñÂêçÁ®±ÊêúÂ∞ã..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                </div>
                <div class="flex gap-2">
                    <button @click.prevent.stop="exportInventoryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>CSV</span>
                    </button>
                    <button @click.prevent.stop="exportInventoryJSON()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>JSON</span>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‰ª£Á¢º</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂêçÁ®±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂàÜÈ°û</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Â∫´Â≠ò</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÊúÄÂ∞èÂ∫´Â≠ò</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂñÆ‰Ωç</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="item in filteredItems" :key="item.code">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="item.code"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="item.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-teal-variant-100 text-teal-variant-700" x-text="item.category"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'" 
                                          x-text="item.current_stock"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.min_stock"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="item.unit"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button @click="editItem(item)" class="text-teal-custom-500 hover:text-teal-custom-600">Á∑®ËºØ</button>
                                    <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÈÄ≤Ë≤®ÂàÜÈ†Å -->
        <div x-show="currentTab === 'receive'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-custom-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    ÈÄ≤Ë≤®ÁôªË®ò
                </h2>
                <button @click.prevent.stop="showReceiveHistoryModal = true; loadReceiveHistory()" class="bg-sky-custom-600 text-white px-4 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Êü•ÁúãÈÄ≤Ë≤®Ë®òÈåÑ</span>
                </button>
            </div>

            <form @submit.prevent="submitReceive()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º * (ÂèØÊêúÂ∞ã)</label>
                        <input
                            type="text"
                            x-model="receiveItemSearch"
                            @input="filterReceiveItems()"
                            @focus="showReceiveDropdown = true; if (filteredReceiveItems.length === 0) filterReceiveItems();"
                            @blur="setTimeout(() => showReceiveDropdown = false, 200)"
                            placeholder="Ëº∏ÂÖ•‰ª£Á¢ºÊàñÂêçÁ®±ÊêúÂ∞ã..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"
                        >
                        <div x-show="showReceiveDropdown && filteredReceiveItems.length > 0" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <template x-for="item in filteredReceiveItems.slice(0, 10)" :key="item.code">
                                <div @click.stop="selectReceiveItem(item)" class="px-4 py-2 hover:bg-sky-100 cursor-pointer">
                                    <span class="font-mono text-sm" x-text="item.code"></span> -
                                    <span x-text="item.name"></span>
                                    <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${item.current_stock})`"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè *</label>
                        <input type="number" x-model="receiveForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊâπËôü</label>
                        <input type="text" x-model="receiveForm.batchNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊïàÊúü</label>
                        <input type="date" x-model="receiveForm.expiryDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="receiveForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-sky-custom-600 text-white px-6 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>Á¢∫Ë™çÈÄ≤Ë≤®</span>
                    </button>
                    <button type="button" @click="resetReceiveForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÁΩÆ</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- ËôïÁΩÆÂàÜÈ†Å (Êï¥ÂêàÊâãË°ìË®òÈåÑ + ‰∏ÄËà¨Ê∂àËÄó) -->
        <div x-show="currentTab === 'treatment'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <!-- Ê®ôÈ°åËàáÊ®°ÂºèÂàáÊèõ -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ËôïÁΩÆÁÆ°ÁêÜ
                </h2>

                <!-- Â∑¶ÂÅ¥ÂàáÊèõÊåâÈàï -->
                <div class="flex gap-2 flex-wrap">
                    <button @click="treatmentMode = 'surgery'"
                            :class="treatmentMode === 'surgery' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span>ËôïÁΩÆË®òÈåÑ</span>
                    </button>
                    <button @click="treatmentMode = 'consume'"
                            :class="treatmentMode === 'consume' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <span>‰∏ÄËà¨Ê∂àËÄó</span>
                    </button>
                    <button @click="treatmentMode = 'dispense'; loadPendingDispenses()"
                            :class="treatmentMode === 'dispense' ? 'bg-dispense-purple-700 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <span>Ëó•ÂìÅÈ†òÁî®</span>
                    </button>
                </div>
            </div>

            <!-- ËôïÁΩÆË®òÈåÑÊ®°Âºè (ÊâãË°ìË®òÈåÑ) -->
            <div x-show="treatmentMode === 'surgery'">
                <div class="flex flex-wrap gap-2 mb-4">
                    <button @click.prevent.stop="ensureItemsLoaded(); showAddSurgeryModal = true" class="bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Êñ∞Â¢ûËôïÁΩÆË®òÈåÑ</span>
                    </button>
                    <button @click.prevent.stop="exportSurgeryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>ÂåØÂá∫ CSV</span>
                    </button>
                    <button @click.prevent.stop="loadSurgeryRecords()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>

                <!-- ÊêúÂ∞ãÁØ©ÈÅ∏ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="surgerySearchForm.startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="surgerySearchForm.endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁóÖÊÇ£ÂßìÂêç</label>
                        <input type="text" x-model="surgerySearchForm.patientName" placeholder="ÊêúÂ∞ãÁóÖÊÇ£..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table-hover">
                        <thead class="bg-treatment-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ë®òÈåÑÁ∑®Ëôü</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êó•Êúü</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÁóÖÊÇ£ÂßìÂêç</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ËôïÁΩÆÈ°ûÂûã</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‰∏ªÂàÄÈÜ´Â∏´</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÊôÇÈï∑(ÂàÜ)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in surgeryRecords" :key="record.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="record.record_number"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.record_date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.patient_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgery_type"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgeon_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.duration_minutes || '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewSurgeryDetail(record)" class="text-treatment-500 hover:text-[#3d4270] font-medium">Ë©≥ÊÉÖ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ‰∏ÄËà¨Ê∂àËÄóÊ®°Âºè -->
            <div x-show="treatmentMode === 'consume'">
                <div class="mb-4 flex justify-between items-center">
                    <button @click.prevent.stop="showConsumeHistoryModal = true; loadConsumeHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>Êü•ÁúãÊ∂àËÄóË®òÈåÑ</span>
                    </button>
                </div>

                <form @submit.prevent="submitBatchConsume()" class="space-y-4">
                    <!-- Ê∂àËÄóÂéüÂõ†ÔºàÊï¥ÊâπÂÖ±Áî®Ôºâ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∂àËÄóÂéüÂõ† *</label>
                        <textarea x-model="batchConsumeForm.purpose" required rows="2"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500 focus:border-transparent"></textarea>
                    </div>

                    <!-- ËÄóÊùêÊ∏ÖÂñÆ -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                Ê∂àËÄóÂìÅÈ†Ö
                            </h4>
                            <button type="button" @click="addBatchConsumeItem()"
                                    class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûÂìÅÈ†Ö
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in batchConsumeForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- ÊêúÂ∞ãËº∏ÂÖ•Ê°ÜÔºà‰ΩøÁî® relative divÔºâ -->
                                        <div class="relative col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterBatchConsumeItems(index)"
                                                @focus="filterBatchConsumeItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="ÊêúÂ∞ãÁâ©ÂìÅ..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.item_code">
                                                    <div @click.stop="selectBatchConsumeItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.item_code"></span> -
                                                        <span x-text="availableItem.item_name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Êï∏ÈáèËº∏ÂÖ•Ê°Ü -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                    </div>

                                    <!-- Âà™Èô§ÊåâÈàï -->
                                    <button type="button" @click="removeBatchConsumeItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="batchConsumeForm.items.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûÊ∂àËÄóÂìÅÈ†Ö
                        </div>
                    </div>

                    <!-- Êèê‰∫§ÊåâÈàï -->
                    <div class="flex gap-4">
                        <button type="submit" class="bg-treatment-500 text-white px-6 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊ∂àËÄó</span>
                        </button>
                        <button type="button" @click="resetBatchConsumeForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>ÈáçÁΩÆ</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Ëó•ÂìÅÈ†òÁî®Ê®°Âºè (MIRS v2.3 - Emergency Dispense) -->
            <div x-show="treatmentMode === 'dispense'">
                <div class="flex justify-end mb-4">
                    <button @click.prevent.stop="loadPendingDispenses()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>

                <!-- Á∑äÊÄ•È†òÁî®Ë≠¶Á§∫ (Â¶ÇÊûúÊúâÂæÖÁ¢∫Ë™çÁöÑÁ∑äÊÄ•È†òÁî®) -->
                <div x-show="pendingDispenses.filter(d => d.status === 'EMERGENCY').length > 0" class="mb-4 p-4 bg-dispense-purple-50 border-l-4 border-dispense-purple-700 rounded">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-dispense-purple-700 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-dispense-purple-900">Á∑äÊÄ•È†òÁî®ÂæÖÁ¢∫Ë™ç</p>
                        <p class="text-sm text-gray-600 mt-1">
                            Êúâ <span class="font-bold text-dispense-purple-700" x-text="pendingDispenses.filter(d => d.status === 'EMERGENCY').length"></span> Á≠ÜÁ∑äÊÄ•È†òÁî®ÈúÄË¶ÅËó•Â∏´Á¢∫Ë™ç
                        </p>
                    </div>
                </div>
            </div>

                <!-- Ëó•ÂìÅÈ†òÁî®Ë°®ÂñÆ (ÊâπÊ¨°) -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    È†òÁî®ÁôªË®ò
                </h3>
                <form @submit.prevent="submitBatchDispense()" class="space-y-4">
                    <!-- Âü∫Êú¨Ë≥áË®äÔºàÊï¥ÊâπÂÖ±Áî®Ôºâ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- È†òËó•‰∫∫ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> È†òËó•‰∫∫
                            </label>
                            <input type="text" x-model="batchDispenseForm.dispensedBy" required placeholder="Ë≠∑ÁêÜÂ∏´-ÁéãÂ∞èÁæé" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>

                        <!-- ÁóÖÊÇ£Á∑®Ëôü (ÈÅ∏Â°´) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ÁóÖÊÇ£Á∑®Ëôü (ÈÅ∏Â°´)
                            </label>
                            <input type="text" x-model="batchDispenseForm.patientRefId" placeholder="Triage Tag ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>

                        <!-- ÁóÖÊÇ£ÂßìÂêç (ÈÅ∏Â°´) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ÁóÖÊÇ£ÂßìÂêç (ÈÅ∏Â°´)
                            </label>
                            <input type="text" x-model="batchDispenseForm.patientName" placeholder="Âºµ‰∏â" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>
                    </div>

                    <!-- Ëó•ÂìÅÊ∏ÖÂñÆ -->
                    <div class="border-2 border-dispense-purple-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                Ëó•ÂìÅÊ∏ÖÂñÆ
                            </h4>
                            <button type="button" @click="addBatchDispenseItem()"
                                    class="bg-dispense-purple-700 text-white px-3 py-1 rounded-lg hover:bg-dispense-purple-900 text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûËó•ÂìÅ
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in batchDispenseForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- ÊêúÂ∞ãËº∏ÂÖ•Ê°Ü -->
                                        <div class="relative col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterBatchDispenseItems(index)"
                                                @focus="item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="ÊêúÂ∞ãËó•ÂìÅ..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-dispense-purple-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectBatchDispenseItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-dispense-purple-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Êï∏ÈáèËº∏ÂÖ•Ê°Ü -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                    </div>

                                    <!-- Âà™Èô§ÊåâÈàï -->
                                    <button type="button" @click="removeBatchDispenseItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="batchDispenseForm.items.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûËó•ÂìÅ
                        </div>
                    </div>

                    <!-- ÊåâÈàïÁµÑ -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-2">
                        <!-- Ê≠£Â∏∏È†òÁî® (ÁÅ∞Ëâ≤) -->
                        <button type="button" @click="batchDispenseForm.isEmergency = false; submitBatchDispense()"
                                class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>ÈÄÅÂá∫ÂØ©Ê†∏ (Ê≠£Â∏∏ÊµÅÁ®ã)</span>
                        </button>

                        <!-- Á∑äÊÄ•È†òÁî® (Á¥´Ëâ≤) -->
                        <button type="button" @click="showEmergencyReasonModal = true"
                                class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>Á∑äÊÄ•È†òÁî® (Break-the-Glass)</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆ (Ëó•Â∏´ÂØ©Ê†∏ÂçÄ) -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    ÂæÖËôïÁêÜÈ†òÁî® (Ëó•Â∏´ÂØ©Ê†∏)
                </h3>

                <div x-show="pendingDispenses.length === 0" class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>ÁõÆÂâçÊ≤íÊúâÂæÖËôïÁêÜÁöÑÈ†òÁî®Ë®òÈåÑ</p>
                </div>

                <div x-show="pendingDispenses.length > 0" class="space-y-3">
                    <template x-for="dispense in pendingDispenses" :key="dispense.id">
                        <div class="bg-white rounded-lg p-4 shadow-sm border" :class="dispense.status === 'EMERGENCY' ? 'border-dispense-purple-700 bg-dispense-purple-50' : 'border-gray-200'">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 rounded text-xs font-semibold"
                                              :class="dispense.status === 'EMERGENCY' ? 'bg-dispense-purple-700 text-white' : 'bg-yellow-500 text-white'"
                                              x-text="dispense.status === 'EMERGENCY' ? 'Á∑äÊÄ•È†òÁî®' : 'ÂæÖÂØ©Ê†∏'"></span>
                                        <span class="text-xs text-gray-500" x-text="`${dispense.hours_pending || 0} Â∞èÊôÇÂâç`"></span>
                                    </div>
                                    <p class="font-semibold text-gray-800" x-text="`${dispense.medicine_code} - ${dispense.medicine_name}`"></p>
                                    <p class="text-sm text-gray-600">Êï∏Èáè: <span class="font-semibold" x-text="dispense.quantity"></span> <span x-text="dispense.unit"></span></p>
                                    <p class="text-sm text-gray-600">È†òËó•‰∫∫: <span class="font-semibold" x-text="dispense.dispensed_by"></span></p>
                                    <p x-show="dispense.patient_name" class="text-sm text-gray-600">ÁóÖÊÇ£: <span x-text="dispense.patient_name"></span></p>
                                    <p x-show="dispense.emergency_reason" class="text-sm text-dispense-purple-900 mt-2 font-medium">
                                        Á∑äÊÄ•ÂéüÂõ†: <span x-text="dispense.emergency_reason"></span>
                                    </p>
                                </div>
                                <div class="flex items-center">
                                    <button @click="openPharmacistApproval(dispense)" class="bg-dispense-purple-700 text-white px-4 py-2 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        <span>Ëó•Â∏´Á¢∫Ë™ç</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Ë°ÄË¢ãÂàÜÈ†Å -->
        <!-- CHANGED: x-show to style binding to force reactivity -->
        <div :style="currentTab === 'blood' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <!-- DEBUG: Show if this container is visible -->
            <div x-init="console.log('üîç Blood tab container rendered! currentTab:', currentTab, 'bloodInventory length:', bloodInventory.length)" style="display:none;"></div>
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    Ë°ÄÂ∫´ÁÆ°ÁêÜ
                    <!-- DEBUG: Show blood inventory count -->
                    <span class="text-sm text-red-600 font-normal">
                        (DEBUG: <span x-text="bloodInventory.length"></span> items, Tab: <span x-text="currentTab"></span>)
                    </span>
                </h2>
                <button @click.prevent.stop="showBloodHistoryModal = true; loadBloodHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Ê≠∑Âè≤Ë®òÈåÑ</span>
                </button>
            </div>

            <!-- Ë°ÄÂûãÂ∫´Â≠òÁµ±Ë®àÂçÄ - Ê∑±Á¥ÖËâ≤ËÉåÊôØ -->
            <div class="bg-gradient-to-br from-red-900 to-red-950 rounded-xl p-6 mb-8 shadow-xl">
                <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Ë°ÄÂûãÂ∫´Â≠òÁµ±Ë®à
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3">
                    <!-- DEBUG: Before template -->
                    <div x-show="bloodInventory.length === 0" class="col-span-full text-center text-white p-4 bg-red-900 rounded">
                        ‚ö†Ô∏è DEBUG: bloodInventory is empty! Length: <span x-text="bloodInventory.length"></span>
                    </div>
                    <template x-for="blood in bloodInventory" :key="blood.blood_type">
                        <div class="bg-red-800 bg-opacity-50 backdrop-blur rounded-lg p-4 border border-red-700 hover:border-red-500 transition-all duration-200 hover:shadow-lg"
                             x-init="console.log('ü©∏ Rendering blood card:', blood.blood_type, blood.quantity)">
                            <div class="text-center">
                                <!-- Ë°ÄÂûãÊ®ôÁ±§ -->
                                <div class="text-sm font-bold text-red-100 mb-2" x-text="blood.blood_type"></div>
                                <!-- Êï∏ÈáèÂ§ßÂ≠óÈ°ØÁ§∫ - Èùû0ÁôΩËâ≤Ôºå0Ê∑∫ÁÅ∞Ëâ≤ -->
                                <div class="text-4xl font-extrabold mb-1"
                                     :class="blood.quantity > 0 ? 'text-white' : 'text-gray-400'"
                                     x-text="blood.quantity"></div>
                                <div class="text-xs text-red-200">Ë¢ã</div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- ÂäüËÉΩÂçÄ - Ê∑∫Ëâ≤È¢®Ê†ºÔºåÁµ±‰∏Ä red Ëâ≤Á≥ª -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ë°ÄË¢ãÂÖ•Â∫´ -->
                <div class="bg-white border-2 border-red-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Ë°ÄË¢ãÂÖ•Â∫´
                    </h3>
                    <form @submit.prevent="submitBloodReceive()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÂûã *</label>
                                <select x-model="bloodReceiveForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">ÈÅ∏ÊìáË°ÄÂûã</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êï∏Èáè (U) *</label>
                                <input type="number" x-model="bloodReceiveForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- ‰æÜÊ∫êÈÅ∏Êìá -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÊ∂≤‰æÜÊ∫ê</label>
                            <select x-model="bloodReceiveForm.source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="blood_center">ÊçêË°Ä‰∏≠ÂøÉ</option>
                                <option value="walking_donor">Walking Blood Bank (Á∑äÊÄ•ÊçêË°ÄËÄÖ)</option>
                            </select>
                        </div>

                        <!-- Walking Blood Bank Ë≥áË®ä (Ê¢ù‰ª∂È°ØÁ§∫) -->
                        <div x-show="bloodReceiveForm.source === 'walking_donor'" class="col-span-2 border-t border-red-200 pt-3 space-y-2">
                            <div class="text-sm font-medium text-red-700 flex items-center gap-1 mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Á∑äÊÄ•ÊçêË°ÄËÄÖË≥áË®ä
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÊçêË°ÄËÄÖÂßìÂêç</label>
                                    <input type="text" x-model="bloodReceiveForm.donorName"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="ÈÅ∏Â°´">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ËÅØÁµ°ÈõªË©±</label>
                                    <input type="tel" x-model="bloodReceiveForm.donorPhone"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="ÈÅ∏Â°´">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÂÇôË®ª</label>
                            <input type="text" x-model="bloodReceiveForm.remarks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÊâπËôü„ÄÅ‰æÜÊ∫êÁ≠â">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="submit" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Á¢∫Ë™çÂÖ•Â∫´</span>
                            </button>
                            <button type="button" @click="printBloodLabel()" class="bg-white text-claude-red-500 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors flex items-center justify-center gap-2 border-2 border-claude-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                </svg>
                                <span>ÂàóÂç∞Ê®ôÁ±§</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Ë°ÄË¢ãÂá∫Â∫´ (Âê´ÁóÖÊÇ£Ë≥áË®ä) -->
                <div class="border-2 border-red-200 rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        Ë°ÄË¢ãÂá∫Â∫´
                    </h3>
                    <form @submit.prevent="submitBloodConsume()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÂûã *</label>
                                <select x-model="bloodConsumeForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">ÈÅ∏ÊìáË°ÄÂûã</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êï∏Èáè (U) *</label>
                                <input type="number" x-model="bloodConsumeForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>
                        <!-- ÁóÖÊÇ£Ë≥áË®ä -->
                        <div class="border-t border-red-200 pt-3 space-y-3">
                            <div class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                ÁóÖÊÇ£Ë≥áË®ä
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ÁóÖÊÇ£ÂßìÂêç *</label>
                                <input type="text" x-model="bloodConsumeForm.patientName" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Ë´ãËº∏ÂÖ•ÁóÖÊÇ£ÂßìÂêç">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ÁóÖÊ≠∑Ëôü</label>
                                <input type="text" x-model="bloodConsumeForm.patientId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÈÅ∏Â°´">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Áî®ÈÄîË™™Êòé</label>
                                <textarea x-model="bloodConsumeForm.purpose" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÊâãË°ì„ÄÅÁ∑äÊÄ•Ëº∏Ë°ÄÁ≠â"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÂá∫Â∫´</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <!-- CHANGED: x-show to style binding for equipment tab -->
        <div :style="currentTab === 'equipment' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Ë®≠ÂÇôÁÆ°ÁêÜ
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button @click="showAddEquipmentModal = true" class="bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Êñ∞Â¢ûË®≠ÂÇô</span>
                    </button>
                    <button @click="loadEquipment()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>
            </div>

            <!-- Ëá™ÂãïÂà∑Êñ∞ÊèêÁ§∫ -->
            <div class="mb-4 p-3 bg-equipment-500 bg-opacity-10 rounded-lg flex items-center gap-2 text-sm text-gray-700">
                <svg class="w-5 h-5 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Ë®≠ÂÇôÁãÄÊÖãÂ∞áÊñºÊØèÊó• <strong class="text-equipment-500">07:00am</strong> Ëá™ÂãïÈáçÁΩÆÁÇ∫ÂæÖÊ™¢Êü•</span>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ë®≠ÂÇôID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂêçÁ®±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÁãÄÊÖã</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂàÜÈ°û</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êï∏Èáè</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÈõªÂäõ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÊúÄÂæåÊ™¢Êü•</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="eq in equipment" :key="eq.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="eq.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900" x-text="eq.name"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="{
                                        'bg-green-100 text-green-800': eq.status === 'NORMAL',
                                        'bg-yellow-100 text-yellow-800': eq.status === 'WARNING',
                                        'bg-red-100 text-red-800': eq.status === 'ERROR',
                                        'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED'
                                    }" class="px-2 py-1 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700" x-text="eq.category"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="eq.quantity"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-show="eq.power_level !== null" x-text="eq.power_level + '%'"></span>
                                    <span x-show="eq.power_level === null" class="text-gray-400">-</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                    <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] font-medium">Ê™¢Êü•</button>
                                    <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 font-medium">Á∑®ËºØ</button>
                                    <button @click="deleteEquipment(eq.id, eq.name)" class="text-red-600 hover:text-red-800 font-medium">Âà™Èô§</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Êñ∞Â¢ûÁâ©ÂìÅ Modal -->
        <div x-show="showAddItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showAddItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Êñ∞Â¢ûÁâ©ÂìÅ
                </h3>
                <form @submit.prevent="submitAddItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º (ÁïôÁ©∫Ëá™ÂãïÁîüÊàê)</label>
                        <input type="text" x-model="addItemForm.code" placeholder="ÁïôÁ©∫Â∞áËá™ÂãïÁîüÊàê" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅÂêçÁ®± *</label>
                        <input type="text" x-model="addItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="addItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                            <option value="ÊâãË°ìËÄóÊùê">ÊâãË°ìËÄóÊùê</option>
                            <option value="ÊÄ•ÊïëÁâ©Ë≥á">ÊÄ•ÊïëÁâ©Ë≥á</option>
                            <option value="Ëó•ÂìÅ">Ëó•ÂìÅ</option>
                            <option value="Èò≤Ë≠∑Áî®ÂìÅ">Èò≤Ë≠∑Áî®ÂìÅ</option>
                            <option value="ÈÜ´ÁôÇË®≠ÂÇô">ÈÜ´ÁôÇË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="addItemForm.unit" placeholder="EA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊúÄÂ∞èÂ∫´Â≠ò</label>
                        <input type="number" x-model="addItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊñ∞Â¢û</span>
                        </button>
                        <button type="button" @click="showAddItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØÁâ©ÂìÅ Modal -->
        <div x-show="showEditItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEditItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Á∑®ËºØÁâ©ÂìÅ
                </h3>
                <form @submit.prevent="submitEditItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º</label>
                        <input type="text" x-model="editItemForm.code" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅÂêçÁ®± *</label>
                        <input type="text" x-model="editItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="editItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                            <option value="ÊâãË°ìËÄóÊùê">ÊâãË°ìËÄóÊùê</option>
                            <option value="ÊÄ•ÊïëÁâ©Ë≥á">ÊÄ•ÊïëÁâ©Ë≥á</option>
                            <option value="Ëó•ÂìÅ">Ëó•ÂìÅ</option>
                            <option value="Èò≤Ë≠∑Áî®ÂìÅ">Èò≤Ë≠∑Áî®ÂìÅ</option>
                            <option value="ÈÜ´ÁôÇË®≠ÂÇô">ÈÜ´ÁôÇË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="editItemForm.unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊúÄÂ∞èÂ∫´Â≠ò</label>
                        <input type="number" x-model="editItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊõ¥Êñ∞</span>
                        </button>
                        <button type="button" @click="showEditItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Êñ∞Â¢ûË®≠ÂÇô Modal -->
        <div x-show="showAddEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showAddEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Êñ∞Â¢ûË®≠ÂÇô
                </h3>
                <form @submit.prevent="submitAddEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÂêçÁ®± *</label>
                        <input type="text" x-model="addEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="addEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="ÈõªÂäõË®≠ÂÇô">ÈõªÂäõË®≠ÂÇô</option>
                            <option value="Á©∫Ê∞£Ê∑®Âåñ">Á©∫Ê∞£Ê∑®Âåñ</option>
                            <option value="Ê∞¥ËôïÁêÜ">Ê∞¥ËôïÁêÜ</option>
                            <option value="ÂÜ∑ËóèË®≠ÂÇô">ÂÜ∑ËóèË®≠ÂÇô</option>
                            <option value="ÈÄöË®äË®≠ÂÇô">ÈÄöË®äË®≠ÂÇô</option>
                            <option value="ÁÖßÊòéË®≠ÂÇô">ÁÖßÊòéË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè</label>
                        <input type="number" x-model="addEquipmentForm.quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="addEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊñ∞Â¢û</span>
                        </button>
                        <button type="button" @click="showAddEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØË®≠ÂÇô Modal -->
        <div x-show="showEditEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEditEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Á∑®ËºØË®≠ÂÇô
                </h3>
                <form @submit.prevent="submitEditEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôID</label>
                        <input type="text" x-model="editEquipmentForm.id" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÂêçÁ®± *</label>
                        <input type="text" x-model="editEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="editEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="ÈõªÂäõË®≠ÂÇô">ÈõªÂäõË®≠ÂÇô</option>
                            <option value="Á©∫Ê∞£Ê∑®Âåñ">Á©∫Ê∞£Ê∑®Âåñ</option>
                            <option value="Ê∞¥ËôïÁêÜ">Ê∞¥ËôïÁêÜ</option>
                            <option value="ÂÜ∑ËóèË®≠ÂÇô">ÂÜ∑ËóèË®≠ÂÇô</option>
                            <option value="ÈÄöË®äË®≠ÂÇô">ÈÄöË®äË®≠ÂÇô</option>
                            <option value="ÁÖßÊòéË®≠ÂÇô">ÁÖßÊòéË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè</label>
                        <input type="number" x-model="editEquipmentForm.quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="editEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊõ¥Êñ∞</span>
                        </button>
                        <button type="button" @click="showEditEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ë®≠ÂÇôÊ™¢Êü• Modal -->
        <div x-show="showCheckEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showCheckEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Ë®≠ÂÇôÊ™¢Êü•
                </h3>
                <form @submit.prevent="submitCheckEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÂêçÁ®±</label>
                        <input type="text" x-model="checkEquipmentForm.name" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁãÄÊÖã *</label>
                        <select x-model="checkEquipmentForm.status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="NORMAL">Ê≠£Â∏∏ (NORMAL)</option>
                            <option value="WARNING">Ë≠¶Âëä (WARNING)</option>
                            <option value="ERROR">Áï∞Â∏∏ (ERROR)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈõªÂäõÁ≠âÁ¥ö (0-100%)</label>
                        <input type="number" x-model="checkEquipmentForm.powerLevel" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="checkEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊ™¢Êü•</span>
                        </button>
                        <button type="button" @click="showCheckEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Êñ∞Â¢ûËôïÁΩÆË®òÈåÑ Modal -->
        <div x-show="showAddSurgeryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showAddSurgeryModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-2xl w-full mx-4 my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Êñ∞Â¢ûËôïÁΩÆË®òÈåÑ
                </h3>
                <form @submit.prevent="submitAddSurgery()" class="space-y-4">
                    <!-- Âü∫Êú¨Ë≥áË®ä -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁóÖÊÇ£ÂßìÂêç *</label>
                            <input type="text" x-model="addSurgeryForm.patientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ê™¢ÂÇ∑Á∑®Ëôü (Triage Tag ID)</label>
                            <input type="text" x-model="addSurgeryForm.triageTagId" placeholder="‰æãÂ¶Ç: RED-001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ËôïÁΩÆÈ°ûÂûã *</label>
                            <input type="text" x-model="addSurgeryForm.surgeryType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰∏ªÂàÄÈÜ´Â∏´ *</label>
                            <input type="text" x-model="addSurgeryForm.surgeonName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">È∫ªÈÜâÊñπÂºè</label>
                            <input type="text" x-model="addSurgeryForm.anesthesiaType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ËôïÁΩÆÊôÇÈï∑ (ÂàÜÈêò)</label>
                            <input type="number" x-model="addSurgeryForm.durationMinutes" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                    </div>

                    <!-- ÂÇôË®ª -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ËôïÁΩÆÂÇôË®ª
                            <span class="text-xs text-gray-500 font-normal">(ÂèØË®òÈåÑÊ™¢ÂÇ∑Á∑®Ëôü„ÄÅÂÇ∑Âã¢ÁãÄÊ≥ÅÁ≠âË≥áË®ä)</span>
                        </label>
                        <textarea x-model="addSurgeryForm.remarks" rows="3" placeholder="‰æãÂ¶Ç: Ê™¢ÂÇ∑Á∑®Ëôü RED-001, Âè≥ËÖøÈñãÊîæÊÄßÈ™®Êäò..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"></textarea>
                    </div>

                    <!-- ËÄóÊùêÊ∏ÖÂñÆ -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                ‰ΩøÁî®ËÄóÊùê
                            </h4>
                            <button type="button" @click="addConsumptionItem()" class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûËÄóÊùê
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in addSurgeryForm.consumptions" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <div class="relative">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterConsumptionItems(index)"
                                                @focus="filterConsumptionItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="ÊêúÂ∞ãËÄóÊùê..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectConsumptionItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                        <input type="text" x-model="item.unit" readonly placeholder="ÂñÆ‰Ωç" class="px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                    </div>
                                    <button type="button" @click="removeConsumptionItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.consumptions.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûËÄóÊùê
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Á¢∫Ë™çÂª∫Á´ã
                        </button>
                        <button type="button" @click="showAddSurgeryModal = false; resetAddSurgeryForm()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ËôïÁΩÆË©≥ÊÉÖ Modal -->
        <div x-show="showSurgeryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showSurgeryDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    ËôïÁΩÆË®òÈåÑË©≥ÊÉÖ
                </h3>
                
                <template x-if="selectedSurgery">
                    <div class="space-y-4">
                        <!-- Âü∫Êú¨Ë≥áË®ä -->
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">Ë®òÈåÑÁ∑®Ëôü</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_number"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Êó•Êúü</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_date"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ÁóÖÊÇ£ÂßìÂêç</p>
                                <p class="font-semibold" x-text="selectedSurgery.patient_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Áï∂Êó•Á¨¨ N Âè∞</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_sequence"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ËôïÁΩÆÈ°ûÂûã</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_type"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">‰∏ªÂàÄÈÜ´Â∏´</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgeon_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">È∫ªÈÜâÊñπÂºè</p>
                                <p class="font-semibold" x-text="selectedSurgery.anesthesia_type || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ËôïÁΩÆÊôÇÈï∑</p>
                                <p class="font-semibold" x-text="selectedSurgery.duration_minutes ? selectedSurgery.duration_minutes + ' ÂàÜÈêò' : '-'"></p>
                            </div>
                        </div>

                        <!-- ÂÇôË®ª -->
                        <div x-show="selectedSurgery.remarks" class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">ÂÇôË®ª</p>
                            <p class="text-gray-800" x-text="selectedSurgery.remarks"></p>
                        </div>

                        <!-- ËÄóÊùêÊ∏ÖÂñÆ -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                ‰ΩøÁî®ËÄóÊùê
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‰ª£Á¢º</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÂêçÁ®±</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÂñÆ‰Ωç</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="consumption in selectedSurgery.consumptions" :key="consumption.item_code">
                                            <tr>
                                                <td class="px-4 py-2 text-sm font-mono" x-text="consumption.item_code"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.item_name"></td>
                                                <td class="px-4 py-2 text-sm font-semibold" x-text="consumption.quantity"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.unit"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="button" @click="showSurgeryDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                ÈóúÈñâ
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- ÈÄ≤Ë≤®Ë®òÈåÑ Modal -->
        <div x-show="showReceiveHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showReceiveHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        ÈÄ≤Ë≤®Ë®òÈåÑ
                    </h3>
                    <button @click="exportReceiveHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫CSV
                    </button>
                </div>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="receiveHistorySearch.startDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="receiveHistorySearch.endDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º</label>
                        <input type="text" x-model="receiveHistorySearch.itemCode" @input="loadReceiveHistory()" placeholder="ÊêúÂ∞ãÁâ©ÂìÅ..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅ‰ª£Á¢º</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅÂêçÁ®±</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊâπËôü</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊïàÊúü</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÂÇôË®ª</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in receiveHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-green-600" x-text="'+' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.batch_number || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.expiry_date || '-'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showReceiveHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê∂àËÄóË®òÈåÑ Modal -->
        <div x-show="showConsumeHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showConsumeHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Ê∂àËÄóË®òÈåÑ
                    </h3>
                    <button @click="exportConsumeHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫CSV
                    </button>
                </div>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="consumeHistorySearch.startDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="consumeHistorySearch.endDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º</label>
                        <input type="text" x-model="consumeHistorySearch.itemCode" @input="loadConsumeHistory()" placeholder="ÊêúÂ∞ãÁâ©ÂìÅ..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅ‰ª£Á¢º</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅÂêçÁ®±</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áî®ÈÄî</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in consumeHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-red-600" x-text="'-' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewConsumeDetail(event)" class="text-blue-600 hover:text-blue-800">Ë©≥ÊÉÖ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showConsumeHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê∂àËÄóË©≥ÊÉÖ Modal -->
        <div x-show="showConsumeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showConsumeDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Ê∂àËÄóË©≥ÊÉÖ
                </h3>

                <template x-if="selectedConsumeEvent">
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">ÊôÇÈñì</p>
                                <p class="font-semibold" x-text="new Date(selectedConsumeEvent.timestamp).toLocaleString('zh-TW')"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Áâ©ÂìÅ‰ª£Á¢º</p>
                                <p class="font-semibold font-mono" x-text="selectedConsumeEvent.item_code"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Áâ©ÂìÅÂêçÁ®±</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.item_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ê∂àËÄóÊï∏Èáè</p>
                                <p class="font-semibold text-red-600" x-text="selectedConsumeEvent.quantity + ' ' + selectedConsumeEvent.unit"></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-600">Áî®ÈÄîË™™Êòé</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.remarks || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Êìç‰ΩúÂì°</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.operator"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Á´ôÈªû</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.station_id"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="pt-4">
                    <button type="button" @click="showConsumeDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ Modal -->
        <div x-show="showBloodHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto" style="display: none;">
            <div @click.away="showBloodHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ
                </h3>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="bloodHistorySearch.startDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="bloodHistorySearch.endDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÂûã</label>
                        <select x-model="bloodHistorySearch.bloodType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">ÂÖ®ÈÉ®Ë°ÄÂûã</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">È°ûÂûã</label>
                        <select x-model="bloodHistorySearch.eventType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">ÂÖ®ÈÉ®</option>
                            <option value="RECEIVE">ÂÖ•Â∫´</option>
                            <option value="CONSUME">Âá∫Â∫´</option>
                        </select>
                    </div>
                </div>

                <!-- Ê≠∑Âè≤Ë®òÈåÑË°®Ê†º -->
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">È°ûÂûã</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ë°ÄÂûã</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‰æÜÊ∫ê/Áî®ÈÄî</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰ΩúÂì°</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in bloodHistory" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(record.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="record.event_type === 'RECEIVE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                              class="px-2 py-1 rounded-full text-xs font-medium"
                                              x-text="record.event_type === 'RECEIVE' ? 'ÂÖ•Â∫´' : 'Âá∫Â∫´'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm font-semibold" x-text="record.blood_type"></td>
                                    <td class="px-4 py-2 text-sm font-bold" x-text="record.quantity + ' U'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="record.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="record.operator"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewBloodDetail(record)" class="text-blood-500 hover:text-blood-600 font-medium">Ë©≥ÊÉÖ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="!bloodHistory || bloodHistory.length === 0" class="text-center py-8 text-gray-400">
                        ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button @click="exportBloodHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫ CSV
                    </button>
                    <button type="button" @click="showBloodHistoryModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- ÂêåÊ≠•ÁÆ°ÁêÜÂàÜÈ†Å (ËÅØÈÇ¶Êû∂Êßã Phase 1-2) -->
        <div x-show="currentTab === 'sync'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    ÂêåÊ≠•ÁÆ°ÁêÜ
                </h2>
                <div class="text-sm text-gray-600">
                    <span class="font-semibold">Á´ôÈªû:</span> <span x-text="stationId"></span> |
                    <span class="font-semibold">ÈÜ´Èô¢:</span> HOSP-001
                </div>
            </div>

            <!-- Á´ôÈªûË≥áË®äÂç°Áâá -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-teal-variant-100 border-2 border-teal-variant-500 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">ÂæÖÂêåÊ≠•ËÆäÊõ¥</p>
                            <p class="text-2xl font-bold text-teal-variant-700" x-text="syncStats.pendingChanges"></p>
                        </div>
                        <svg class="w-10 h-10 text-teal-variant-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                </div>
                <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Â∑≤ÂêåÊ≠•Â∞ÅÂåÖ</p>
                            <p class="text-2xl font-bold text-gray-700" x-text="syncStats.syncedPackages"></p>
                        </div>
                        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="bg-teal-variant-100 border-2 border-teal-variant-600 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">‰∏äÊ¨°ÂêåÊ≠•</p>
                            <p class="text-sm font-semibold text-teal-variant-800" x-text="syncStats.lastSync || 'Â∞öÊú™ÂêåÊ≠•'"></p>
                        </div>
                        <svg class="w-10 h-10 text-teal-variant-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖÂçÄÂ°ä -->
            <div class="bg-teal-variant-100 border-2 border-teal-variant-600 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-teal-variant-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂêåÊ≠•È°ûÂûã</label>
                        <select x-model="syncPackageForm.syncType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-variant-700">
                            <option value="DELTA">Â¢ûÈáèÂêåÊ≠• (DELTA)</option>
                            <option value="FULL">ÂÖ®ÈáèÂêåÊ≠• (FULL)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ëµ∑ÂßãÊôÇÈñì (Â¢ûÈáèÁî®)</label>
                        <input type="datetime-local" x-model="syncPackageForm.sinceTimestamp" :disabled="syncPackageForm.syncType === 'FULL'" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-variant-700 disabled:bg-gray-100">
                    </div>
                    <div class="flex items-end">
                        <button @click="generateSyncPackage()" class="w-full bg-teal-variant-700 text-white px-4 py-2 rounded-lg hover:bg-teal-variant-800 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            Áî¢ÁîüÂ∞ÅÂåÖ
                        </button>
                    </div>
                </div>

                <!-- Áî¢ÁîüÁöÑÂ∞ÅÂåÖË≥áË®ä -->
                <div x-show="generatedPackage" class="mt-4 bg-white border-2 border-teal-variant-500 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">Â∞ÅÂåÖË≥áË®ä</h4>
                            <div class="text-sm space-y-1">
                                <p><span class="font-semibold">Â∞ÅÂåÖID:</span> <span x-text="generatedPackage?.package_id" class="text-teal-variant-700 font-mono text-xs"></span></p>
                                <p><span class="font-semibold">È°ûÂûã:</span> <span x-text="generatedPackage?.package_type"></span></p>
                                <p><span class="font-semibold">ËÆäÊõ¥Êï∏:</span> <span x-text="generatedPackage?.changes_count"></span> È†Ö</p>
                                <p><span class="font-semibold">Â§ßÂ∞è:</span> <span x-text="formatBytes(generatedPackage?.package_size)"></span></p>
                                <p><span class="font-semibold">Ê†°È©óÁ¢º:</span> <span x-text="generatedPackage?.checksum?.substring(0, 16) + '...'" class="text-xs font-mono"></span></p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="downloadSyncPackage()" class="bg-gray-600 text-white px-3 py-1.5 rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-1.5 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                ‰∏ãËºâ JSON
                            </button>
                            <button @click="copySyncPackage()" class="bg-gray-500 text-white px-3 py-1.5 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-1.5 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                                Ë§áË£Ω
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded p-2 overflow-auto max-h-40">
                        <pre class="text-xs font-mono" x-text="JSON.stringify(generatedPackage, null, 2)"></pre>
                    </div>
                </div>
            </div>

            <!-- ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖÂçÄÂ°ä -->
            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-teal-variant-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖ
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÅ∏ÊìáÂêåÊ≠•Â∞ÅÂåÖÊ™îÊ°à (JSON)</label>
                        <input type="file" @change="handleSyncFileUpload($event)" accept=".json" class="w-full px-4 py-2 border-2 border-dashed border-teal-variant-500 rounded-lg focus:border-teal-variant-700 bg-white">
                    </div>
                    <div class="flex gap-3">
                        <button @click="importSyncPackage()" :disabled="!uploadedPackage" class="flex-1 bg-teal-variant-700 text-white px-4 py-2 rounded-lg hover:bg-teal-variant-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            ÂåØÂÖ•Â∞ÅÂåÖ
                        </button>
                        <button @click="clearUploadedPackage()" :disabled="!uploadedPackage" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                            Ê∏ÖÈô§
                        </button>
                    </div>

                    <!-- ‰∏äÂÇ≥ÁöÑÂ∞ÅÂåÖÈ†êË¶Ω -->
                    <div x-show="uploadedPackage" class="bg-white border-2 border-teal-variant-500 rounded-lg p-4">
                        <h4 class="font-bold text-gray-800 mb-2">Â∑≤‰∏äÂÇ≥Â∞ÅÂåÖ</h4>
                        <div class="text-sm space-y-1 mb-3">
                            <p><span class="font-semibold">Â∞ÅÂåÖID:</span> <span x-text="uploadedPackage?.packageId" class="text-teal-variant-700 font-mono text-xs"></span></p>
                            <p><span class="font-semibold">ËÆäÊõ¥Êï∏:</span> <span x-text="uploadedPackage?.changes?.length"></span> È†Ö</p>
                            <p><span class="font-semibold">Ê†°È©óÁ¢º:</span> <span x-text="uploadedPackage?.checksum?.substring(0, 16) + '...'" class="text-xs font-mono"></span></p>
                        </div>
                    </div>

                    <!-- ÂåØÂÖ•ÁµêÊûú -->
                    <div x-show="importResult" class="rounded-lg p-4" :class="importResult?.success ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'">
                        <h4 class="font-bold mb-2" :class="importResult?.success ? 'text-green-800' : 'text-red-800'">
                            <span x-show="importResult?.success">‚úì ÂåØÂÖ•ÊàêÂäü</span>
                            <span x-show="!importResult?.success">‚úó ÂåØÂÖ•Â§±Êïó</span>
                        </h4>
                        <div class="text-sm space-y-1">
                            <p x-show="importResult?.changes_applied"><span class="font-semibold">Â•óÁî®ËÆäÊõ¥:</span> <span x-text="importResult?.changes_applied"></span> È†Ö</p>
                            <p x-show="importResult?.conflicts_detected"><span class="font-semibold">Ë°ùÁ™Å:</span> <span x-text="importResult?.conflicts_detected"></span> È†Ö</p>
                            <p><span class="font-semibold">Ë®äÊÅØ:</span> <span x-text="importResult?.message"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂêåÊ≠•ÁãÄÊÖãË™™Êòé -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ÂêåÊ≠•Ë™™Êòé
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-600">
                    <div>
                        <p class="font-semibold mb-1">üì¶ Áî¢ÁîüÂ∞ÅÂåÖÔºö</p>
                        <ul class="list-disc list-inside space-y-0.5 ml-2">
                            <li><strong>Â¢ûÈáèÂêåÊ≠•</strong>ÔºöÂÉÖÂåÖÂê´ÊåáÂÆöÊôÇÈñìÂæåÁöÑËÆäÊõ¥</li>
                            <li><strong>ÂÖ®ÈáèÂêåÊ≠•</strong>ÔºöÂåÖÂê´ÊâÄÊúâË≥áÊñô</li>
                            <li>Áî¢ÁîüÂæåÂèØ‰∏ãËºâÁÇ∫ JSON Ê™îÊ°à</li>
                            <li>ÈÄèÈÅé USB ÂØ¶È´îËΩâÁßªÂà∞ÈÜ´Èô¢Â±§</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">üì• ÂåØÂÖ•Â∞ÅÂåÖÔºö</p>
                        <ul class="list-disc list-inside space-y-0.5 ml-2">
                            <li>‰∏äÂÇ≥ÂæûÈÜ´Èô¢Â±§Êî∂Âà∞ÁöÑÂ∞ÅÂåÖ</li>
                            <li>Ëá™ÂãïÈ©óË≠â SHA-256 Ê†°È©óÁ¢º</li>
                            <li>Ê™¢Ê∏¨‰∏¶Ë®òÈåÑË≥áÊñôË°ùÁ™Å</li>
                            <li>Êõ¥Êñ∞Êú¨Á´ôÈªûË≥áÊñô</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast ÈÄöÁü• -->
        <div x-show="showToast" x-transition class="fixed bottom-4 right-4 z-50" style="display: none;">
            <div :class="{
                'bg-teal-custom-500': toastType === 'success',
                'bg-red-500': toastType === 'error',
                'bg-blue-500': toastType === 'info'
            }" class="text-white px-6 py-3 rounded-lg shadow-lg">
                <p x-text="toastMessage"></p>
            </div>
        </div>

        <!-- Á∑äÊÄ•ÂäüËÉΩÊåâÈàï -->
        <div class="fixed bottom-24 right-4 z-40">
            <button @click="showEmergencyModal = true"
                    class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-2xl transition-all duration-300 transform hover:scale-110">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </button>
        </div>

        <!-- Á∑äÊÄ•ÂäüËÉΩÈÅ∏ÂñÆ Modal -->
        <div x-show="showEmergencyModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEmergencyModal = false" class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-red-600 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        Á∑äÊÄ•ÂäüËÉΩ
                    </h3>
                    <button @click="showEmergencyModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <p class="text-sm text-gray-600 mb-6">
                    Êà∞ÊôÇÁ∑äÊÄ•Êí§Èõ¢‰ΩøÁî® - Âø´ÈÄü‰øùÂÖ®ÊâÄÊúâË≥áÊñô
                </p>

                <div class="space-y-3">
                    <!-- ÈÅ∏È†Ö1: Êí§Èõ¢ - ‰∏ãËºâÊâÄÊúâË≥áÊñô -->
                    <button @click="emergencyDownloadAll()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">Êí§Èõ¢ - ‰∏ãËºâÊâÄÊúâË≥áÊñô</p>
                            <p class="text-xs text-red-100">ÂÆåÊï¥ÂÇô‰ªΩÂåÖÔºàZIPÊ™îÊ°àÔºâ</p>
                        </div>
                    </button>

                    <!-- ÈÅ∏È†Ö2: Âø´ÈÄüÂÇô‰ªΩË≥áÊñôÂ∫´ -->
                    <button @click="emergencyQuickBackup()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">Âø´ÈÄüÂÇô‰ªΩË≥áÊñôÂ∫´</p>
                            <p class="text-xs text-orange-100">ÂÉÖ‰∏ãËºâ .db Ê™îÊ°àÔºàÊúÄÂø´Ôºâ</p>
                        </div>
                    </button>

                    <!-- ÈÅ∏È†Ö3: ÂèñÊ∂à -->
                    <button @click="showEmergencyModal = false"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 p-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="font-medium">ÂèñÊ∂à</span>
                    </button>
                </div>

                <div class="mt-6 p-3 bg-red-50 rounded-lg border border-red-200">
                    <p class="text-xs text-red-700 flex items-start gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span><strong>ÊèêÁ§∫Ôºö</strong>Âª∫Ë≠∞‰ΩøÁî®„ÄåÊí§Èõ¢„ÄçÂäüËÉΩ‰∏ãËºâÂÆåÊï¥ÂÇô‰ªΩÂåÖÔºåÂåÖÂê´ÊâÄÊúâË≥áÊñôÂíåË™™ÊòéÊñá‰ª∂„ÄÇ</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Á∑äÊÄ•È†òÁî®ÂéüÂõ† Modal (MIRS v2.3) -->
        <div x-show="showEmergencyReasonModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showEmergencyReasonModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        Á∑äÊÄ•È†òÁî® (Break-the-Glass)
                    </h3>
                    <button @click="showEmergencyReasonModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">ÈáçË¶ÅÊèêÈÜí</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Á∑äÊÄ•È†òÁî®ÊúÉÁ´ãÂç≥Êâ£Èô§Â∫´Â≠ò</li>
                                <li>‰∏çÈúÄË¶ÅËó•Â∏´ PIN Á¢º</li>
                                <li>ÂøÖÈ†àÂ°´ÂØ´Á∑äÊÄ•ÂéüÂõ† (Ëá≥Â∞ë5ÂÄãÂ≠ó)</li>
                                <li>Ëó•Â∏´Á®çÂæåÊúÉÁ¢∫Ë™çÊ≠§Á≠ÜÈ†òÁî®</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="batchDispenseForm.isEmergency = true; submitBatchDispense()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> Á∑äÊÄ•ÂéüÂõ† (5-200Â≠ó)
                        </label>
                        <textarea x-model="batchDispenseForm.emergencyReason"
                                  required
                                  minlength="5"
                                  maxlength="200"
                                  rows="4"
                                  placeholder="‰æãÂ¶ÇÔºöÂ§ßÈáèÂÇ∑ÊÇ£ÊπßÂÖ•ÔºåÈúÄË¶ÅÁ∑äÊÄ•Áâ©Ë≥áÔºåËó•Â∏´‰∏çÂú®ÁèæÂ†¥..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                        <p class="text-xs text-gray-500 mt-1" x-text="`Â∑≤Ëº∏ÂÖ• ${batchDispenseForm.emergencyReason.length} Â≠ó (ÊúÄÂ∞ë5Â≠óÔºåÊúÄÂ§ö200Â≠ó)`"></p>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÁ∑äÊÄ•È†òÁî®</span>
                        </button>
                        <button type="button" @click="showEmergencyReasonModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ëó•Â∏´ÂØ©Ê†∏ Modal (MIRS v2.3) -->
        <div x-show="showPharmacistApprovalModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showPharmacistApprovalModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        Ëó•Â∏´ÂØ©Ê†∏Á¢∫Ë™ç
                    </h3>
                    <button @click="showPharmacistApprovalModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- È†òÁî®Ë®òÈåÑË©≥ÊÉÖ -->
                <template x-if="selectedDispenseForApproval">
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-2">È†òÁî®Ë®òÈåÑË©≥ÊÉÖ</h4>
                        <div class="space-y-1 text-sm">
                            <p><span class="text-gray-600">Ëó•ÂìÅ:</span> <span class="font-semibold" x-text="`${selectedDispenseForApproval.medicine_code} - ${selectedDispenseForApproval.medicine_name}`"></span></p>
                            <p><span class="text-gray-600">Êï∏Èáè:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.quantity"></span> <span x-text="selectedDispenseForApproval.unit"></span></p>
                            <p><span class="text-gray-600">È†òËó•‰∫∫:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.dispensed_by"></span></p>
                            <p x-show="selectedDispenseForApproval.patient_name"><span class="text-gray-600">ÁóÖÊÇ£:</span> <span x-text="selectedDispenseForApproval.patient_name"></span></p>
                            <p x-show="selectedDispenseForApproval.emergency_reason" class="text-claude-red-600 font-medium pt-2">
                                <span class="text-gray-600">Á∑äÊÄ•ÂéüÂõ†:</span> <span x-text="selectedDispenseForApproval.emergency_reason"></span>
                            </p>
                        </div>
                    </div>
                </template>

                <form @submit.prevent="submitPharmacistApproval()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> Ëó•Â∏´ÂßìÂêç
                        </label>
                        <input type="text"
                               x-model="pharmacistApprovalForm.approvedBy"
                               required
                               placeholder="Ëó•Â∏´-ÊûóÂ§ßËèØ"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> PIN Á¢º (Ëó•Â∏´ÂØÜÁ¢º)
                        </label>
                        <input type="password"
                               x-model="pharmacistApprovalForm.pinCode"
                               required
                               placeholder="Ë´ãËº∏ÂÖ•4‰ΩçÊï∏PINÁ¢º"
                               maxlength="4"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        <p class="text-xs text-gray-500 mt-1">È†êË®≠PINÁ¢º: 1234 (ÁîüÁî¢Áí∞Â¢ÉË´ãÊõ¥Êîπ)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ëó•Â∏´ÂÇôË®ª (ÈÅ∏Â°´)
                        </label>
                        <textarea x-model="pharmacistApprovalForm.pharmacistNotes"
                                  rows="3"
                                  placeholder="Á¢∫Ë™çÁÑ°Ë™§ÔºåÂ∑≤Ê†∏Â∞çÁóÖÊÇ£Áî®Ëó•Ë®òÈåÑ..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÂØ©Ê†∏</span>
                        </button>
                        <button type="button" @click="showPharmacistApprovalModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex flex-col items-center justify-center gap-4">
                <!-- iRehab Logo -->
                <div class="flex items-center justify-center">
                    <img src="/static/iRehab_logo.png" alt="iRehab Logo" class="h-12 w-auto object-contain opacity-80 hover:opacity-100 transition-opacity">
                </div>

                <!-- Footer Text -->
                <div class="text-center text-xs text-gray-400 space-y-1">
                    <p>ÈÜ´ÁôÇÁ´ôÂ∫´Â≠òÁÆ°ÁêÜÁ≥ªÁµ± v1.4.5</p>
                    <p class="flex items-center justify-center gap-2">
                        <span>Powered by</span>
                        <span class="font-semibold text-gray-500">De Novo Orthopedics Inc</span>
                    </p>
                </div>
            </div>
        </footer>

    </div>

    <script>
        function medicalInventory() {
            // Safari ÂÖºÂÆπÊÄß: Ê™¢Ê∏¨ÁÄèË¶ΩÂô®‰∏¶‰ΩøÁî®ÈÅ©Áï∂ÁöÑ API URL
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const apiBaseUrl = isSafari || window.location.hostname === '127.0.0.1'
                ? 'http://127.0.0.1:8000/api'
                : 'http://localhost:8000/api';

            return {
                // Âü∫Êú¨Ë®≠ÂÆö
                apiUrl: apiBaseUrl,
                stationId: localStorage.getItem('stationId') || 'TC-01',
                stationName: localStorage.getItem('stationName') || 'ÂâçÁ∑öÈÜ´ÁôÇÁ´ô',
                stationType: localStorage.getItem('stationType') || '',
                currentTab: 'items',
                treatmentMode: 'surgery', // ËôïÁΩÆÊ®ôÁ±§È†ÅÊ®°Âºè: 'surgery' Êàñ 'consume'
                currentTime: '',
                
                // Ë≥áÊñô
                items: [],
                filteredItems: [],
                bloodInventory: [],
                equipment: [],
                surgeryRecords: [],
                receiveHistory: [],
                consumeHistory: [],
                stats: {
                    totalItems: 0,
                    lowStockItems: 0,
                    totalBlood: 0,
                    equipmentAlerts: 0
                },

                // ÊêúÂ∞ãËàáÁØ©ÈÅ∏
                itemSearchText: '',
                receiveItemSearch: '',
                filteredReceiveItems: [],
                showReceiveDropdown: false,

                // Modal ÁãÄÊÖã
                showAddItemModal: false,
                showEditItemModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showCheckEquipmentModal: false,
                showAddSurgeryModal: false,
                showSurgeryDetailModal: false,
                showReceiveHistoryModal: false,
                showConsumeHistoryModal: false,
                showConsumeDetailModal: false,
                showBloodHistoryModal: false,
                showEmergencyReasonModal: false,
                showPharmacistApprovalModal: false,

                // Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ
                bloodHistory: [],
                bloodHistorySearch: {
                    startDate: '',
                    endDate: '',
                    bloodType: '',
                    eventType: ''
                },
                selectedBloodRecord: null,

                // Ëó•ÂìÅÈ†òÁî®Ë®òÈåÑ (MIRS v2.3)
                pendingDispenses: [],
                dispenseHistory: [],
                selectedDispenseForApproval: null,

                // Ë°®ÂñÆ
                receiveForm: {
                    itemCode: '',
                    quantity: 1,
                    batchNumber: '',
                    expiryDate: '',
                    remarks: '',
                    stationId: 'TC-01'
                },
                consumeForm: {
                    itemCode: '',
                    quantity: 1,
                    purpose: '',
                    stationId: 'TC-01'
                },
                batchConsumeForm: {
                    purpose: '',
                    items: [],
                    stationId: 'TC-01'
                },
                bloodReceiveForm: {
                    bloodType: '',
                    quantity: 1,
                    remarks: '',
                    source: 'blood_center',  // Êñ∞Â¢ûÔºöË°ÄÊ∂≤‰æÜÊ∫ê
                    donorName: '',           // Êñ∞Â¢ûÔºöÊçêË°ÄËÄÖÂßìÂêç
                    donorPhone: '',          // Êñ∞Â¢ûÔºöÊçêË°ÄËÄÖÈõªË©±
                    stationId: 'TC-01'
                },
                bloodConsumeForm: {
                    bloodType: '',
                    quantity: 1,
                    patientName: '',
                    patientId: '',
                    purpose: '',
                    stationId: 'TC-01'
                },
                bloodTransferForm: {
                    sourceStationId: 'TC-01',
                    targetStationId: '',
                    bloodType: '',
                    quantity: 1,
                    operator: 'SYSTEM',
                    remarks: ''
                },
                addItemForm: {
                    code: '',
                    name: '',
                    unit: 'EA',
                    minStock: 10,
                    category: 'ÂÖ∂‰ªñ'
                },
                editItemForm: {
                    code: '',
                    name: '',
                    unit: '',
                    minStock: 0,
                    category: ''
                },
                addEquipmentForm: {
                    name: '',
                    category: 'ÂÖ∂‰ªñ',
                    quantity: 1,
                    remarks: ''
                },
                editEquipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    remarks: ''
                },
                checkEquipmentForm: {
                    id: '',
                    name: '',
                    status: 'NORMAL',
                    powerLevel: null,
                    remarks: '',
                    stationId: 'TC-01'
                },
                addSurgeryForm: {
                    patientName: '',
                    triageTagId: '',
                    surgeryType: '',
                    surgeonName: '',
                    anesthesiaType: '',
                    durationMinutes: null,
                    remarks: '',
                    consumptions: [],
                    stationId: 'TC-01'
                },
                surgerySearchForm: {
                    startDate: '',
                    endDate: '',
                    patientName: ''
                },
                receiveHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                consumeHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                dispenseForm: {
                    medicineCode: '',
                    quantity: 1,
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    stationCode: 'TC-01',
                    emergencyReason: ''
                },
                batchDispenseForm: {
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    items: [],
                    stationCode: 'TC-01',
                    isEmergency: false,
                    emergencyReason: ''
                },
                pharmacistApprovalForm: {
                    dispenseId: null,
                    approvedBy: '',
                    pharmacistNotes: '',
                    pinCode: ''
                },
                selectedSurgery: null,
                selectedConsumeEvent: null,

                // Toast
                showToast: false,
                toastMessage: '',
                toastType: 'info',

                // Á∑äÊÄ•ÂäüËÉΩ (v1.4.5Êñ∞Â¢û)
                showEmergencyModal: false,

                // ÂêåÊ≠•ÁÆ°ÁêÜ (ËÅØÈÇ¶Êû∂Êßã Phase 1-2)
                syncPackageForm: {
                    syncType: 'DELTA',
                    sinceTimestamp: ''
                },
                generatedPackage: null,
                uploadedPackage: null,
                importResult: null,
                syncStats: {
                    pendingChanges: 0,
                    syncedPackages: 0,
                    lastSync: null
                },

                // ËºâÂÖ•ÁãÄÊÖãËøΩËπ§ (v1.4.5ÊïàËÉΩÂÑ™Âåñ)
                dataLoaded: {
                    items: false,
                    blood: false,
                    equipment: false,
                    surgery: false,
                    dispense: false
                },

                // ÂàùÂßãÂåñ (v1.4.5ÂÑ™Âåñ: Âª∂ÈÅ≤ËºâÂÖ•)
                async init() {
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);

                    // Âè™ËºâÂÖ•Áµ±Ë®àË≥áÊñôÔºàËºïÈáèÁ¥öÔºâ
                    await this.loadStats();

                    // Ê†πÊìöÁï∂ÂâçÊ®ôÁ±§ËºâÂÖ•Â∞çÊáâË≥áÊñô
                    await this.lazyLoadTabData(this.currentTab);
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },

                getStationTypeName() {
                    const types = {
                        'health_center': 'Ë°õÁîüÊâÄ',
                        'hospital_custom': 'ÈÜ´Èô¢Ëá™Ë®Ç',
                        'surgical_station': 'BORP ÂÇôÊè¥ÊâãË°ìÁ´ô',
                        'logistics_hub': 'Áâ©Ë≥á‰∏≠ÁπºÁ´ô'
                    };
                    return types[this.stationType] || this.stationType;
                },

                // Âª∂ÈÅ≤ËºâÂÖ•Ê®ôÁ±§Ë≥áÊñô (v1.4.5ÊïàËÉΩÂÑ™Âåñ)
                async lazyLoadTabData(tab) {
                    if (tab === 'items' && !this.dataLoaded.items) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'blood' && !this.dataLoaded.blood) {
                        await this.loadBloodInventory();
                        this.dataLoaded.blood = true;
                    }
                    if (tab === 'equipment' && !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        this.dataLoaded.equipment = true;
                    }
                    if (tab === 'surgery' && !this.dataLoaded.surgery) {
                        await this.loadSurgeryRecords();
                        this.dataLoaded.surgery = true;
                    }
                    if (tab === 'dispense' && !this.dataLoaded.dispense) {
                        await this.loadPendingDispenses();
                        this.dataLoaded.dispense = true;
                    }
                },

                // ÂàÜÈ†ÅÂàáÊèõ (v1.4.5ÂÑ™Âåñ: Âª∂ÈÅ≤ËºâÂÖ•)
                async switchTab(tab) {
                    this.currentTab = tab;
                    await this.lazyLoadTabData(tab);
                },

                // Á¢∫‰øùitemsÂ∑≤ËºâÂÖ• (Áî®ÊñºÊêúÂ∞ãËÄóÊùêÂäüËÉΩ)
                async ensureItemsLoaded() {
                    if (!this.dataLoaded.items || this.items.length === 0) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                },

                // ËºâÂÖ•Áµ±Ë®à
                async loadStats() {
                    try {
                        const response = await fetch(`${this.apiUrl}/stats`);
                        if (response.ok) {
                            this.stats = await response.json();
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Áµ±Ë®àÂ§±Êïó:', error);
                    }
                },

                // ËºâÂÖ•Áâ©ÂìÅ
                async loadItems() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`);
                        if (response.ok) {
                            const data = await response.json();
                            this.items = data.items;
                            this.filteredItems = data.items;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Áâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Áâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                // ÁØ©ÈÅ∏Áâ©ÂìÅ
                filterItems() {
                    const searchText = this.itemSearchText.toLowerCase();
                    if (!searchText) {
                        this.filteredItems = this.items;
                    } else {
                        this.filteredItems = this.items.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText) ||
                            item.category.toLowerCase().includes(searchText)
                        );
                    }
                },

                // ÂåØÂá∫Â∫´Â≠òCSV
                exportInventoryCSV() {
                    const url = `${this.apiUrl}/inventory/export/csv`;
                    window.open(url, '_blank');
                    this.toast('CSV ÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ÂåØÂá∫Â∫´Â≠òJSON
                exportInventoryJSON() {
                    const url = `${this.apiUrl}/inventory/export/json`;
                    window.open(url, '_blank');
                    this.toast('JSON ÂåØÂá∫ÊàêÂäü', 'success');
                },

                // Êñ∞Â¢ûÁâ©ÂìÅ
                async submitAddItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addItemForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Áâ©ÂìÅÊñ∞Â¢ûÊàêÂäü', 'success');
                            this.showAddItemModal = false;
                            this.resetAddItemForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êñ∞Â¢ûÁâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('Êñ∞Â¢ûÁâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                resetAddItemForm() {
                    this.addItemForm = {
                        code: '',
                        name: '',
                        unit: 'EA',
                        minStock: 10,
                        category: 'ÂÖ∂‰ªñ'
                    };
                },

                // Á∑®ËºØÁâ©ÂìÅ
                editItem(item) {
                    this.editItemForm = {
                        code: item.code,
                        name: item.name,
                        unit: item.unit,
                        minStock: item.min_stock,
                        category: item.category
                    };
                    this.showEditItemModal = true;
                },

                async submitEditItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${this.editItemForm.code}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editItemForm.name,
                                unit: this.editItemForm.unit,
                                minStock: this.editItemForm.minStock,
                                category: this.editItemForm.category
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Áâ©ÂìÅÊõ¥Êñ∞ÊàêÂäü', 'success');
                            this.showEditItemModal = false;
                            await this.loadItems();
                        } else {
                            this.toast(data.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Áâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('Êõ¥Êñ∞Áâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                // Âà™Èô§Áâ©ÂìÅ
                async deleteItem(code, name) {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Áâ©ÂìÅ„Äå${name}„ÄçÂóé?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${code}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Áâ©ÂìÅÂ∑≤Âà™Èô§', 'success');
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âà™Èô§Áâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('Âà™Èô§Áâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                // ÈÄ≤Ë≤®
                async submitReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ÈÄ≤Ë≤®Ë®òÈåÑÊàêÂäü', 'success');
                            this.resetReceiveForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'ÈÄ≤Ë≤®Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ÈÄ≤Ë≤®Â§±Êïó:', error);
                        this.toast('ÈÄ≤Ë≤®Â§±Êïó', 'error');
                    }
                },

                resetReceiveForm() {
                    this.receiveForm = {
                        itemCode: '',
                        quantity: 1,
                        batchNumber: '',
                        expiryDate: '',
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.receiveItemSearch = '';
                },

                // ÈÄ≤Ë≤®È†ÅÈù¢ - Áâ©ÂìÅÊêúÂ∞ã
                filterReceiveItems() {
                    const searchText = this.receiveItemSearch.toLowerCase();
                    if (!searchText) {
                        this.filteredReceiveItems = this.items;
                    } else {
                        this.filteredReceiveItems = this.items.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                // ÈÄ≤Ë≤®È†ÅÈù¢ - ÈÅ∏ÊìáÁâ©ÂìÅ
                selectReceiveItem(item) {
                    this.receiveForm.itemCode = item.code;
                    this.receiveItemSearch = `${item.code} - ${item.name}`;
                    this.showReceiveDropdown = false;
                },

                // ËºâÂÖ•ÈÄ≤Ë≤®Ë®òÈåÑ
                async loadReceiveHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=RECEIVE&limit=100`;

                        if (this.receiveHistorySearch.startDate) {
                            url += `&start_date=${this.receiveHistorySearch.startDate}`;
                        }
                        if (this.receiveHistorySearch.endDate) {
                            url += `&end_date=${this.receiveHistorySearch.endDate}`;
                        }
                        if (this.receiveHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.receiveHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.receiveHistory = data.events;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÈÄ≤Ë≤®Ë®òÈåÑÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•ÈÄ≤Ë≤®Ë®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                // ÂåØÂá∫ÈÄ≤Ë≤®Ë®òÈåÑ
                exportReceiveHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=RECEIVE`;

                    if (this.receiveHistorySearch.startDate) {
                        url += `&start_date=${this.receiveHistorySearch.startDate}`;
                    }
                    if (this.receiveHistorySearch.endDate) {
                        url += `&end_date=${this.receiveHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('ÈÄ≤Ë≤®Ë®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // Ê∂àËÄó
                async submitConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.consumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ê∂àËÄóË®òÈåÑÊàêÂäü', 'success');
                            this.resetConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Ê∂àËÄóÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ê∂àËÄóÂ§±Êïó:', error);
                        this.toast('Ê∂àËÄóÂ§±Êïó', 'error');
                    }
                },

                resetConsumeForm() {
                    this.consumeForm = {
                        itemCode: '',
                        quantity: 1,
                        purpose: '',
                        stationId: this.stationId
                    };
                },

                // ÊâπÊ¨°Ê∂àËÄóÂäüËÉΩ
                addBatchConsumeItem() {
                    this.batchConsumeForm.items.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchConsumeItem(index) {
                    this.batchConsumeForm.items.splice(index, 1);
                },

                filterBatchConsumeItems(index) {
                    const item = this.batchConsumeForm.items[index];
                    const searchText = item.searchText.toLowerCase();

                    // ÊéíÈô§Ëó•ÂìÅ (medicines) - Ëó•ÂìÅÊáâË©≤ÈÄèÈÅéËó•ÂìÅÈ†òÁî®ÊµÅÁ®ã
                    const nonMedicineItems = this.items.filter(i => i.category !== 'Ëó•ÂìÅ');

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i.item_code.toLowerCase().includes(searchText) ||
                            i.item_name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectBatchConsumeItem(index, selectedItem) {
                    const item = this.batchConsumeForm.items[index];
                    item.itemCode = selectedItem.item_code;
                    item.itemName = selectedItem.item_name;
                    item.searchText = `${selectedItem.item_code} - ${selectedItem.item_name}`;
                    item.showDropdown = false;
                },

                async submitBatchConsume() {
                    try {
                        if (this.batchConsumeForm.items.length === 0) {
                            this.toast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÂÄãÊ∂àËÄóÂìÅÈ†Ö', 'error');
                            return;
                        }

                        // ÊâπÊ¨°Êèê‰∫§ÊØèÂÄãÊ∂àËÄóÂìÅÈ†Ö
                        let successCount = 0;
                        let failCount = 0;

                        for (const item of this.batchConsumeForm.items) {
                            try {
                                const response = await fetch(`${this.apiUrl}/consume`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        itemCode: item.itemCode,
                                        quantity: item.quantity,
                                        purpose: this.batchConsumeForm.purpose,
                                        stationId: this.batchConsumeForm.stationId
                                    })
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                failCount++;
                            }
                        }

                        // È°ØÁ§∫ÁµêÊûú
                        if (failCount === 0) {
                            this.toast(`ÊàêÂäüÊ∂àËÄó ${successCount} È†ÖÁâ©ÂìÅ`, 'success');
                            this.resetBatchConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`ÊàêÂäü ${successCount} È†ÖÔºåÂ§±Êïó ${failCount} È†Ö`, 'warning');
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('ÊâπÊ¨°Ê∂àËÄóÂ§±Êïó:', error);
                        this.toast('ÊâπÊ¨°Ê∂àËÄóÂ§±Êïó', 'error');
                    }
                },

                resetBatchConsumeForm() {
                    this.batchConsumeForm = {
                        purpose: '',
                        items: [],
                        stationId: this.stationId
                    };
                },

                // ËºâÂÖ•Ê∂àËÄóË®òÈåÑ
                async loadConsumeHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=CONSUME&limit=100`;

                        if (this.consumeHistorySearch.startDate) {
                            url += `&start_date=${this.consumeHistorySearch.startDate}`;
                        }
                        if (this.consumeHistorySearch.endDate) {
                            url += `&end_date=${this.consumeHistorySearch.endDate}`;
                        }
                        if (this.consumeHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.consumeHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.consumeHistory = data.events;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ê∂àËÄóË®òÈåÑÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ê∂àËÄóË®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                // Êü•ÁúãÊ∂àËÄóË©≥ÊÉÖ
                viewConsumeDetail(event) {
                    this.selectedConsumeEvent = event;
                    this.showConsumeDetailModal = true;
                },

                // ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ
                async loadBloodHistory() {
                    try {
                        let url = `${this.apiUrl}/blood/events?station_id=${this.stationId}`;

                        // Ê∑ªÂä†ÁØ©ÈÅ∏Ê¢ù‰ª∂
                        if (this.bloodHistorySearch.startDate) {
                            url += `&start_date=${this.bloodHistorySearch.startDate}`;
                        }
                        if (this.bloodHistorySearch.endDate) {
                            url += `&end_date=${this.bloodHistorySearch.endDate}`;
                        }
                        if (this.bloodHistorySearch.bloodType) {
                            url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                        }
                        if (this.bloodHistorySearch.eventType) {
                            url += `&event_type=${this.bloodHistorySearch.eventType}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.status === 'success') {
                            this.bloodHistory = data.data || [];
                        } else {
                            this.toast('ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑÈåØË™§:', error);
                        this.toast('ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑÈåØË™§', 'error');
                    }
                },

                // Êü•ÁúãË°ÄÊ∂≤Ë®òÈåÑË©≥ÊÉÖ
                viewBloodDetail(record) {
                    this.selectedBloodRecord = record;
                    // ÂèØ‰ª•Êì¥Â±ïÁÇ∫È°ØÁ§∫Ë©≥ÊÉÖ Modal
                    let detailText = `
=== Ë°ÄÂ∫´Ë®òÈåÑË©≥ÊÉÖ ===
È°ûÂûã: ${record.event_type === 'RECEIVE' ? 'ÂÖ•Â∫´' : 'Âá∫Â∫´'}
Ë°ÄÂûã: ${record.blood_type}
Êï∏Èáè: ${record.quantity} U
ÊôÇÈñì: ${new Date(record.timestamp).toLocaleString('zh-TW')}
Êìç‰ΩúÂì°: ${record.operator}
ÂÇôË®ª: ${record.remarks || 'ÁÑ°'}
`;

                    // Â¶ÇÊûúÊúâÊçêË°ÄËÄÖË≥áË®äÔºàWalking Blood BankÔºâ
                    if (record.donor_name || record.donor_phone) {
                        detailText += `\n--- Á∑äÊÄ•ÊçêË°ÄËÄÖË≥áË®ä ---\n`;
                        if (record.donor_name) detailText += `ÂßìÂêç: ${record.donor_name}\n`;
                        if (record.donor_phone) detailText += `ÈõªË©±: ${record.donor_phone}\n`;
                    }

                    // Â¶ÇÊûúÊúâÁóÖÊÇ£Ë≥áË®äÔºàÂá∫Â∫´Ë®òÈåÑÔºâ
                    if (record.patient_name) {
                        detailText += `\n--- ÁóÖÊÇ£Ë≥áË®ä ---\n`;
                        detailText += `ÂßìÂêç: ${record.patient_name}\n`;
                        if (record.patient_id) detailText += `ÁóÖÊ≠∑Ëôü: ${record.patient_id}\n`;
                        if (record.diagnosis) detailText += `Ë®∫Êñ∑: ${record.diagnosis}\n`;
                    }

                    alert(detailText);
                },

                // ÂåØÂá∫Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ CSV
                exportBloodHistoryCSV() {
                    let url = `${this.apiUrl}/blood/events/export/csv?station_id=${this.stationId}`;

                    if (this.bloodHistorySearch.startDate) {
                        url += `&start_date=${this.bloodHistorySearch.startDate}`;
                    }
                    if (this.bloodHistorySearch.endDate) {
                        url += `&end_date=${this.bloodHistorySearch.endDate}`;
                    }
                    if (this.bloodHistorySearch.bloodType) {
                        url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                    }
                    if (this.bloodHistorySearch.eventType) {
                        url += `&event_type=${this.bloodHistorySearch.eventType}`;
                    }

                    window.open(url, '_blank');
                    this.toast('Ë°ÄÂ∫´Ë®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ÂåØÂá∫Ê∂àËÄóË®òÈåÑ
                exportConsumeHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=CONSUME`;

                    if (this.consumeHistorySearch.startDate) {
                        url += `&start_date=${this.consumeHistorySearch.startDate}`;
                    }
                    if (this.consumeHistorySearch.endDate) {
                        url += `&end_date=${this.consumeHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('Ê∂àËÄóË®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // Ë°ÄË¢ã
                async loadBloodInventory() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/inventory`);
                        if (response.ok) {
                            const data = await response.json();
                            // Filter by current station only
                            this.bloodInventory = data.bloodInventory.filter(b => b.station_id === this.stationId);
                            console.log('‚úì Ë°ÄË¢ãÂ∫´Â≠òÂ∑≤ËºâÂÖ•:', this.bloodInventory.length, 'Á≠Ü', `(Á´ôÈªû: ${this.stationId})`);
                        } else {
                            console.error('Ë°ÄË¢ãÂ∫´Â≠òAPIÈåØË™§:', response.status);
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ÄË¢ãÂ∫´Â≠òÂ§±Êïó:', error);
                    }
                },

                async submitBloodReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodReceiveForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãÂÖ•Â∫´ÊàêÂäü', 'success');
                            this.bloodReceiveForm = {
                                bloodType: '',
                                quantity: 1,
                                remarks: '',
                                source: 'blood_center',
                                donorName: '',
                                donorPhone: '',
                                stationId: this.stationId
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'ÂÖ•Â∫´Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë°ÄË¢ãÂÖ•Â∫´Â§±Êïó:', error);
                        this.toast('Ë°ÄË¢ãÂÖ•Â∫´Â§±Êïó', 'error');
                    }
                },

                printBloodLabel() {
                    // Ê™¢Êü•ÂøÖÂ°´Ê¨Ñ‰Ωç
                    if (!this.bloodReceiveForm.bloodType) {
                        this.toast('Ë´ãÈÅ∏ÊìáË°ÄÂûã', 'error');
                        return;
                    }
                    if (!this.bloodReceiveForm.quantity || this.bloodReceiveForm.quantity < 1) {
                        this.toast('Ë´ãËº∏ÂÖ•ÊúâÊïàÊï∏Èáè', 'error');
                        return;
                    }

                    // ÊßãÂª∫URLÂèÉÊï∏
                    const params = new URLSearchParams({
                        blood_type: this.bloodReceiveForm.bloodType,
                        quantity: this.bloodReceiveForm.quantity,
                        station_id: this.stationId,
                        remarks: this.bloodReceiveForm.remarks || ''
                    });

                    // ÈñãÂïüÂàóÂç∞Ê®ôÁ±§È†ÅÈù¢
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('Ê≠£Âú®ÈñãÂïüÊ®ôÁ±§ÂàóÂç∞...', 'info');
                },

                async submitBloodConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodConsumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãÂá∫Â∫´ÊàêÂäü', 'success');
                            this.bloodConsumeForm = { bloodType: '', quantity: 1, stationId: this.stationId };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âá∫Â∫´Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë°ÄË¢ãÂá∫Â∫´Â§±Êïó:', error);
                        this.toast('Ë°ÄË¢ãÂá∫Â∫´Â§±Êïó', 'error');
                    }
                },

                async submitBloodTransfer() {
                    try {
                        // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
                        if (!this.bloodTransferForm.sourceStationId || !this.bloodTransferForm.targetStationId) {
                            this.toast('Ë´ãËº∏ÂÖ•‰æÜÊ∫êÁ´ôÈªûÂíåÁõÆÊ®ôÁ´ôÈªû', 'error');
                            return;
                        }
                        if (this.bloodTransferForm.sourceStationId === this.bloodTransferForm.targetStationId) {
                            this.toast('‰æÜÊ∫êÁ´ôÈªûËàáÁõÆÊ®ôÁ´ôÈªû‰∏çËÉΩÁõ∏Âêå', 'error');
                            return;
                        }
                        if (!this.bloodTransferForm.bloodType) {
                            this.toast('Ë´ãÈÅ∏ÊìáË°ÄÂûã', 'error');
                            return;
                        }

                        const response = await fetch(`${this.apiUrl}/blood/transfer`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodTransferForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãËΩâÁßªÊàêÂäü', 'success');
                            // ÈáçÁΩÆË°®ÂñÆ
                            this.bloodTransferForm = {
                                sourceStationId: 'TC-01',
                                targetStationId: '',
                                bloodType: '',
                                quantity: 1,
                                operator: 'SYSTEM',
                                remarks: ''
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'ËΩâÁßªÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë°ÄË¢ãÁ´ôÈªûËΩâÁßªÂ§±Êïó:', error);
                        this.toast('Ë°ÄË¢ãÁ´ôÈªûËΩâÁßªÂ§±Êïó', 'error');
                    }
                },

                // Ë®≠ÂÇôÁÆ°ÁêÜ
                async loadEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment`);
                        if (response.ok) {
                            const data = await response.json();
                            this.equipment = data.equipment;
                            console.log('‚úì Ë®≠ÂÇôÂ∑≤ËºâÂÖ•:', this.equipment.length, 'È†Ö');
                            // ÈáçÊñ∞ËºâÂÖ•Áµ±Ë®àÊï∏Êìö‰ª•Êõ¥Êñ∞ÂæÖÊ™¢Êü•Ë®≠ÂÇôÊï∏Èáè
                            await this.loadStats();
                            this.toast('Ë®≠ÂÇôÂàóË°®Â∑≤Êõ¥Êñ∞', 'success');
                        } else {
                            console.error('Ë®≠ÂÇôAPIÈåØË™§:', response.status);
                            this.toast('ËºâÂÖ•Ë®≠ÂÇôÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ë®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                async submitAddEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addEquipmentForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÊñ∞Â¢ûÊàêÂäü', 'success');
                            this.showAddEquipmentModal = false;
                            this.resetAddEquipmentForm();
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êñ∞Â¢ûË®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('Êñ∞Â¢ûË®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                resetAddEquipmentForm() {
                    this.addEquipmentForm = {
                        name: '',
                        category: 'ÂÖ∂‰ªñ',
                        quantity: 1,
                        remarks: ''
                    };
                },

                editEquipment(eq) {
                    this.editEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category,
                        quantity: eq.quantity,
                        remarks: eq.remarks || ''
                    };
                    this.showEditEquipmentModal = true;
                },

                async submitEditEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${this.editEquipmentForm.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editEquipmentForm.name,
                                category: this.editEquipmentForm.category,
                                quantity: this.editEquipmentForm.quantity,
                                remarks: this.editEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÊõ¥Êñ∞ÊàêÂäü', 'success');
                            this.showEditEquipmentModal = false;
                            await this.loadEquipment();
                        } else {
                            this.toast(data.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Ë®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('Êõ¥Êñ∞Ë®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                async deleteEquipment(id, name) {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Ë®≠ÂÇô„Äå${name}„ÄçÂóé?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÂ∑≤Âà™Èô§', 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âà™Èô§Ë®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('Âà™Èô§Ë®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                checkEquipment(eq) {
                    this.checkEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        status: 'NORMAL',
                        powerLevel: eq.power_level,
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.showCheckEquipmentModal = true;
                },

                async submitCheckEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/check/${this.checkEquipmentForm.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.checkEquipmentForm.stationId,
                                status: this.checkEquipmentForm.status,
                                powerLevel: this.checkEquipmentForm.powerLevel,
                                remarks: this.checkEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÊ™¢Êü•ÂÆåÊàê', 'success');
                            this.showCheckEquipmentModal = false;
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Ê™¢Êü•Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë®≠ÂÇôÊ™¢Êü•Â§±Êïó:', error);
                        this.toast('Ë®≠ÂÇôÊ™¢Êü•Â§±Êïó', 'error');
                    }
                },

                // ÊâãË°ìË®òÈåÑ
                async loadSurgeryRecords() {
                    try {
                        let url = `${this.apiUrl}/surgery/records?limit=50`;
                        
                        if (this.surgerySearchForm.startDate) {
                            url += `&start_date=${this.surgerySearchForm.startDate}`;
                        }
                        if (this.surgerySearchForm.endDate) {
                            url += `&end_date=${this.surgerySearchForm.endDate}`;
                        }
                        if (this.surgerySearchForm.patientName) {
                            url += `&patient_name=${encodeURIComponent(this.surgerySearchForm.patientName)}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryRecords = data.records;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÊâãË°ìË®òÈåÑÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•ÊâãË°ìË®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                addConsumptionItem() {
                    this.addSurgeryForm.consumptions.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        unit: '',
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                filterConsumptionItems(index) {
                    const item = this.addSurgeryForm.consumptions[index];
                    const searchText = item.searchText.toLowerCase();

                    // ÊéíÈô§Ëó•ÂìÅ (medicines) - Ëó•ÂìÅÊáâË©≤ÈÄèÈÅéËó•ÂìÅÈ†òÁî®ÊµÅÁ®ã
                    const nonMedicineItems = this.items.filter(i => i.category !== 'Ëó•ÂìÅ');

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectConsumptionItem(index, selectedItem) {
                    const item = this.addSurgeryForm.consumptions[index];
                    item.itemCode = selectedItem.code;
                    item.itemName = selectedItem.name;
                    item.unit = selectedItem.unit;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                removeConsumptionItem(index) {
                    this.addSurgeryForm.consumptions.splice(index, 1);
                },

                updateConsumptionItemName(index) {
                    const itemCode = this.addSurgeryForm.consumptions[index].itemCode;
                    const item = this.items.find(i => i.code === itemCode);
                    if (item) {
                        this.addSurgeryForm.consumptions[index].itemName = item.name;
                        this.addSurgeryForm.consumptions[index].unit = item.unit;
                    }
                },

                async submitAddSurgery() {
                    if (this.addSurgeryForm.consumptions.length === 0) {
                        this.toast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÈ†ÖËÄóÊùê', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery/record`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addSurgeryForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ÊâãË°ìË®òÈåÑÂª∫Á´ãÊàêÂäü', 'success');
                            this.showAddSurgeryModal = false;
                            this.resetAddSurgeryForm();
                            await this.loadSurgeryRecords();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âª∫Á´ãÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âª∫Á´ãÊâãË°ìË®òÈåÑÂ§±Êïó:', error);
                        this.toast('Âª∫Á´ãÊâãË°ìË®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                resetAddSurgeryForm() {
                    this.addSurgeryForm = {
                        patientName: '',
                        surgeryType: '',
                        surgeonName: '',
                        anesthesiaType: '',
                        durationMinutes: null,
                        remarks: '',
                        consumptions: [],
                        stationId: this.stationId
                    };
                },

                viewSurgeryDetail(record) {
                    this.selectedSurgery = record;
                    this.showSurgeryDetailModal = true;
                },

                async exportSurgeryCSV() {
                    try {
                        let url = `${this.apiUrl}/surgery/export/csv`;
                        const params = [];
                        
                        if (this.surgerySearchForm.startDate) {
                            params.push(`start_date=${this.surgerySearchForm.startDate}`);
                        }
                        if (this.surgerySearchForm.endDate) {
                            params.push(`end_date=${this.surgerySearchForm.endDate}`);
                        }
                        
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }
                        
                        window.open(url, '_blank');
                        this.toast('CSV ÂåØÂá∫ÊàêÂäü', 'success');
                    } catch (error) {
                        console.error('ÂåØÂá∫ CSV Â§±Êïó:', error);
                        this.toast('ÂåØÂá∫ CSV Â§±Êïó', 'error');
                    }
                },

                // Toast ÈÄöÁü•
                toast(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },

                // Á∑äÊÄ•ÂäüËÉΩ (v1.4.5Êñ∞Â¢û)
                emergencyDownloadAll() {
                    window.open(`${this.apiUrl}/emergency/download-all`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('Ê≠£Âú®ÁîüÊàêÂÆåÊï¥ÂÇô‰ªΩÂåÖÔºåË´ãÁ®çÂÄô...', 'info');
                },

                emergencyQuickBackup() {
                    window.open(`${this.apiUrl}/emergency/quick-backup`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('Ê≠£Âú®‰∏ãËºâË≥áÊñôÂ∫´ÂÇô‰ªΩ...', 'info');
                },

                // ========== ÂêåÊ≠•ÁÆ°ÁêÜÂäüËÉΩ (ËÅØÈÇ¶Êû∂Êßã Phase 1-2) ==========

                // Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ
                async generateSyncPackage() {
                    try {
                        const requestBody = {
                            stationId: this.stationId,
                            hospitalId: 'HOSP-001',
                            syncType: this.syncPackageForm.syncType
                        };

                        // Â¶ÇÊûúÊòØÂ¢ûÈáèÂêåÊ≠•‰∏îÊúâÊåáÂÆöÊôÇÈñì
                        if (this.syncPackageForm.syncType === 'DELTA' && this.syncPackageForm.sinceTimestamp) {
                            // ËΩâÊèõÁÇ∫ ISO 8601 Ê†ºÂºè
                            const dt = new Date(this.syncPackageForm.sinceTimestamp);
                            requestBody.sinceTimestamp = dt.toISOString();
                        }

                        const response = await fetch(`${this.apiUrl}/station/sync/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.generatedPackage = data;
                            this.syncStats.pendingChanges = data.changes_count;
                            this.toast(`Â∞ÅÂåÖÂ∑≤Áî¢ÁîüÔºö${data.changes_count} È†ÖËÆäÊõ¥`, 'success');
                        } else {
                            const error = await response.json();
                            this.toast(`Áî¢ÁîüÂ∞ÅÂåÖÂ§±ÊïóÔºö${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó:', error);
                        this.toast('Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó', 'error');
                    }
                },

                // ‰∏ãËºâÂêåÊ≠•Â∞ÅÂåÖÁÇ∫ JSON Ê™îÊ°à
                downloadSyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('Ë´ãÂÖàÁî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ', 'error');
                        return;
                    }

                    const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${this.generatedPackage.package_id}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    this.toast('Â∞ÅÂåÖÂ∑≤‰∏ãËºâ', 'success');
                },

                // Ë§áË£ΩÂêåÊ≠•Â∞ÅÂåÖÂà∞Ââ™Ë≤ºÁ∞ø
                async copySyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('Ë´ãÂÖàÁî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ', 'error');
                        return;
                    }

                    try {
                        const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                        await navigator.clipboard.writeText(dataStr);
                        this.toast('Â∞ÅÂåÖÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
                    } catch (error) {
                        console.error('Ë§áË£ΩÂ§±Êïó:', error);
                        this.toast('Ë§áË£ΩÂ§±Êïó', 'error');
                    }
                },

                // ËôïÁêÜÂêåÊ≠•Ê™îÊ°à‰∏äÂÇ≥
                handleSyncFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            this.uploadedPackage = {
                                packageId: jsonData.package_id,
                                changes: jsonData.changes,
                                checksum: jsonData.checksum
                            };
                            this.importResult = null; // Ê∏ÖÈô§‰πãÂâçÁöÑÂåØÂÖ•ÁµêÊûú
                            this.toast('Â∞ÅÂåÖÂ∑≤ËºâÂÖ•', 'info');
                        } catch (error) {
                            console.error('Ëß£Êûê JSON Â§±Êïó:', error);
                            this.toast('Ê™îÊ°àÊ†ºÂºèÈåØË™§', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                // Ê∏ÖÈô§Â∑≤‰∏äÂÇ≥ÁöÑÂ∞ÅÂåÖ
                clearUploadedPackage() {
                    this.uploadedPackage = null;
                    this.importResult = null;
                    // Ê∏ÖÈô§ file input
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.value = '';
                    this.toast('Â∑≤Ê∏ÖÈô§‰∏äÂÇ≥Â∞ÅÂåÖ', 'info');
                },

                // ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖ
                async importSyncPackage() {
                    if (!this.uploadedPackage) {
                        this.toast('Ë´ãÂÖà‰∏äÂÇ≥ÂêåÊ≠•Â∞ÅÂåÖ', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/station/sync/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.stationId,
                                packageId: this.uploadedPackage.packageId,
                                changes: this.uploadedPackage.changes,
                                checksum: this.uploadedPackage.checksum
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.importResult = data;

                            if (data.success) {
                                this.syncStats.syncedPackages += 1;
                                this.syncStats.lastSync = new Date().toLocaleString('zh-TW');
                                this.toast(`ÂåØÂÖ•ÊàêÂäüÔºö${data.changes_applied} È†ÖËÆäÊõ¥Â∑≤Â•óÁî®`, 'success');

                                // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                                await this.loadStats();
                                await this.loadItems();
                                await this.loadBloodInventory();
                            } else {
                                this.toast(`ÂåØÂÖ•Â§±ÊïóÔºö${data.message}`, 'error');
                            }
                        } else {
                            const error = await response.json();
                            this.importResult = {
                                success: false,
                                message: error.detail || 'ÂåØÂÖ•Â§±Êïó'
                            };
                            this.toast(`ÂåØÂÖ•Â§±ÊïóÔºö${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó:', error);
                        this.importResult = {
                            success: false,
                            message: 'ÂåØÂÖ•Â§±ÊïóÔºöÁ∂≤Ë∑ØÈåØË™§'
                        };
                        this.toast('ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó', 'error');
                    }
                },

                // ========== Ëó•ÂìÅÈ†òÁî® API (MIRS v2.3 - Emergency Dispense) ==========

                // ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆ
                async loadPendingDispenses() {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/pending`);
                        if (response.ok) {
                            const data = await response.json();
                            this.pendingDispenses = data.records || [];
                            console.log('ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆ:', this.pendingDispenses);
                        } else {
                            console.error('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÂ§±Êïó');
                            this.toast('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÈåØË™§:', error);
                        this.toast('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÈåØË™§', 'error');
                    }
                },

                // Ê≠£Â∏∏È†òÁî® (ÈúÄÂØ©Ê†∏)
                async normalDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('Ë´ãÈÅ∏ÊìáËó•ÂìÅ', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('Ë´ãËº∏ÂÖ•È†òËó•‰∫∫', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/normal`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`Ê≠£Â∏∏È†òÁî®Ë´ãÊ±ÇÂ∑≤ÈÄÅÂá∫ÔºåÁ≠âÂæÖËó•Â∏´ÂØ©Ê†∏ (ID: ${data.dispense_id})`, 'success');
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                        } else {
                            this.toast(`È†òÁî®Â§±Êïó: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('Ê≠£Â∏∏È†òÁî®ÈåØË™§:', error);
                        this.toast('Ê≠£Â∏∏È†òÁî®Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }
                },

                // Á∑äÊÄ•È†òÁî® (Break-the-Glass)
                async emergencyDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('Ë´ãÈÅ∏ÊìáËó•ÂìÅ', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('Ë´ãËº∏ÂÖ•È†òËó•‰∫∫', 'error');
                        return;
                    }

                    if (!this.dispenseForm.emergencyReason || this.dispenseForm.emergencyReason.length < 5) {
                        this.toast('Á∑äÊÄ•ÂéüÂõ†ÂøÖÈ†àËá≥Â∞ë5ÂÄãÂ≠ó', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/emergency`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                emergencyReason: this.dispenseForm.emergencyReason,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`Á∑äÊÄ•È†òÁî®ÊàêÂäüÔºÅÂ∑≤Á´ãÂç≥Êâ£Èô§Â∫´Â≠ò (ID: ${data.dispense_id})`, 'success');
                            this.showEmergencyReasonModal = false;
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`Á∑äÊÄ•È†òÁî®Â§±Êïó: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('Á∑äÊÄ•È†òÁî®ÈåØË™§:', error);
                        this.toast('Á∑äÊÄ•È†òÁî®Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }
                },

                // ÈñãÂïüËó•Â∏´ÂØ©Ê†∏ Modal
                openPharmacistApproval(dispense) {
                    this.selectedDispenseForApproval = dispense;
                    this.pharmacistApprovalForm.dispenseId = dispense.id;
                    this.showPharmacistApprovalModal = true;
                },

                // Ëó•Â∏´ÂØ©Ê†∏Á¢∫Ë™ç
                async submitPharmacistApproval() {
                    if (!this.pharmacistApprovalForm.approvedBy) {
                        this.toast('Ë´ãËº∏ÂÖ•Ëó•Â∏´ÂßìÂêç', 'error');
                        return;
                    }

                    if (!this.pharmacistApprovalForm.pinCode) {
                        this.toast('Ë´ãËº∏ÂÖ• PIN Á¢º', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/approve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dispenseId: this.pharmacistApprovalForm.dispenseId,
                                approvedBy: this.pharmacistApprovalForm.approvedBy,
                                pharmacistNotes: this.pharmacistApprovalForm.pharmacistNotes || null,
                                pinCode: this.pharmacistApprovalForm.pinCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const wasEmergency = this.selectedDispenseForApproval?.status === 'EMERGENCY';
                            this.toast(wasEmergency ? 'Á∑äÊÄ•È†òÁî®Â∑≤Á¢∫Ë™ç' : 'È†òÁî®ÂØ©Ê†∏ÈÄöÈÅéÔºåÂ∑≤Êâ£Èô§Â∫´Â≠ò', 'success');
                            this.showPharmacistApprovalModal = false;
                            this.resetPharmacistApprovalForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            if (response.status === 401) {
                                this.toast('PIN Á¢ºÈåØË™§ÔºåÊãíÁµïÂØ©Ê†∏', 'error');
                            } else {
                                this.toast(`ÂØ©Ê†∏Â§±Êïó: ${data.detail}`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Ëó•Â∏´ÂØ©Ê†∏ÈåØË™§:', error);
                        this.toast('Ëó•Â∏´ÂØ©Ê†∏Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }
                },

                // ÈáçÁΩÆÈ†òÁî®Ë°®ÂñÆ
                resetDispenseForm() {
                    this.dispenseForm = {
                        medicineCode: '',
                        quantity: 1,
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        stationCode: 'TC-01',
                        emergencyReason: ''
                    };
                },

                // ÈáçÁΩÆËó•Â∏´ÂØ©Ê†∏Ë°®ÂñÆ
                resetPharmacistApprovalForm() {
                    this.pharmacistApprovalForm = {
                        dispenseId: null,
                        approvedBy: '',
                        pharmacistNotes: '',
                        pinCode: ''
                    };
                    this.selectedDispenseForApproval = null;
                },

                // === ÊâπÊ¨°È†òÁî®ÂäüËÉΩ (Batch Dispense) ===
                addBatchDispenseItem() {
                    this.batchDispenseForm.items.push({
                        medicineCode: '',
                        medicineName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchDispenseItem(index) {
                    this.batchDispenseForm.items.splice(index, 1);
                },

                filterBatchDispenseItems(index) {
                    const item = this.batchDispenseForm.items[index];
                    const searchText = item.searchText.toLowerCase();

                    // Âè™È°ØÁ§∫Ëó•ÂìÅ (medicines) - ‰∏ÄËà¨Áâ©ÂìÅÊáâË©≤ÈÄèÈÅéËôïÁΩÆÊ∂àËÄóÊµÅÁ®ã
                    const medicineItems = this.items.filter(i => i.category === 'Ëó•ÂìÅ');

                    if (!searchText) {
                        item.filteredItems = medicineItems;
                    } else {
                        item.filteredItems = medicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectBatchDispenseItem(index, selectedItem) {
                    const item = this.batchDispenseForm.items[index];
                    item.medicineCode = selectedItem.code;
                    item.medicineName = selectedItem.name;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                async submitBatchDispense() {
                    try {
                        if (this.batchDispenseForm.items.length === 0) {
                            this.toast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÁ≠ÜËó•ÂìÅ', 'error');
                            return;
                        }

                        if (!this.batchDispenseForm.dispensedBy) {
                            this.toast('Ë´ãËº∏ÂÖ•È†òËó•‰∫∫', 'error');
                            return;
                        }

                        // Â¶ÇÊûúÊòØÁ∑äÊÄ•È†òÁî®ÔºåÈúÄË¶ÅÊ™¢Êü•Á∑äÊÄ•ÂéüÂõ†
                        if (this.batchDispenseForm.isEmergency) {
                            if (!this.batchDispenseForm.emergencyReason || this.batchDispenseForm.emergencyReason.length < 5) {
                                this.toast('Á∑äÊÄ•ÂéüÂõ†ÂøÖÈ†àËá≥Â∞ë5ÂÄãÂ≠ó', 'error');
                                return;
                            }
                        }

                        // ÊâπÊ¨°Êèê‰∫§ÊØèÂÄãËó•ÂìÅÈ†òÁî®
                        let successCount = 0;
                        let failCount = 0;
                        const endpoint = this.batchDispenseForm.isEmergency ? 'emergency' : 'normal';

                        for (const item of this.batchDispenseForm.items) {
                            try {
                                const requestBody = {
                                    medicineCode: item.medicineCode,
                                    quantity: item.quantity,
                                    dispensedBy: this.batchDispenseForm.dispensedBy,
                                    patientRefId: this.batchDispenseForm.patientRefId || null,
                                    patientName: this.batchDispenseForm.patientName || null,
                                    stationCode: this.batchDispenseForm.stationCode
                                };

                                // Á∑äÊÄ•È†òÁî®ÈúÄË¶ÅÂä†‰∏äÁ∑äÊÄ•ÂéüÂõ†
                                if (this.batchDispenseForm.isEmergency) {
                                    requestBody.emergencyReason = this.batchDispenseForm.emergencyReason;
                                }

                                const response = await fetch(`${this.apiUrl}/pharmacy/dispense/${endpoint}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                    const data = await response.json();
                                    console.error(`${item.medicineName} È†òÁî®Â§±Êïó:`, data.detail);
                                }
                            } catch (error) {
                                failCount++;
                                console.error(`${item.medicineName} È†òÁî®Â§±Êïó:`, error);
                            }
                        }

                        // È°ØÁ§∫ÁµêÊûú
                        if (failCount === 0) {
                            const message = this.batchDispenseForm.isEmergency
                                ? `ÊàêÂäüÁ∑äÊÄ•È†òÁî® ${successCount} È†ÖËó•ÂìÅÔºåÂ∑≤Á´ãÂç≥Êâ£Èô§Â∫´Â≠ò`
                                : `ÊàêÂäüÈÄÅÂá∫ ${successCount} È†ÖÈ†òÁî®Ë´ãÊ±ÇÔºåÁ≠âÂæÖËó•Â∏´ÂØ©Ê†∏`;
                            this.toast(message, 'success');
                            this.resetBatchDispenseForm();
                            this.showEmergencyReasonModal = false;
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`ÊàêÂäü ${successCount} È†ÖÔºåÂ§±Êïó ${failCount} È†Ö`, 'warning');
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('ÊâπÊ¨°È†òÁî®Â§±Êïó:', error);
                        this.toast('ÊâπÊ¨°È†òÁî®Â§±Êïó', 'error');
                    }
                },

                resetBatchDispenseForm() {
                    this.batchDispenseForm = {
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        items: [],
                        stationCode: this.stationId,
                        isEmergency: false,
                        emergencyReason: ''
                    };
                },

                // Ê†ºÂºèÂåñ‰ΩçÂÖÉÁµÑÂ§ßÂ∞è
                formatBytes(bytes) {
                    if (!bytes) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
            };
        }
    </script>
</body>
</html>
