<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIRS 站點設定精靈 - Setup Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }

        /* Teal/Blue Theme */
        .btn-primary {
            @apply bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-all duration-200 transform hover:scale-105;
        }

        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-all duration-200;
        }

        .station-card {
            @apply bg-white border-2 border-gray-200 rounded-xl p-6 cursor-pointer transition-all duration-300 hover:border-teal-500 hover:shadow-xl;
        }

        .station-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
        }

        .station-card.selected {
            @apply border-teal-600 bg-gradient-to-br from-teal-50 to-blue-50 shadow-xl;
            transform: scale(1.02);
            box-shadow: 0 15px 30px -10px rgba(20, 184, 166, 0.4);
        }

        .station-card .icon-container {
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .station-card:hover .icon-container {
            transform: scale(1.1);
        }

        .step-indicator {
            @apply w-10 h-10 rounded-full flex items-center justify-center font-semibold transition-all duration-300;
        }

        .step-indicator.active {
            @apply bg-gradient-to-r from-teal-500 to-blue-600 text-white;
        }

        .step-indicator.completed {
            @apply bg-teal-500 text-white;
        }

        .step-indicator.inactive {
            @apply bg-gray-200 text-gray-500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

    <div x-data="setupWizard()" x-cloak class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <div class="inline-block">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-teal-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 0015 0m-15 0a7.5 7.5 0 1115 0m-15 0H3m16.5 0H21m-1.5 0H12m-8.457 3.077l1.41-.513m14.095-5.13l1.41-.513M5.106 17.785l1.15-.964m11.49-9.642l1.149-.964M7.501 19.795l.75-1.3m7.5-12.99l.75-1.3m-6.063 16.658l.26-1.477m2.605-14.772l.26-1.477m0 17.726l-.26-1.477M10.698 4.614l-.26-1.477M16.5 19.794l-.75-1.299M7.5 4.205L12 12m6.894 5.785l-1.149-.964M6.256 7.178l-1.15-.964m15.352 8.864l-1.41-.513M4.954 9.435l-1.41-.514M12.002 12l-3.75 6.495" />
                    </svg>
                </div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-teal-600 to-blue-700 bg-clip-text text-transparent">
                    MIRS 站點設定精靈
                </h1>
                <p class="text-gray-600 mt-2">Medical Inventory Resource System - Setup Wizard</p>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="mb-12">
            <div class="flex items-center justify-between max-w-2xl mx-auto">
                <template x-for="(stepName, index) in ['選擇類型', '初始化', '站點資訊', '完成']" :key="index">
                    <div class="flex items-center">
                        <div class="flex flex-col items-center">
                            <div
                                class="step-indicator"
                                :class="{
                                    'active': currentStep === index + 1,
                                    'completed': currentStep > index + 1,
                                    'inactive': currentStep < index + 1
                                }"
                            >
                                <template x-if="currentStep > index + 1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                    </svg>
                                </template>
                                <template x-if="currentStep <= index + 1">
                                    <span x-text="index + 1"></span>
                                </template>
                            </div>
                            <span class="text-sm mt-2 font-medium" :class="currentStep >= index + 1 ? 'text-teal-600' : 'text-gray-500'" x-text="stepName"></span>
                        </div>
                        <div x-show="index < 3" class="w-16 h-1 mx-2 rounded" :class="currentStep > index + 1 ? 'bg-teal-500' : 'bg-gray-300'"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 fade-in">

            <!-- Step 1: Station Type Selection -->
            <div x-show="currentStep === 1" class="space-y-6">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">選擇站點類型</h2>
                    <p class="text-gray-600">請選擇您的醫療站點類型，系統將自動載入對應的資料模板</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- Health Center -->
                    <div
                        class="station-card"
                        :class="{ 'selected': selectedType === 'health_center' }"
                        @click="selectedType = 'health_center'"
                    >
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="icon-container w-14 h-14 bg-green-100 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-green-600">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">衛生所</h3>
                                <p class="text-sm text-gray-600 mb-3">Health Center</p>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>✓ 政府標準藥品清單 (15項)</li>
                                    <li>✓ 基本醫療設備 (4項)</li>
                                    <li>✓ 7日庫存警戒值</li>
                                    <li>✓ 符合衛福部標準</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Hospital Custom -->
                    <div
                        class="station-card"
                        :class="{ 'selected': selectedType === 'hospital_custom' }"
                        @click="selectedType = 'hospital_custom'"
                    >
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-14 h-14 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-blue-600">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">醫院自訂</h3>
                                <p class="text-sm text-gray-600 mb-3">Hospital Custom</p>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>✓ 空白資料庫架構</li>
                                    <li>✓ 匯入醫院現有清單</li>
                                    <li>✓ 自訂品項代碼</li>
                                    <li>✓ 彈性配置選項</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- BORP Surgical Station -->
                    <div
                        class="station-card"
                        :class="{ 'selected': selectedType === 'surgical_station' }"
                        @click="selectedType = 'surgical_station'"
                    >
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="icon-container w-14 h-14 bg-red-100 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-red-600">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23-.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">BORP 備援手術站</h3>
                                <p class="text-sm text-gray-600 mb-3">Backup Operating Room</p>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>✓ 16組手術器械包</li>
                                    <li>✓ 一般藥品 (15項)</li>
                                    <li>✓ 手術耗材</li>
                                    <li>✓ 緊急手術支援</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Logistics Hub -->
                    <div
                        class="station-card"
                        :class="{ 'selected': selectedType === 'logistics_hub' }"
                        @click="selectedType = 'logistics_hub'"
                    >
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="icon-container w-14 h-14 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-purple-600">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-1">物資中繼站</h3>
                                <p class="text-sm text-gray-600 mb-3">Logistics Hub</p>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>✓ 大量儲存 (5倍存量)</li>
                                    <li>✓ 藥品倉儲</li>
                                    <li>✓ 不執行醫療處置</li>
                                    <li>✓ 跨站點調配</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="flex justify-end mt-8">
                    <button
                        @click="nextStep()"
                        :disabled="!selectedType"
                        class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300"
                        :class="{ 'animate-pulse': selectedType }"
                    >
                        <span x-show="!selectedType">請先選擇站點類型</span>
                        <span x-show="selectedType" class="flex items-center">
                            下一步
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 ml-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                            </svg>
                        </span>
                    </button>
                </div>
            </div>

            <!-- Step 2: Database Initialization -->
            <div x-show="currentStep === 2" class="space-y-6">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">資料庫初始化</h2>
                    <p class="text-gray-600">正在建立您的站點資料庫...</p>
                </div>

                <div class="max-w-md mx-auto">
                    <!-- Loading State -->
                    <div x-show="initStatus === 'initializing'" class="text-center py-8">
                        <div class="w-20 h-20 mx-auto mb-6">
                            <svg class="spinner w-full h-full text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-medium text-gray-700 mb-2">正在建立資料庫...</p>
                        <p class="text-sm text-gray-500" x-text="initMessage"></p>
                    </div>

                    <!-- Success State -->
                    <div x-show="initStatus === 'success'" class="text-center py-8">
                        <div class="w-20 h-20 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-12 h-12 text-green-600">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <p class="text-lg font-medium text-gray-700 mb-2">資料庫建立成功！</p>
                        <p class="text-sm text-gray-500 mb-6" x-text="initMessage"></p>
                        <div class="flex gap-4 justify-center">
                            <button @click="prevStep()" class="btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                                </svg>
                                上一步
                            </button>
                            <button @click="nextStep()" class="btn-primary">
                                繼續設定
                            </button>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div x-show="initStatus === 'error'" class="text-center py-8">
                        <div class="w-20 h-20 mx-auto mb-6 bg-red-100 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-12 h-12 text-red-600">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                            </svg>
                        </div>
                        <p class="text-lg font-medium text-gray-700 mb-2">初始化失敗</p>
                        <p class="text-sm text-gray-500 mb-6" x-text="initMessage"></p>
                        <div class="flex gap-4 justify-center">
                            <button @click="retryInit()" class="btn-primary">重試</button>
                            <button @click="prevStep()" class="btn-secondary">返回</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Station Information -->
            <div x-show="currentStep === 3" class="space-y-6">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">設定站點資訊</h2>
                    <p class="text-gray-600">請輸入您的站點識別碼與名稱</p>
                </div>

                <div class="max-w-md mx-auto space-y-6">

                    <!-- Quick Presets -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">快速選擇</label>
                        <div class="grid grid-cols-2 gap-3">
                            <template x-for="preset in presets" :key="preset.id">
                                <button
                                    @click="applyPreset(preset)"
                                    class="px-4 py-3 border-2 border-gray-200 rounded-lg hover:border-teal-500 hover:bg-teal-50 transition-all text-left"
                                >
                                    <div class="font-medium text-gray-800" x-text="preset.id"></div>
                                    <div class="text-sm text-gray-600" x-text="preset.name"></div>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div class="border-t pt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">站點代碼 *</label>
                        <input
                            type="text"
                            x-model="stationId"
                            placeholder="例如: TC-01"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:outline-none transition-colors"
                            maxlength="10"
                        >
                        <p class="text-sm text-gray-500 mt-1">建議格式: 地區代碼-編號 (如: TC-01)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">站點名稱 *</label>
                        <input
                            type="text"
                            x-model="stationName"
                            placeholder="例如: 急診檢傷站"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-teal-500 focus:outline-none transition-colors"
                            maxlength="50"
                        >
                    </div>

                    <div class="bg-teal-50 border border-teal-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-teal-600 mr-3 mt-0.5 flex-shrink-0">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                            </svg>
                            <div class="text-sm text-teal-800">
                                <p class="font-medium mb-1">提示</p>
                                <p>站點代碼和名稱將用於識別您的站點，設定後仍可在系統設定中修改。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button @click="currentStep = 1" class="btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                        </svg>
                        上一步
                    </button>
                    <button
                        @click="saveStation()"
                        :disabled="!stationId || !stationName"
                        class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        完成設定
                    </button>
                </div>
            </div>

            <!-- Step 4: Completion -->
            <div x-show="currentStep === 4" class="text-center py-8">
                <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-r from-teal-500 to-blue-600 rounded-full flex items-center justify-center animate-bounce">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-14 h-14 text-white">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-3">設定完成！</h2>
                <p class="text-gray-600 mb-2">您的站點已成功建立</p>
                <div class="bg-gray-50 rounded-lg p-4 max-w-md mx-auto mb-8">
                    <div class="text-left space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">站點類型:</span>
                            <span class="font-medium" x-text="getTypeName(selectedType)"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">站點代碼:</span>
                            <span class="font-medium" x-text="stationId"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">站點名稱:</span>
                            <span class="font-medium" x-text="stationName"></span>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-6">將在 <span x-text="countdown"></span> 秒後自動進入系統...</p>
                <button @click="goToIndex()" class="btn-primary">
                    立即進入系統
                </button>
            </div>

        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-sm text-gray-500">
            <p>MIRS v1.5 - Medical Inventory Resource System</p>
            <p class="mt-1">© 2025 All Rights Reserved</p>
        </div>

    </div>

    <script>
        function setupWizard() {
            return {
                currentStep: 1,
                selectedType: '',
                stationId: '',
                stationName: '',
                initStatus: '', // 'initializing', 'success', 'error'
                initMessage: '',
                countdown: 5,

                // Station type metadata
                stationTypeConfig: {
                    'health_center': { prefix: 'HC', name: '衛生所' },
                    'surgical_station': { prefix: 'SURG', name: '手術站' },
                    'logistics_hub': { prefix: 'LOGI', name: '後勤站' },
                    'hospital_custom': { prefix: 'HOSP', name: '醫療機構' }
                },

                // Dynamically generated presets based on selected type
                get presets() {
                    if (!this.selectedType) return [];

                    const config = this.stationTypeConfig[this.selectedType];
                    if (!config) return [];

                    return [
                        { id: `${config.prefix}-01`, name: `${config.name}1號` },
                        { id: `${config.prefix}-02`, name: `${config.name}2號` },
                        { id: `${config.prefix}-03`, name: `${config.name}3號` },
                        { id: `${config.prefix}-04`, name: `${config.name}4號` },
                    ];
                },

                nextStep() {
                    if (this.currentStep === 1 && this.selectedType) {
                        this.currentStep = 2;
                        this.initializeDatabase();
                    } else if (this.currentStep === 2 && this.initStatus === 'success') {
                        this.currentStep = 3;
                    }
                },

                prevStep() {
                    if (this.currentStep > 1) {
                        this.currentStep--;
                    }
                },

                async initializeDatabase() {
                    this.initStatus = 'initializing';
                    this.initMessage = '正在建立資料表...';

                    try {
                        const response = await fetch('/api/setup/initialize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                profile: this.selectedType
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            this.initStatus = 'success';
                            this.initMessage = result.message || '資料庫已成功建立';
                        } else {
                            this.initStatus = 'error';
                            this.initMessage = result.message || '初始化失敗，請重試';
                        }
                    } catch (error) {
                        this.initStatus = 'error';
                        this.initMessage = '網路錯誤: ' + error.message;
                    }
                },

                retryInit() {
                    this.initializeDatabase();
                },

                applyPreset(preset) {
                    this.stationId = preset.id;
                    this.stationName = preset.name;
                },

                async saveStation() {
                    if (!this.stationId || !this.stationName) {
                        alert('請填寫站點代碼和名稱');
                        return;
                    }

                    // Save to localStorage
                    localStorage.setItem('stationId', this.stationId);
                    localStorage.setItem('stationName', this.stationName);
                    localStorage.setItem('stationType', this.selectedType);

                    // Save to database
                    try {
                        await fetch('/api/setup/station', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                station_code: this.stationId,
                                station_name: this.stationName,
                                station_type: this.selectedType
                            })
                        });
                    } catch (error) {
                        console.error('Failed to save station info:', error);
                    }

                    this.currentStep = 4;
                    this.startCountdown();
                },

                startCountdown() {
                    const interval = setInterval(() => {
                        this.countdown--;
                        if (this.countdown <= 0) {
                            clearInterval(interval);
                            this.goToIndex();
                        }
                    }, 1000);
                },

                goToIndex() {
                    window.location.href = 'Index.html';
                },

                getTypeName(type) {
                    const names = {
                        'health_center': '衛生所',
                        'hospital_custom': '醫院自訂',
                        'surgical_station': 'BORP 備援手術站',
                        'logistics_hub': '物資中繼站'
                    };
                    return names[type] || type;
                }
            }
        }
    </script>

</body>
</html>
